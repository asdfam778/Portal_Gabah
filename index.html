<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1024" />
    <title>Portal Gabah AsdFam</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas for saving as JPG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <style>
      /* --- PALET WARNA BARU: TEMA HIJAU PADI --- */
      :root {
        --bg-main: #f7f9f7;
        --bg-card: #ffffff;
        --text-primary: #3e4a3d;
        --text-secondary: #5a6d5c;
        --brand-primary: #4c7f4c;
        --brand-primary-hover: #3b663b;
        --brand-accent: #e8a849;
        --brand-accent-hover: #d49237;
        --border-color: #d8e0d7;
        --border-color-light: #e5e7eb;
      }
      /* --- FIX TOTAL: MATIKAN PULL-TO-REFRESH --- */
      html, body {
        /* KUNCI UTAMA: Mencegah efek mental/bouncing dan refresh */
        overscroll-behavior-y: contain !important;
        overscroll-behavior: none !important; 
        
        /* Mencegah browser menganggap tarikan ke bawah sebagai navigasi */
        touch-action: pan-y !important;
    
        /* Pastikan tinggi penuh agar scroll terdeteksi di dalam, bukan di browser */
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
    
        /* Gunakan font yang sudah Anda atur sebelumnya */
        font-family: 'Poppins', sans-serif;
        background-color: var(--bg-main);
        color: var(--text-primary);
        }

      /* Pastikan pembungkus aplikasi juga patuh */
      #app-wrapper {
        min-height: 100%;
        height: auto;
        overflow-y: auto; /* Scroll terjadi di sini, bukan di body browser */
        -webkit-overflow-scrolling: touch; /* Agar scroll licin di iPhone */
        }

      /* ===== STYLE UNTUK DISPLAY BARU ===== */

      /* Untuk display grand total di bagian atas form */
      .grand-total-display {
        background-color: var(--brand-primary);
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        text-align: center;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(76, 127, 76, 0.3);
      }
      .grand-total-display .total-label {
        font-size: 1rem;
        font-weight: 500;
        opacity: 0.9;
        display: block;
        margin-bottom: 0.25rem;
      }
      .grand-total-display .total-value {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: 0.05em;
      }

      /* Untuk display total per-owner di samping nama */
      .owner-summary-display {
        font-size: 1rem; /* Ukuran font 16px */
        font-weight: 600;
        color: var(--brand-primary);
        margin: 0 1rem; /* Jarak di kiri dan kanan */
        white-space: nowrap; /* Mencegah teks turun baris */
      }

      /* Untuk display ringkasan di samping tombol "Tambah" */
      .summary-display-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
      }
      .summary-display {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-align: right;
      }
      .summary-display .value {
        color: var(--text-primary);
      }
      .summary-display .unit {
        font-size: 0.8rem;
        margin-left: 0.25rem;
        opacity: 0.8;
      }

      .main-app-section {
        display: none;
      }
      .main-app-section.active {
        display: block;
      }

      .form-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
      }

      .form-header-container {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        margin-bottom: 1.5rem;
      }

      .form-title {
        font-size: 1.5rem;
        font-weight: 700;
        text-align: center;
      }

      .reset-form-button {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border: 1px solid #fca5a5;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.375rem;
        color: #b91c1c;
        background-color: #fee2e2;
        transition: background-color 0.2s;
      }
      .reset-form-button:hover {
        background-color: #fecaca;
      }
      .reset-form-button .fa-eraser {
        margin-right: 0.5rem;
      }

      /* Navigasi Kartu Utama */
      .main-nav-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        flex: 1;
        max-width: 220px;
      }
      .main-nav-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        border-color: var(--brand-primary);
      }
      .main-nav-card.active {
        border-color: var(--brand-primary);
        background-color: var(--brand-primary);
        color: #ffffff;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      }
      .main-nav-card.active .nav-icon,
      .main-nav-card.active .nav-title {
        color: #ffffff;
      }
      .main-nav-card .nav-icon {
        font-size: 2rem;
        color: var(--brand-primary);
        margin-bottom: 0.5rem;
        transition: color 0.3s ease;
      }
      .main-nav-card .nav-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        transition: color 0.3s ease;
      }

      /* Gaya Menu Utilitas */
      #utilitas-submenu {
        z-index: 10;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        margin-top: 0.5rem;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--border-color);
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .utilitas-submenu-button {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
        border-radius: 0.375rem;
        text-align: left;
        transition: background-color 0.2s;
      }
      .utilitas-submenu-button:hover {
        background-color: #f1f5f9;
      }
      .utilitas-submenu-button .fas {
        margin-right: 0.75rem;
        width: 1.25rem;
        text-align: center;
        color: var(--text-secondary);
      }

      /* Tombol */
      .btn {
        padding: 0.6rem 1.25rem;
        border-radius: 0.375rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        border: none;
      }
      .btn-primary {
        background-color: var(--brand-primary);
        color: white;
      }
      .btn-primary:hover {
        background-color: var(--brand-primary-hover);
      }
      .btn-secondary {
        background-color: var(--brand-accent);
        color: white;
      }
      .btn-secondary:hover {
        background-color: var(--brand-accent-hover);
      }
      .btn-danger {
        background-color: #ef4444;
        color: white !important;
      }
      .btn-danger:hover {
        background-color: #dc2626;
      }
      .btn-danger .fas {
        /* PERUBAHAN: Gaya ikon pada tombol danger */
        color: white;
      }
      .btn:disabled {
        /* PERUBAHAN: Gaya tombol saat loading */
        cursor: not-allowed;
        opacity: 0.7;
      }
      .btn-add-normal {
        background-color: #4caf50;
        color: white;
      }
      .btn-add-normal:hover {
        background-color: #45a049;
      }
      .btn-add-abnormal {
        background-color: #f4b400;
        color: white;
      }
      .btn-add-abnormal:hover {
        background-color: #e2a600;
      }

      /* Input Form */
      .form-input,
      .input-label,
      .form-textarea {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        background-color: #fff;
        font-size: 16px;
      }
      .form-textarea {
        min-height: 80px;
      }
      .input-label {
        border: none;
        box-shadow: none;
        padding: 0;
        margin-bottom: 0.3rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
      }
      .form-input:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 2px rgba(76, 127, 76, 0.25);
      }

      .form-input-group {
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
        background-color: #f8fafc;
      }

      /* Gaya Catatan Dinamis */
      .catatan-input-wrapper {
        position: relative;
      }
      .catatan-input-wrapper .remove-catatan-btn {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: #ef4444;
        background-color: #fee2e2;
        border: 1px solid #fca5a5;
        border-radius: 0.375rem;
        line-height: 1;
        cursor: pointer;
        transition: all 0.2s;
      }
      .catatan-input-wrapper .remove-catatan-btn:hover {
        background-color: #fecaca;
        color: #b91c1c;
      }
      .hidden {
        display: none !important;
      }

      /* Gaya Struk Catatan Timbangan */
      #catatan .owner-section {
        border: 1px solid var(--border-color);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        background-color: var(--bg-card);
      }
      #catatan .owner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      #catatan .karung-input-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      #catatan .karung-input-item .karung-counter-label {
        min-width: 40px;
        text-align: right;
        margin-right: 0.25rem;
        color: #64748b;
      }
      #catatan .karung-input-item input {
        margin-right: 0.5rem;
      }
      #catatan .scrollable-input-container {
        max-height: 730px;
        overflow-y: auto;
        padding: 5px;
      }
      #catatan .owner-sacks-container {
        max-height: 430px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #f3f4f6;
        border-radius: 0.25rem;
        margin-top: 0.75rem;
      }
      #catatan .gabah-category-section-timbangan {
        background-color: #fdfdfd;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #f0f0f0;
      }
      #catatan .gabah-category-title-timbangan {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
      }

      /* Gaya Struk (Umum) */
      .thermal-receipt-container {
        font-family: "Consolas", "Courier New", monospace;
        color: #000;
        background-color: #fff;
        margin: 20px auto;
        border: 1px solid #ccc;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      }
      .receipt-content,
      .nota-content {
        margin: 0 auto;
        padding: 10px;
        box-sizing: border-box;
      }
      .receipt-header,
      .nota-header {
        text-align: center;
      }
      .receipt-divider,
      .nota-divider {
        border-top: 1px dashed #333;
        margin: 8px 0;
      }
      .row-divider {
        width: 100%;
        border-top: 1px dashed #aeaeae;
        margin: 4px 0 8px 0;
      }
      .struk-catatan-section {
        font-size: 12px;
        text-align: left;
        margin-top: 8px;
      }
      .struk-catatan-section .catatan-title {
        font-weight: bold;
        margin-bottom: 2px;
      }
      .struk-catatan-section .catatan-content {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      #strukNoPlatCatatan {
        font-size: 16px !important;
      }

      /* Gaya Struk Catatan Timbangan (Diperbarui) */
      #thermalReceiptContainer {
        width: 310px;
      }
      #thermalReceiptContainer .receipt-header h2 {
        font-size: 17px;
        font-weight: bold;
        margin: 0 0 6px 0;
      }
      #thermalReceiptContainer .receipt-info p,
      #thermalReceiptContainer .receipt-summary p {
        font-size: 12px;
        margin: 3px 0;
        line-height: 1.45;
      }
      .receipt-label {
        display: inline-block;
        white-space: nowrap;
      }
      .receipt-label strong {
        font-weight: bold;
      }
      .receipt-colon {
        margin-right: 5px;
      }
      .receipt-value.bold {
        font-weight: bold;
      }
      .receipt-owner-header-line .owner-name-part {
        font-size: 15px !important;
        font-weight: bold;
        text-transform: uppercase;
      }
      .receipt-owner-header-line .owner-inline-summary-part {
        font-size: 12px !important;
        font-weight: normal !important;
        margin-left: 5px;
      }
      .receipt-summary .receipt-label strong {
        font-size: 12px !important;
      }
      .receipt-summary .receipt-value {
        font-size: 13px;
        font-weight: bold;
      }
      .receipt-summary p[style*="font-size: 18px"] .receipt-value {
        font-size: 18px;
      }
      .receipt-owner-divider-strong {
        border-top: 1px dashed #000;
        margin: 8px 0;
      }
      .receipt-item-columns-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        margin-top: 5px;
      }
      .receipt-column {
        display: flex;
        flex-direction: column;
        width: calc(100% / 6 - 13px);
        margin-bottom: 8px;
        padding-right: 2px;
      }
      .receipt-column-spacer {
        width: calc(100% / 6 - 4px);
        height: 0;
      }
      .receipt-item-value {
        font-size: 14px;
        font-weight: bold;
        text-align: right;
        margin-bottom: 1px;
        line-height: 1.3;
        min-height: 1em;
        padding-right: 4px;
      }
      .receipt-item-value.overweight {
        color: red;
        font-weight: bold;
      }
      .receipt-item-placeholder {
        color: #777;
      }
      .receipt-column-separator {
        font-size: 14px;
        font-weight: bold;
        text-align: right;
        margin: 4px 0 3px 0;
        letter-spacing: 0px;
        line-height: 1;
        padding-right: 4px;
      }
      .receipt-column-sum {
        font-size: 16px;
        font-weight: bold;
        text-align: right;
        margin-top: 1px;
        line-height: 1.3;
        padding-right: 4px;
      }
      .receipt-footer {
        text-align: center;
      }
      .receipt-footer p {
        font-size: 10px;
        margin: 2px 0;
      }
      .receipt-category-title {
        font-size: 13px;
        font-weight: bold;
        text-align: left;
        margin: 6px 0 2px 0;
        padding-bottom: 2px;
        border-bottom: 1px dotted #555;
      }
      .receipt-category-title .category-summary {
        font-weight: normal;
        margin-left: 8px;
      }
      .receipt-category-spacer {
        height: 0.5em;
      }

      /* ===== PERBAIKAN FINAL: Tata Letak Grid Struk Timbangan ===== */
      .receipt-info,
      .receipt-summary {
        display: grid;
        grid-template-columns: auto min-content 1fr; /* Kolom: Label, Titik Dua, Nilai */
        gap: 3px 8px; /* Jarak antar baris dan kolom */
        align-items: baseline; /* Sejajarkan teks berdasarkan garis dasar tulisan */
        font-size: 12px; /* Menetapkan ukuran font dasar untuk kedua bagian */
      }

      /* Memaksa setiap elemen di dalam grid untuk menempati kolomnya */
      .receipt-info > *,
      .receipt-summary > span,
      .receipt-summary > strong {
        display: block;
      }

      .receipt-label {
        grid-column: 1;
      }
      .receipt-colon {
        grid-column: 2;
      }
      .receipt-value {
        grid-column: 3;
        text-align: left;
      } /* Nilai dibuat rata kiri */

      /* Aturan untuk nilai yang tebal (No. Plat) */
      .receipt-info strong.receipt-value {
        font-weight: bold;
      }

      /* Aturan khusus agar garis pemisah dan Total Muatan tetap membentang penuh */
      .receipt-summary .receipt-divider,
      .receipt-summary > p {
        grid-column: 1 / -1; /* Membentang dari kolom 1 sampai terakhir */
      }

      /* Mengembalikan ukuran font khusus untuk Total Muatan */
      .receipt-summary > p,
      .receipt-summary > p .receipt-value {
        font-size: 16px !important;
      }

      /* Gaya Sesi Timbang Cepat */
      #quickWeighSession {
        border: 2px dashed var(--brand-primary);
        padding: 1.5rem;
        border-radius: 0.75rem;
        margin-top: 1rem;
      }
      #quickWeighSession .quick-weigh-owner-btn,
      #quickWeighSession .quick-weigh-category-btn {
        padding: 0.75rem 1rem;
        font-size: 1rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
      }
      #quickWeighSession .quick-weigh-owner-btn {
        background-color: #e9ecef;
        color: #495057;
        border: 1px solid #ced4da;
      }
      #quickWeighSession .quick-weigh-owner-btn.active {
        background-color: var(--brand-primary);
        color: white;
        border-color: var(--brand-primary);
      }
      #quickWeighSession .quick-weigh-category-btn.active {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      #quickWeighHistory {
        max-height: 200px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
      }
      .quick-weigh-history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-bottom: 1px solid var(--border-color-light);
      }
      .delete-history-btn {
        cursor: pointer;
        color: #dc3545;
        font-weight: bold;
        padding: 0.25rem 0.5rem;
      }

      /* Gaya Nota Pembayaran */
      #nota .gabah-category-section {
        border: 1px solid var(--border-color);
        padding: 1.25rem;
        border-radius: 0.5rem;
        margin-top: 1.5rem;
        background-color: #fdfdff;
      }
      #nota .gabah-category-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-primary);
      }
      #nota .sack-input-container {
        max-height: 440px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        padding: 1rem;
        border-radius: 0.375rem;
        background-color: #fcfdfc;
      }
      #nota .sack-input-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      #nota .sack-input-item label {
        min-width: 45px;
        text-align: right;
        margin-right: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }
      #nota .sack-input-item input {
        margin-right: 0.5rem;
      }

      /* Gaya Struk Nota Pembayaran */
      #notaPembayaranContainer {
        width: 310px;
      }
      #notaPembayaranContainer .nota-header h2 {
        font-size: 16px;
        font-weight: bold;
        margin: 0;
        line-height: 1.1;
      }
      #notaPembayaranContainer .nota-contact-info {
        text-align: center;
        font-size: 10px;
        margin-bottom: 5px;
      }
      #notaPembayaranContainer .nota-title-divider {
        border-top: 1px dashed #000;
        margin-top: 3px;
        margin-bottom: 8px;
      }
      .nota-segment-1 p {
        margin: 2px 0;
        line-height: 1.4;
        display: flex;
        font-size: 12px;
      }
      #notaOwner {
        font-size: 18px !important;
        font-weight: bold;
        text-transform: uppercase;
      }
      .nota-label {
        display: inline-block;
        white-space: nowrap;
      }
      .nota-colon {
        margin: 0 3px;
      }
      .nota-category-header {
        font-size: 13px;
        font-weight: bold;
        text-align: left;
        margin-top: 8px;
        margin-bottom: 2px;
        border-bottom: 1px dotted #555;
        padding-bottom: 8px;
      }
      .detail-timbangan-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .detail-column {
        display: flex;
        flex-direction: column;
        width: calc(100% / 5 - 15px);
        margin-bottom: 6px;
        padding-right: 5px;
      }
      .detail-column-spacer {
        width: calc(100% / 5 - 3px);
        height: 0;
      }
      .detail-item-value {
        font-size: 15px;
        font-weight: bold;
        text-align: right;
        line-height: 1.3;
        min-height: 1.3em;
        padding-right: 3px;
      }
      .detail-item-value.overweight {
        color: red;
        font-weight: bold;
      }
      .detail-item-placeholder {
        color: #777;
      }
      .detail-column-separator {
        font-size: 15px;
        font-weight: bold;
        text-align: right;
        margin: 2px 0 1px 0;
        line-height: 1;
        padding-right: 3px;
      }
      .detail-column-sum {
        font-size: 17px;
        font-weight: bold;
        text-align: right;
        margin-top: 1px;
        padding-right: 3px;
      }
      .nota-summary-section .nota-value.bold {
        font-weight: bold;
      }
      .nota-grand-total-section {
        margin-top: 5px;
      }
      .nota-grand-total-section p {
        justify-content: flex-start;
      }
      .nota-grand-total-section .nota-label strong {
        font-size: 16px;
        font-weight: bold;
      }
      #notaGrandTotalPembayaranValue {
        font-size: 18px !important;
        font-weight: bold;
      }
      .nota-final-footer {
        margin-top: 10px;
      }
      .nota-final-footer p.footer-terima-kasih {
        text-align: center;
        margin-top: 6px;
        font-size: 12px;
        margin-bottom: 0;
      }

      /* ===== PENYESUAIAN FONT LABEL NOTA PEMBAYARAN ===== */
      #notaPembayaranContainer .nota-label {
        font-size: 14px; /* Ukuran font baru yang lebih kecil, bisa disesuaikan ke 10px jika perlu */
        font-weight: normal; /* Opsional: Membuat teks label tidak tebal (non-bold) */
        vertical-align: baseline; /* Memastikan perataan teks tetap rapi */
      }

      /* Gaya Rekap Muatan */
      .ritase-input-item {
        display: grid;
        grid-template-columns: auto 2fr 1.5fr 1.5fr auto;
        gap: 0.75rem;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color-light);
      }
      .ritase-input-item:last-child {
        border-bottom: none;
      }
      .ritase-input-item label.ritase-number {
        font-size: 1.3rem;
        color: var(--text-secondary);
        white-space: nowrap;
        font-weight: 600;
      }
      #rekapitulasi-app .scrollable-ritase-container {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        padding: 1rem;
        border-radius: 0.375rem;
        background-color: #f8fafc;
      }
      #recapReceiptContainer {
        font-family: "Consolas", "Courier New", monospace;
        color: #000;
        background-color: #fff;
        margin: 0 auto;
        border: 1px solid #b0bec5;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        width: 100%;
        max-width: 500px;
        padding: 15px;
      }
      .recap-receipt-content {
        width: 100%;
        margin: 0 auto;
        padding-left: 2px;
        padding-right: 2px;
        box-sizing: border-box;
      }
      .recap-receipt-header {
        text-align: center;
        margin-bottom: 10px;
      }
      .recap-receipt-header h2 {
        font-size: 17px;
        font-weight: bold;
        margin: 0;
        line-height: 1.2;
      }
      /* --- UPDATE CSS GRID UNTUK REKAP MUATAN --- */

      /* --- PERBAIKAN GRID REKAP MUATAN (BAGIAN ATAS) --- */

      /* 1. Mengaktifkan Grid pada wadah utama info (Ini yang sebelumnya hilang) */
      .recap-receipt-info {
        display: grid;
        /* Membuat 3 Kolom: [Label] [Titik Dua] [Isi] */
        grid-template-columns: auto min-content 1fr;
        gap: 0px 8px; /* Jarak antar kolom */
        align-items: baseline;
        width: 100%;
        margin-bottom: 5px;
      }

      /* 2. Membuat tag <p> transparan agar isinya (span) langsung terbaca oleh Grid */
      .recap-receipt-info p {
        display: contents;
      }

      /* 3. Mengatur posisi kolom item di dalamnya */
      .recap-receipt-info .recap-receipt-label {
        grid-column: 1; /* Kolom pertama */
        white-space: nowrap;
      }

      .recap-receipt-info .recap-receipt-colon {
        grid-column: 2; /* Kolom kedua */
        margin: 0 !important;
        padding: 0 2px;
      }

      .recap-receipt-info .recap-receipt-value {
        grid-column: 3; /* Kolom ketiga */
        text-align: left;
      }

      /* 2. Bagian Summary (Total Muatan, Saro JJ, Total Saro) - Ganti ke Grid */
      .recap-receipt-summary {
        display: grid;
        /* Membuat 3 Kolom: [Label] [Titik Dua] [Nilai] */
        grid-template-columns: auto min-content 1fr;
        gap: 2px 10px; /* Jarak antar kolom 10px */
        align-items: baseline; /* Ratakan teks sesuai garis tulisannya */
        width: 100%;
        margin-top: 5px;
      }

      /* Membuat tag <p> transparan agar isinya (span) langsung masuk ke Grid */
      .recap-receipt-summary p {
        display: contents;
      }

      /* Aturan Kolom */
      .recap-receipt-summary .recap-receipt-label {
        grid-column: 1;
        white-space: nowrap;
        text-align: left;
      }

      .recap-receipt-summary .recap-receipt-colon {
        grid-column: 2;
        margin: 0 !important; /* Paksa hapus margin JS yang bikin tidak rata */
        padding: 0 2px;
      }

      .recap-receipt-summary .recap-receipt-value {
        grid-column: 3;
        text-align: left;
      }
      .recap-receipt-label {
        display: inline-block;
        white-space: nowrap;
      }
      .recap-receipt-label strong {
        font-weight: bold;
      }
      .recap-receipt-colon {
        margin-right: 5px;
      }
      .recap-receipt-value.bold {
        font-weight: bold;
      }
      #recapReceiptContainer .receipt-label-no-plat strong,
      #recapStrukNoPlat {
        font-size: 16px !important;
      }
      #recapReceiptContainer
        .recap-receipt-summary
        .recap-receipt-label
        strong {
        font-size: 15px !important;
      }
      #recapReceiptContainer .recap-receipt-summary .recap-receipt-value.bold,
      #recapReceiptContainer
        .recap-receipt-summary
        .recap-receipt-value.bold
        span {
        font-size: 16px !important;
      }
      .recap-receipt-divider {
        border-top: 1px dashed #333;
        margin: 10px 0;
      }
      .recap-detail-ritase-header {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 2px;
        text-align: center;
      }
      .recap-detail-ritase-spacer {
        height: 0.5em;
      }
      .recap-detail-ritase-table {
        width: 100%;
        font-size: 16px;
        border-collapse: collapse;
        margin-bottom: 8px;
        table-layout: fixed;
      }
      .recap-detail-ritase-table th,
      .recap-detail-ritase-table td {
        text-align: center;
        padding-top: 2px;
        padding-bottom: 4px;
        padding-left: 3px;
        padding-right: 3px;
        border: none; /* Hilangkan semua garis kotak */
        word-wrap: break-word;
        box-sizing: border-box;
        vertical-align: top;
      }
      .recap-detail-ritase-table th {
        border-bottom: 1px dashed #333 !important;
        padding-bottom: 6px; /* Jarak antara teks judul dan garis */
        margin-bottom: 4px;
      }
      .recap-detail-ritase-table th.col-no {
        width: 18%;
      }
      .recap-detail-ritase-table th.col-tanggal {
        width: 27%;
      }
      .recap-detail-ritase-table th.col-berat {
        width: 30%;
      }
      .recap-detail-ritase-table th.col-karung {
        width: 25%;
      }
      .recap-receipt-footer {
        text-align: left;
      }
      .recap-receipt-footer .recap-struk-catatan {
        font-size: 12px;
      }

      /* Gaya Rekap Gaji */
      #rekap-gaji-app .ritase-card {
        background-color: #fff;
        border: 1px solid var(--border-color-light);
        padding: 1.25rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }
      #rekap-gaji-app .ritase-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
      }
      #rekap-gaji-app .ritase-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      #rekap-gaji-app .buruh-name-input-wrapper {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      #rekap-gaji-app .buruh-name-input-wrapper input {
        flex-grow: 1;
        margin-right: 0.5rem;
      }
      #rekap-gaji-app .scrollable-container {
        max-height: 650px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }
      #gajiStrukContainer {
        font-family: "Consolas", "Courier New", monospace;
        color: #1f2937;
        background-color: #fff;
        padding: 15px;
        border: 1px solid #d1d5db;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 420px;
        box-sizing: border-box;
        border-radius: 0.5rem;
        margin: 0 auto;
      }
      .gaji-struk-content {
        padding: 0 18px;
        box-sizing: border-box;
        font-size: 10.5pt;
      }
      .gaji-struk-header h2 {
        font-size: 15pt;
        font-weight: bold;
        text-align: center;
        margin-bottom: 5px;
        color: #111827;
      }
      .gaji-struk-header-divider {
        border-top: 1px dashed #333;
        margin-bottom: 10px;
      }
      .gaji-struk-info p,
      .gaji-struk-summary p {
        margin: 4px 0;
        line-height: 1.5;
        display: flex;
        justify-content: space-between;
      }
      .gaji-struk-info p span:first-child {
        font-weight: normal;
      }
      .gaji-struk-info p strong,
      .gaji-struk-summary p strong {
        font-weight: bold;
      }
      #gajiStrukContainer #strukNoPlatGaji,
      #gajiStrukContainer #strukRatePerKarungGaji {
        font-weight: bold;
      }
      .gaji-struk-divider {
        border-top: 1px dashed #9ca3af;
        margin: 12px 0;
      }
      .buruh-gaji-detail {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px dotted #d1d5db;
      }
      .buruh-gaji-detail:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .buruh-gaji-detail h3 {
        font-weight: bold;
        font-size: 12pt;
        margin-bottom: 5px;
        color: #374151;
      }
      .buruh-gaji-detail p {
        margin: 2px 0;
        font-size: 9.5pt;
      }
      .buruh-gaji-detail p.rincian-upah-header,
      .buruh-gaji-detail p.rincian-item,
      .buruh-gaji-detail p.total-gaji-buruh {
        margin-left: 0;
      }
      .buruh-gaji-detail p.total-gaji-buruh {
        font-weight: bold;
        margin-top: 5px;
      }
      .buruh-gaji-detail p strong {
        font-weight: bold;
      }
      #rekap-gaji-app .filter-section {
        background-color: #f9fafb;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
      }
      #rekap-gaji-app .filter-section label {
        font-weight: 500;
        color: var(--text-primary);
      }
      .gaji-struk-final-footer {
        margin-top: 10px;
      }

      .print-button-container {
        margin-top: 1rem;
        width: 100%;
        display: flex;
        justify-content: center;
      }

      /* Gaya Footnote */
      .main-footer {
        text-align: center;
        padding: 2rem 1rem;
        margin-top: 3rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }
      .main-footer strong {
        font-weight: 600;
        color: var(--brand-primary);
      }

      /* --- Style untuk Modul Kalkulator Saro --- */
      #kalkulator-saro-app .saro-input-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      #kalkulator-saro-app .saro-input-item .saro-counter-label {
        width: 2rem;
        text-align: right;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }
      #strukJasaContainer {
        font-family: "Courier New", Courier, monospace;
        color: #000;
        background-color: #fff;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 380px;
        margin: 0 auto;
      }
      .struk-header h2 {
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 8px;
        text-transform: uppercase;
      }
      .struk-divider {
        border-top: 1px dashed #555;
        margin: 12px 0;
      }
      .struk-info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }
      .struk-info-item .label {
        white-space: nowrap;
        padding-right: 10px;
      }
      .struk-info-item .value {
        font-weight: bold;
        text-align: right;
      }
      .struk-info-item .summary-value {
        font-size: 15px;
      }
      .struk-result-item {
        margin-top: 10px;
        padding: 8px;
        border: 1px solid #eee;
        border-radius: 4px;
      }
      .struk-result-item .label {
        display: block;
        font-size: 0.85rem;
        font-weight: normal;
        color: #444;
        margin-bottom: 2px;
        text-transform: uppercase;
      }
      .struk-result-item .value {
        display: block;
        font-weight: bold;
        color: var(--brand-primary);
        text-align: right;
        font-size: 18px;
      }
      .struk-result-item.total .value {
        color: #b91c1c;
        font-size: 20px;
      }

      /* --- Gaya Modul Rekap Laporan (DIPERBARUI) --- */
      .history-section {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
      }
      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }
      .history-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
      }
      .history-table-wrapper {
        /* KELAS BARU */
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .history-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }
      .history-table th,
      .history-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color-light);
        vertical-align: top; /* PENTING UNTUK KONTEN MULTI-BARIS */
      }
      .history-table th {
        background-color: #f8fafc;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: sticky; /* Membuat header tetap terlihat saat scroll */
        top: 0;
        z-index: 1;
      }
      .history-table tbody tr:hover {
        background-color: #f1f5f9;
      }
      .history-table td {
        color: var(--text-primary);
      }
      .history-table td ul {
        margin: 0;
        padding-left: 1rem;
        list-style: none;
      }
      .history-table td ul li {
        padding-bottom: 0.25rem;
      }
      .history-table .col-right {
        text-align: right;
      }
      .history-table .col-center {
        text-align: center;
      }
      .no-history-message {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
        background-color: #f8fafc;
        border-radius: 0.5rem;
        border: 1px dashed var(--border-color);
      }
      .history-actions .btn {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
      }
      #rincianBeratContainer {
        max-height: 650px;
      }

      /* ===== PERBAIKAN: Tata Letak Rapi untuk Ringkasan Nota Pembayaran (v2) ===== */
      .nota-summary-grid {
        display: grid;
        /* Kolom 1 (Label), Kolom 2 (:), Kolom 3 (Nilai) */
        grid-template-columns: auto auto 1fr;
        gap: 2px 8px; /* Jarak antar kolom sedikit diperlebar */
        align-items: center; /* Menjaga item tetap sejajar di tengah baris */
      }

      .nota-summary-grid > .nota-label {
        grid-column: 1; /* Paksa semua label ada di kolom 1 */
        text-align: left;
      }
      .nota-summary-grid > .nota-colon {
        grid-column: 2; /* Paksa semua titik dua ada di kolom 2 */
      }
      .nota-summary-grid > .nota-value {
        grid-column: 3; /* Paksa semua nilai ada di kolom 3 */
        text-align: right; /* Membuat angka rata kanan agar lebih rapi */
      }
      #notaJumlahKarung {
        font-size: 15px;
      }
      /* ===== PERBAIKAN: Perataan Total Harga di Nota Pembayaran ===== */
      #notaPembayaranContainer .nota-grand-total-section p {
        display: flex;
        justify-content: space-between; /* Mendorong item ke ujung */
      }
      /* ===== PERBAIKAN: Perataan Info Atas di Nota Pembayaran ===== */
      #notaPembayaranContainer .nota-segment-1 {
        display: grid;
        /* Kolom 1 (Label), Kolom 2 (:), Kolom 3 (Nilai) */
        grid-template-columns: auto auto 1fr;
        gap: 2px 4px; /* Jarak antar baris dan kolom */
        align-items: center;
      }

      /* ===== PERBAIKAN: MENGUNCI SCROLL PADA KONTAINER ===== */
      /* Properti ini mencegah scroll "bocor" ke halaman utama saat
         kontainer sudah mencapai batas atas atau bawah. */

      #ownersListContainer,
      #catatan .owner-sacks-container,
      #nota .sack-input-container,
      #rekapitulasi-app .scrollable-ritase-container,
      #rekap-gaji-app .scrollable-container,
      #rincianBeratContainer,
      .history-table-wrapper {
        overscroll-behavior: contain;
        touch-action: pan-y;
        scroll-behavior: smooth;
      }

      /* ===== PENYESUAIAN UKURAN TOMBOL AKSI UTAMA ===== */
      .form-card button[type="submit"] {
        font-size: 1.75rem !important; /* Sekitar 28px */
        padding-top: 0.8rem !important;
        padding-bottom: 0.8rem !important;
      }

      /* ===== PENYESUAIAN UKURAN FONT GLOBAL DI DALAM KARTU ===== */
      /* Aturan ini akan memperbesar semua teks di dalam .form-card */

      /* Judul Utama Form (misal: "Input Data Muatan Gabah") */
      .form-card .form-title {
        font-size: 2.25rem; /* Semula: 1.5rem */
      }

      /* Semua Label Input (misal: "Tanggal", "Nomor Plat") */
      .form-card .input-label {
        font-size: 1.3rem; /* Semula: 0.875rem */
      }

      /* Semua Kolom Input, termasuk input angka */
      .form-card .form-input,
      .form-card .form-textarea {
        font-size: 2.25rem; /* Semula: 16px (sekitar 1rem) */
        padding-top: 0.6rem;
        padding-bottom: 0.6rem;
      }

      /* Judul Sub-bagian (misal: "Detail Kepemilikan Gabah") */
      .form-card h2 {
        font-size: 2.1rem; /* Semula: 1.125rem (kelas text-lg) */
      }

      /* Judul Kategori (misal: "Gabah Normal") */
      .form-card .gabah-category-title-timbangan,
      .form-card .gabah-category-title {
        font-size: 1.7rem !important;
        color: var(--text-primary) !important;
      }

      /* Penanda Karung (misal: "K-1:", "K-2:") */
      .form-card .karung-counter-label,
      .form-card .sack-input-item label {
        font-size: 1.5rem !important; /* Semula: 0.8rem */
      }

      /* Tombol-tombol di dalam kartu */
      .form-card button {
        font-size: 1.5rem; /* Memperbesar font pada tombol */
      }

      /* Display ringkasan di samping tombol "Tambah" */
      .form-card .summary-display {
        font-size: 1.8rem; /* Semula: 1*/
      }

      /* Display total per pemilik */
      .form-card .owner-summary-display {
        font-size: 2rem; /* Semula: 1rem */
        color: black !important;
      }

      /* Display Grand Total di bagian atas */
      .grand-total-display .total-label {
        font-size: 1.5rem; /* Semula: 1rem */
      }
      .grand-total-display .total-value {
        font-size: 2rem; /* Semula: 1.75rem */
      }
      /* ===== GAYA BARU UNTUK TEKS PLACEHOLDER ===== */
      /* Aturan ini akan membuat teks contoh isian (placeholder)
         terlihat berbeda dari teks inputan pengguna. */

      .form-input::placeholder,
      .form-textarea::placeholder {
        font-size: 1.8rem; /* <-- Atur ukuran font yang lebih kecil di sini */
        color: #9ca3af; /* Warna abu-abu agar tidak terlalu menonjol */
        font-style: italic; /* Membuatnya sedikit miring untuk membedakan */
        opacity: 1; /* Diperlukan untuk beberapa browser agar warna terlihat benar */
      }

      /* ===== PERBAIKAN: Tata Letak Rapi untuk Ringkasan Struk Timbangan ===== */
      .receipt-summary {
        display: grid;
        /* Kolom 1 (Label), Kolom 2 (:), Kolom 3 (Nilai) */
        grid-template-columns: auto auto 1fr;
        gap: 3px 5px; /* Jarak antar baris dan antar kolom */
        align-items: center; /* Menjaga kesejajaran vertikal */
      }

      /* Aturan tambahan untuk menangani elemen khusus di dalam grid */
      .receipt-summary .receipt-divider,
      .receipt-summary > p {
        /* Membuat garis pemisah dan baris Total Muatan membentang selebar 3 kolom */
        grid-column: 1 / -1;
      }

      /* ===== GAYA BARU UNTUK LAYAR LOGIN ===== */

      /* Animasi untuk input yang salah */
      @keyframes shake {
        10%,
        90% {
          transform: translateX(-1px);
        }
        20%,
        80% {
          transform: translateX(2px);
        }
        30%,
        50%,
        70% {
          transform: translateX(-4px);
        }
        40%,
        60% {
          transform: translateX(4px);
        }
      }

      #login-screen {
        overscroll-behavior-y: contain !important;
      }
      .shake-error {
        animation: shake 0.82s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        border-color: #ef4444 !important; /* Border merah saat error */
      }

      /* Gaya untuk transisi fade-out */
      #login-screen.fade-out {
        transition: opacity 0.5s ease-out;
        opacity: 0;
      }

      /* --- UPDATE: PERBESAR FONT TOTAL SARO --- */

      /* 1. Memberi jarak dan garis pemisah di atas Total Saro */
      .recap-receipt-summary p:last-of-type {
        margin-top: 5px !important;
        padding-top: 5px !important;
        border-top: 1px dashed #aaa; /* Garis putus-putus pemisah */
      }

      /* 2. Memperbesar Label "Total Saro" */
      .recap-receipt-summary p:last-of-type .recap-receipt-label strong {
        font-size: 18px !important; /* Diperbesar dari 14/15px */
      }

      /* 3. Memperbesar Titik Dua (:) agar seimbang */
      .recap-receipt-summary p:last-of-type .recap-receipt-colon {
        font-size: 18px !important;
      }

      /* 4. Memperbesar Nilai Rupiah (Total Saro) - DIPERKUAT */
      #recapReceiptContainer #recapStrukTotalJasa {
        font-size: 24px !important;
        font-weight: 900 !important; /* Ditebalkan maksimal */
        color: #000; /* Pastikan hitam pekat */
      }
      /* Gaya untuk baris tabel yang duplikat */
      .duplicate-row {
        background-color: #fee2e2 !important; /* Merah muda */
        color: #991b1b !important; /* Merah tua */
        border-left: 4px solid #ef4444; /* Garis merah di kiri */
      }
    </style>
  </head>

  <body class="min-h-screen p-4 sm:p-6 lg:p-8">
    <div
      id="login-screen"
      class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50"
    >
      <div
        id="login-card"
        class="bg-white p-10 rounded-xl shadow-lg w-full max-w-xl text-center"
      >
        <i class="fas fa-leaf text-7xl text-green-600 mb-4"></i>

        <h1 class="text-6xl font-bold text-gray-800">Portal Gabah</h1>
        <p class="text-gray-500 mt-2 mb-6 text-2xl">
          Silakan masukkan kata sandi untuk melanjutkan.
        </p>

        <form id="login-form">
          <input
            type="password"
            id="password-input"
            class="form-input text-center text-5xl tracking-widest"
            placeholder="••••••"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <p id="error-message" class="text-red-500 text-lg mt-2 h-5"></p>
          <button
            type="submit"
            class="w-full btn btn-primary mt-4 py-4 text-3xl"
          >
            Masuk
          </button>
        </form>
      </div>
    </div>
    <div id="app-wrapper" class="hidden">
      <div class="max-w-6xl mx-auto">
        <!-- ===== Header ===== -->
        <header id="main-header" class="text-center mb-8">
          <h1
            class="text-4xl md:text-5xl font-bold"
            style="color: var(--text-primary)"
          >
            Portal Gabah AsdFam
          </h1>
          <p class="text-lg mt-2" style="color: var(--text-secondary)">
            Manajemen Timbangan, Nota, Muatan, dan Gaji
          </p>
        </header>

        <!-- ===== Navigasi Kartu Utama ===== -->
        <div
          id="main-nav-container"
          class="flex flex-wrap justify-center items-stretch gap-4 mb-10"
        >
          <div
            class="main-nav-card active"
            onclick="showMainSection('catatan-timbangan-app')"
          >
            <i class="fas fa-weight-scale nav-icon"></i>
            <h2 class="nav-title">Catatan Timbangan</h2>
          </div>
          <div
            class="main-nav-card"
            onclick="showMainSection('nota-pembayaran-app')"
          >
            <i class="fas fa-file-invoice-dollar nav-icon"></i>
            <h2 class="nav-title">Nota Pembayaran</h2>
          </div>
          <div
            class="main-nav-card"
            onclick="showMainSection('rekapitulasi-app')"
          >
            <i class="fas fa-truck-pickup nav-icon"></i>
            <h2 class="nav-title">Rekap Rit Muatan</h2>
          </div>
          <div
            class="main-nav-card"
            onclick="showMainSection('rekap-gaji-app')"
          >
            <i class="fas fa-users nav-icon"></i>
            <h2 class="nav-title">Rekap Saro Panca</h2>
          </div>
          <!-- NAVIGASI BARU: UTILITAS -->
          <div class="relative" id="utilitas-nav-container">
            <div class="main-nav-card" id="utilitas-nav-card">
              <i class="fas fa-cogs nav-icon"></i>
              <h2 class="nav-title">Utilitas</h2>
            </div>
            <div id="utilitas-submenu" class="hidden absolute">
              <button
                class="utilitas-submenu-button"
                onclick="showMainSection('kalkulator-saro-app')"
              >
                <i class="fas fa-calculator"></i>
                <span>Kalkulator Saro</span>
              </button>
              <button
                class="utilitas-submenu-button"
                onclick="showMainSection('rekap-laporan-app')"
              >
                <i class="fas fa-history"></i>
                <span>Rekap Laporan</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ===== KONTEN APLIKASI ===== -->

        <!-- ===== BAGIAN 1: Catatan Timbangan ===== -->
        <div id="catatan-timbangan-app" class="main-app-section active">
          <div id="catatan">
            <div
              class="container mx-auto max-w-4xl form-card p-6 sm:p-8 rounded-xl shadow-lg"
            >
              <div id="mainFormContainerCatatan">
                <div class="form-header-container">
                  <h1 class="form-title">
                    <i class="fas fa-weight-scale mr-3"></i>Input Data Muatan
                    Gabah
                  </h1>
                  <button
                    id="resetCatatanButton"
                    title="Hapus semua input pada form ini"
                    class="reset-form-button"
                  >
                    <i class="fas fa-eraser"></i>Reset
                  </button>
                </div>
                <form id="gabahForm" class="space-y-5">
                  <div class="form-input-group">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label for="tanggal" class="input-label">Tanggal</label>
                        <input
                          type="date"
                          id="tanggal"
                          required
                          class="form-input"
                        />
                      </div>
                      <div>
                        <label for="noPlatInput" class="input-label"
                          >Nomor Plat</label
                        >
                        <input
                          type="text"
                          id="noPlatInput"
                          list="noPlatList"
                          placeholder="Contoh: B 1234 XYZ"
                          required
                          class="form-input"
                        />
                        <datalist id="noPlatList">
                          <option value="DD 8951 AP"></option>
                          <option value="DD 8296 HJ"></option>
                          <option value="DP 8420 CZ"></option>
                          <option value="DC 8199 FC"></option>
                          <option value="DP 8950 CA"></option>
                        </datalist>
                      </div>
                      <div>
                        <label for="lokasiInput" class="input-label"
                          >Lokasi</label
                        >
                        <input
                          type="text"
                          id="lokasiInput"
                          list="lokasiList"
                          placeholder="Contoh: MANISA"
                          class="form-input"
                        />
                      </div>
                      <div>
                        <label for="ritase" class="input-label"
                          >Ritase Ke-</label
                        >
                        <input
                          type="number"
                          id="ritase"
                          min="1"
                          placeholder="1"
                          class="form-input"
                        />
                      </div>
                    </div>
                    <div
                      class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4 mt-4"
                    >
                      <div>
                        <label for="potonganNormalCatatan" class="input-label"
                          >Potongan Normal (Kg/Krg)</label
                        >
                        <input
                          type="number"
                          id="potonganNormalCatatan"
                          value="0"
                          step="0.1"
                          class="form-input"
                        />
                      </div>
                      <div>
                        <label for="potonganAbnormalCatatan" class="input-label"
                          >Potongan Tdk Normal (Kg/Krg)</label
                        >
                        <input
                          type="number"
                          id="potonganAbnormalCatatan"
                          value="0"
                          step="0.1"
                          class="form-input"
                        />
                      </div>
                    </div>
                  </div>

                  <div
                    id="catatanGrandTotalDisplay"
                    class="grand-total-display hidden"
                  ></div>
                  <div class="border-t border-gray-200 pt-5">
                    <div
                      id="quickWeighToggleContainer"
                      class="text-center mb-4 hidden"
                    >
                      <button
                        type="button"
                        id="startQuickWeighButton"
                        class="btn btn-secondary w-full"
                      >
                        <i class="fas fa-bolt mr-2"></i>Mulai Sesi Timbang Cepat
                      </button>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                      <h2 class="text-lg font-semibold">
                        Detail Kepemilikan Gabah
                      </h2>
                      <button
                        type="button"
                        id="addOwnerButton"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white"
                        style="background-color: var(--brand-primary)"
                      >
                        <i class="fas fa-plus mr-2"></i>Tambah Owner
                      </button>
                    </div>
                    <div
                      id="ownersListContainer"
                      class="scrollable-input-container space-y-4"
                    ></div>
                  </div>
                  <!-- Input Catatan Dinamis -->
                  <div class="border-t border-gray-200 pt-5">
                    <button
                      type="button"
                      id="addCatatanBtn_Catatan"
                      class="w-full text-left text-blue-600 hover:text-blue-800 text-sm font-medium"
                    >
                      <i class="fas fa-plus mr-2"></i>Tambah Catatan
                    </button>
                    <div id="catatanInputWrapper_Catatan" class="hidden">
                      <div class="catatan-input-wrapper">
                        <label for="catatanCatatanInput" class="input-label"
                          >Catatan Struk (Opsional)</label
                        >
                        <textarea
                          id="catatanCatatanInput"
                          class="form-textarea"
                          placeholder="Ketik catatan yang akan ditampilkan di struk..."
                        ></textarea>
                        <button
                          type="button"
                          title="Hapus Catatan"
                          class="remove-catatan-btn removeCatatanBtn_Catatan"
                        >
                          &times;
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="pt-5">
                    <button type="submit" class="w-full btn btn-primary">
                      <i class="fas fa-sticky-note mr-2"></i>Buat Catatan
                    </button>
                  </div>
                </form>
              </div>

              <!-- FITUR BARU: SESI TIMBANG CEPAT -->
              <div id="quickWeighSession" class="hidden">
                <h2 class="text-xl font-bold text-center mb-4">
                  Sesi Timbang Cepat
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                  <div>
                    <label for="quickWeighInput" class="input-label text-center"
                      >Berat Timbangan (Kg)</label
                    >
                    <input
                      type="number"
                      id="quickWeighInput"
                      class="form-input text-3xl text-center h-16"
                      placeholder="0.0"
                    />
                  </div>
                  <div class="space-y-3">
                    <label class="input-label text-center">Kategori</label>
                    <div class="flex justify-center gap-3">
                      <button
                        type="button"
                        data-category="normal"
                        class="quick-weigh-category-btn flex-1 btn-add-normal active"
                      >
                        Normal
                      </button>
                      <button
                        type="button"
                        data-category="abnormal"
                        class="quick-weigh-category-btn flex-1 btn-add-abnormal"
                      >
                        Tdk Normal
                      </button>
                    </div>
                  </div>
                </div>
                <div class="mt-6">
                  <label class="input-label text-center mb-3"
                    >Pilih Pemilik</label
                  >
                  <div
                    id="quickWeighOwnerButtons"
                    class="flex flex-wrap justify-center gap-3"
                  ></div>
                </div>
                <div class="mt-6">
                  <h3 class="font-semibold text-center mb-2">
                    Riwayat Timbangan
                  </h3>
                  <div
                    id="quickWeighHistory"
                    class="p-2 rounded-md h-48 overflow-y-auto text-sm"
                  ></div>
                </div>
                <div class="mt-6 flex gap-4">
                  <button
                    type="button"
                    id="finishQuickWeighButton"
                    class="w-full btn btn-primary"
                  >
                    <i class="fas fa-check-double mr-2"></i>Selesai & Pindahkan
                    Data
                  </button>
                  <button
                    type="button"
                    id="cancelQuickWeighButton"
                    class="w-full btn bg-gray-500 hover:bg-gray-600 text-white"
                  >
                    <i class="fas fa-times mr-2"></i>Batal
                  </button>
                </div>
              </div>
            </div>

            <!-- Output Struk -->
            <div id="catatanOutputSection" class="hidden mt-8">
              <div
                id="thermalReceiptContainer"
                class="thermal-receipt-container mx-auto"
              >
                <div class="receipt-content">
                  <div class="receipt-header">
                    <h2>CATATAN MUATAN GABAH</h2>
                  </div>
                  <div class="receipt-divider"></div>
                  <div class="receipt-info">
                    <span class="receipt-label" data-group="info">Tanggal</span
                    ><span class="receipt-colon">:</span
                    ><span id="strukTanggal" class="receipt-value"></span>
                    <span class="receipt-label" data-group="info"
                      ><strong>No. Plat</strong></span
                    ><span class="receipt-colon">:</span
                    ><strong
                      id="strukNoPlatCatatan"
                      class="receipt-value"
                    ></strong>
                    <span class="receipt-label" data-group="info">Lokasi</span
                    ><span class="receipt-colon">:</span
                    ><span id="strukLokasi" class="receipt-value"></span>
                    <span class="receipt-label" data-group="info">Ritase</span
                    ><span class="receipt-colon">:</span
                    ><span id="strukRitase" class="receipt-value"></span>
                  </div>
                  <div class="receipt-divider"></div>
                  <div id="receiptOwnersDetails"></div>
                  <div class="receipt-divider"></div>
                  <div class="receipt-summary">
                    <span class="receipt-label"
                      ><strong>Total Gabah</strong></span
                    >
                    <span class="receipt-colon">:</span>
                    <strong class="receipt-value"
                      ><span id="summaryTotalKarung"></span> Karung</strong
                    >

                    <span class="receipt-label"
                      ><strong>Total Timbangan</strong></span
                    >
                    <span class="receipt-colon">:</span>
                    <strong class="receipt-value"
                      ><span id="summaryBeratTimbangan"></span
                    ></strong>

                    <span class="receipt-label"><strong>Potongan</strong></span>
                    <span class="receipt-colon">:</span>
                    <strong class="receipt-value"
                      ><span id="summaryPotongan"></span
                    ></strong>

                    <span class="receipt-label"
                      ><strong>Total Bersih</strong></span
                    >
                    <span class="receipt-colon">:</span>
                    <strong class="receipt-value"
                      ><span id="summaryBeratBersih"></span
                    ></strong>

                    <div class="receipt-divider"></div>

                    <p style="font-size: 16px !important">
                      <span class="receipt-label"
                        ><strong>Total Muatan</strong></span
                      >
                      <span class="receipt-colon">:</span>
                      <strong class="receipt-value">
                        <span id="summaryGrandTotalBerat"></span> Kg |
                        <span id="summaryGrandTotalKarung"></span> Krg
                      </strong>
                    </p>
                  </div>
                  <div id="receiptCatatanSection"></div>
                  <div class="receipt-divider"></div>
                  <div class="receipt-footer">
                    <p><span id="receiptFooterNoPlat"></span></p>
                    <p>&nbsp;</p>
                  </div>
                </div>
              </div>
              <div class="print-button-container">
                <button
                  id="saveCatatanAsJpgButton"
                  class="w-full max-w-sm btn btn-secondary"
                >
                  <i class="fas fa-file-image mr-2"></i>Simpan Catatan (JPG)
                </button>
              </div>
              <!-- Aksi Lanjutan: Buat Nota -->
              <div id="buatNotaActionsContainer" class="mt-6 hidden">
                <h3
                  class="text-center text-lg font-semibold mb-3 text-gray-700"
                >
                  Aksi Lanjutan
                </h3>
                <div
                  id="buatNotaButtons"
                  class="flex flex-col items-center gap-3"
                >
                  <!-- Tombol dinamis akan ditambahkan di sini -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== BAGIAN 2: Nota Pembayaran ===== -->
        <div id="nota-pembayaran-app" class="main-app-section">
          <div id="nota">
            <div
              class="container mx-auto max-w-4xl form-card p-6 sm:p-8 rounded-xl shadow-lg"
            >
              <div class="form-header-container">
                <h1 class="form-title">
                  <i class="fas fa-file-invoice-dollar mr-3"></i>Nota Pembayaran
                  Gabah
                </h1>
                <button
                  id="resetNotaButton"
                  title="Hapus semua input pada form ini"
                  class="reset-form-button"
                >
                  <i class="fas fa-eraser"></i>Reset
                </button>
              </div>
              <form id="pembayaranGabahForm" class="space-y-6">
                <div class="form-input-group">
                  <!-- Input Dasar -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label for="formTanggalNota" class="input-label"
                        >Tanggal</label
                      >
                      <input
                        type="date"
                        id="formTanggalNota"
                        required
                        class="form-input"
                      />
                    </div>
                    <div>
                      <label for="formOwner" class="input-label"
                        >Nama Owner</label
                      >
                      <input
                        type="text"
                        id="formOwner"
                        placeholder="Nama Pemilik Gabah"
                        required
                        class="form-input"
                      />
                    </div>
                    <div>
                      <label for="formLokasiNota" class="input-label"
                        >Lokasi</label
                      >
                      <input
                        type="text"
                        id="formLokasiNota"
                        placeholder="Lokasi Muat"
                        class="form-input"
                      />
                    </div>
                  </div>

                  <!-- Input Harga -->
                  <div
                    class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6 mt-6"
                  >
                    <div>
                      <label for="formHargaGabahNormal" class="input-label"
                        >Harga Gabah Normal (Rp/Kg)</label
                      >
                      <input
                        type="number"
                        id="formHargaGabahNormal"
                        placeholder="Isi harga atau kosongkan"
                        min="0"
                        class="form-input"
                      />
                    </div>
                    <div>
                      <label for="formHargaGabahTidakNormal" class="input-label"
                        >Harga Gabah Tdk Normal (Rp/Kg)</label
                      >
                      <input
                        type="number"
                        id="formHargaGabahTidakNormal"
                        placeholder="Isi harga atau kosongkan"
                        min="0"
                        class="form-input"
                      />
                    </div>
                  </div>
                  <div
                    class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6 mt-6"
                  >
                    <div>
                      <label for="formPotonganNormal" class="input-label"
                        >Potongan Gabah Normal /Krg</label
                      >
                      <input
                        type="number"
                        id="formPotonganNormal"
                        value="0"
                        min="0"
                        step="0.1"
                        class="form-input"
                      />
                    </div>
                    <div>
                      <label for="formPotonganTidakNormal" class="input-label"
                        >Potongan Gabah Tdk Normal /Krg</label
                      >
                      <input
                        type="number"
                        id="formPotonganTidakNormal"
                        value="0"
                        min="0"
                        step="0.1"
                        class="form-input"
                      />
                    </div>
                  </div>
                </div>

                <!-- Input Detail Karung -->
                <div
                  id="notaGrandTotalDisplay"
                  class="grand-total-display hidden"
                ></div>
                <div
                  class="grid grid-cols-1 md:grid-cols-2 gap-8 border-t pt-6"
                >
                  <div class="gabah-category-section bg-green-50">
                    <h3 class="gabah-category-title text-green-800 font-bold">
                      <i class="fas fa-check-circle mr-2"></i>Gabah Normal
                    </h3>
                    <div
                      id="dynamicSackInputsNormalContainer"
                      class="sack-input-container space-y-2"
                    ></div>
                    <div class="mt-4">
                      <button
                        type="button"
                        id="addSackNormalButton"
                        class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white btn-add-normal"
                      >
                        <i class="fas fa-plus mr-1"></i>Tambah
                      </button>
                    </div>
                  </div>
                  <div class="gabah-category-section bg-yellow-50">
                    <h3 class="gabah-category-title text-yellow-800 font-bold">
                      <i class="fas fa-exclamation-triangle mr-2"></i>Gabah Tdk
                      Normal
                    </h3>
                    <div
                      id="dynamicSackInputsTidakNormalContainer"
                      class="sack-input-container space-y-2"
                    ></div>
                    <div class="mt-4">
                      <button
                        type="button"
                        id="addSackTidakNormalButton"
                        class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white btn-add-abnormal"
                      >
                        <i class="fas fa-plus mr-1"></i>Tambah
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Input Catatan Dinamis -->
                <div class="border-t pt-6">
                  <button
                    type="button"
                    id="addCatatanBtn_Nota"
                    class="w-full text-left text-blue-600 hover:text-blue-800 text-sm font-medium"
                  >
                    <i class="fas fa-plus mr-2"></i>Tambah Catatan
                  </button>
                  <div id="catatanInputWrapper_Nota" class="hidden">
                    <div class="catatan-input-wrapper">
                      <label for="notaCatatanInput" class="input-label"
                        >Catatan Struk (Opsional)</label
                      >
                      <textarea
                        id="notaCatatanInput"
                        class="form-textarea"
                        placeholder="Ketik catatan yang akan ditampilkan di struk..."
                      ></textarea>
                      <button
                        type="button"
                        title="Hapus Catatan"
                        class="remove-catatan-btn removeCatatanBtn_Nota"
                      >
                        &times;
                      </button>
                    </div>
                  </div>
                </div>

                <div class="pt-5">
                  <button type="submit" class="w-full btn btn-primary">
                    <i class="fas fa-calculator mr-2"></i>Buat Nota
                  </button>
                </div>
              </form>
            </div>

            <!-- Output Struk Nota -->
            <div id="notaOutputSection" class="hidden mt-8">
              <div
                id="notaPembayaranContainer"
                class="thermal-receipt-container mx-auto"
              >
                <div class="nota-content">
                  <div class="nota-header">
                    <h2>NOTA PEMBAYARAN GABAH</h2>
                    <p class="nota-contact-info">
                      Telp/WA : 0813-5698-6956 (Asdar)
                    </p>
                  </div>
                  <div class="nota-title-divider"></div>
                  <div class="nota-segment-1">
                    <span class="nota-label">Tanggal</span
                    ><span class="nota-colon">:</span
                    ><span id="notaTanggal" class="nota-value"></span>
                    <span class="nota-label">Lokasi</span
                    ><span class="nota-colon">:</span
                    ><span id="notaLokasi" class="nota-value"></span>
                    <span class="nota-label">Owner</span
                    ><span class="nota-colon">:</span
                    ><span id="notaOwner" class="nota-value"></span>
                    <span class="nota-label">Jumlah</span
                    ><span class="nota-colon">:</span
                    ><strong
                      id="notaJumlahKarung"
                      class="nota-value bold"
                    ></strong>
                  </div>
                  <div class="nota-divider"></div>
                  <div id="notaRincianNormalSection">
                    <p class="nota-category-header">Gabah Normal</p>
                    <div
                      id="notaDetailTimbanganNormalContainer"
                      class="detail-timbangan-grid"
                    ></div>
                    <div class="nota-summary-section mt-2"></div>
                  </div>
                  <div id="notaRincianTidakNormalSection">
                    <div class="nota-divider"></div>
                    <p class="nota-category-header">Gabah Tidak Normal</p>
                    <div
                      id="notaDetailTimbanganTidakNormalContainer"
                      class="detail-timbangan-grid"
                    ></div>
                    <div class="nota-summary-section mt-2"></div>
                  </div>
                  <div class="nota-divider"></div>
                  <div class="nota-grand-total-section">
                    <p>
                      <span class="nota-label"
                        ><strong>Total Harga</strong></span
                      ><span class="nota-colon">:</span
                      ><span
                        id="notaGrandTotalPembayaranValue"
                        class="nota-value"
                      ></span>
                    </p>
                  </div>
                  <div class="nota-final-footer">
                    <div id="notaStrukCatatanSection"></div>
                    <p class="footer-terima-kasih">~~~ Terima Kasih ~~~</p>
                  </div>
                </div>
              </div>
              <div class="print-button-container">
                <button
                  id="saveNotaAsJpgButton"
                  class="w-full max-w-sm btn btn-secondary"
                >
                  <i class="fas fa-file-image mr-2"></i>Simpan Nota (JPG)
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== BAGIAN 3: Rekap Muatan ===== -->
        <div id="rekapitulasi-app" class="main-app-section">
          <div
            class="container mx-auto max-w-4xl form-card p-6 sm:p-10 rounded-xl shadow-lg"
          >
            <div class="form-header-container">
              <h1 class="form-title">
                <i class="fas fa-truck-pickup mr-3"></i>Rekap Muatan Mobil
              </h1>
              <button
                id="resetRekapButton"
                title="Hapus semua input pada form ini"
                class="reset-form-button"
              >
                <i class="fas fa-eraser"></i>Reset
              </button>
            </div>
            <form id="rekapGabahForm" class="space-y-8">
              <div class="form-input-group">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="rekapTanggalMulai" class="input-label"
                      >Tanggal Mulai</label
                    >
                    <input
                      type="date"
                      id="rekapTanggalMulai"
                      name="rekapTanggalMulai"
                      required
                      class="form-input"
                    />
                  </div>
                  <div>
                    <label for="rekapTanggalSelesai" class="input-label"
                      >Tanggal Selesai</label
                    >
                    <input
                      type="date"
                      id="rekapTanggalSelesai"
                      name="rekapTanggalSelesai"
                      required
                      class="form-input"
                    />
                  </div>
                  <div>
                    <label for="rekapNoPlatInput" class="input-label"
                      >Nomor Plat Kendaraan</label
                    >
                    <input
                      type="text"
                      id="rekapNoPlatInput"
                      name="rekapNoPlat"
                      list="rekapNoPlatList"
                      placeholder="Contoh: B 1234 XYZ"
                      required
                      class="form-input"
                    />
                    <datalist id="rekapNoPlatList">
                      <option value="DD 8951 AP"></option>
                      <option value="DD 8296 HJ"></option>
                      <option value="DP 8420 CZ"></option>
                      <option value="DC 8199 FC"></option>
                      <option value="DP 8950 CA"></option>
                    </datalist>
                  </div>
                  <div>
                    <div>
                      <label for="rekapHargaJasa" class="input-label"
                        >Harga Jasa Angkut/Kg (Rp)</label
                      >
                      <input
                        type="number"
                        id="rekapHargaJasa"
                        name="rekapHargaJasa"
                        value="125"
                        required
                        class="form-input"
                      />
                    </div>
                    <div>
                      <label for="rekapHargaTambahan" class="input-label"
                        >Tambahan Jarak Jauh/Rit (Rp)</label
                      >
                      <input
                        type="number"
                        id="rekapHargaTambahan"
                        name="rekapHargaTambahan"
                        value="40000"
                        class="form-input"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="border-t pt-6"
                style="border-color: var(--border-color)"
              >
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-xl font-semibold">
                    Detail Ritase yang Direkap
                  </h2>
                  <div class="flex items-center gap-2">
                    <input
                      type="number"
                      id="rekapAddAmount"
                      class="form-input w-20 text-center"
                      placeholder="Jml"
                      min="1"
                    />
                    <button
                      type="button"
                      id="addRitaseButton"
                      class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md shadow-sm btn btn-secondary"
                    >
                      <i class="fas fa-plus mr-2"></i>Tambah
                    </button>
                  </div>
                </div>
                <div
                  id="ritaseListContainer"
                  class="scrollable-ritase-container space-y-1"
                ></div>
              </div>
              <!-- Input Catatan Dinamis -->
              <div
                class="border-t pt-6"
                style="border-color: var(--border-color)"
              >
                <button
                  type="button"
                  id="addCatatanBtn_Rekap"
                  class="w-full text-left text-blue-600 hover:text-blue-800 text-sm font-medium"
                >
                  <i class="fas fa-plus mr-2"></i>Tambah Catatan
                </button>
                <div id="catatanInputWrapper_Rekap" class="hidden">
                  <div class="catatan-input-wrapper">
                    <label for="rekapCatatanInput" class="input-label"
                      >Catatan Struk (Opsional)</label
                    >
                    <textarea
                      id="rekapCatatanInput"
                      class="form-textarea"
                      placeholder="Ketik catatan yang akan ditampilkan di struk..."
                    ></textarea>
                    <button
                      type="button"
                      title="Hapus Catatan"
                      class="remove-catatan-btn removeCatatanBtn_Rekap"
                    >
                      &times;
                    </button>
                  </div>
                </div>
              </div>
              <div class="pt-6">
                <button
                  type="submit"
                  class="w-full py-3 px-4 text-base rounded-md shadow-sm font-semibold btn btn-primary"
                >
                  <i class="fas fa-list-alt mr-2"></i>Buat Rekap Rit
                </button>
              </div>
            </form>
          </div>
          <!-- Output Section (Struk) -->
          <div id="rekapOutputSection" class="hidden mt-8">
            <div id="recapReceiptContainer" class="mx-auto">
              <div class="recap-receipt-content">
                <div class="recap-receipt-header">
                  <h2>REKAP MUATAN MOBIL</h2>
                </div>
                <div class="recap-receipt-divider"></div>
                <div class="recap-receipt-info">
                  <p>
                    <span class="recap-receipt-label" data-group="recap-info"
                      >Periode Laporan</span
                    ><span class="recap-receipt-colon">:</span
                    ><span
                      id="recapStrukPeriode"
                      class="recap-receipt-value"
                    ></span>
                  </p>
                  <p>
                    <span
                      class="recap-receipt-label receipt-label-no-plat"
                      data-group="recap-info"
                      ><strong>No. Plat</strong></span
                    ><span class="recap-receipt-colon">:</span
                    ><strong
                      id="recapStrukNoPlat"
                      class="recap-receipt-value bold"
                    ></strong>
                  </p>
                  <p>
                    <span class="recap-receipt-label" data-group="recap-info"
                      >Total Ritase</span
                    ><span class="recap-receipt-colon">:</span
                    ><span
                      id="recapStrukTotalRitase"
                      class="recap-receipt-value"
                    ></span>
                  </p>
                </div>
                <div class="recap-receipt-divider"></div>
                <div class="recap-detail-ritase-section">
                  <p class="recap-detail-ritase-header">Rincian Ritase:</p>
                  <div class="recap-detail-ritase-spacer"></div>
                  <table class="recap-detail-ritase-table">
                    <thead>
                      <tr>
                        <th class="col-no">No.</th>
                        <th class="col-tanggal">Tanggal</th>
                        <th class="col-berat">Berat (Kg)</th>
                        <th class="col-karung">Karung</th>
                      </tr>
                    </thead>
                    <tbody id="recapStrukDetailRitaseBody"></tbody>
                  </table>
                </div>
                <div class="recap-receipt-divider"></div>
                <div class="recap-receipt-summary">
                  <p>
                    <span class="recap-receipt-label" data-group="recap-summary"
                      ><strong>Total Muatan</strong></span
                    >
                    <span class="recap-receipt-colon">:</span>
                    <strong class="recap-receipt-value bold">
                      <span id="recapStrukGrandTotalBerat"></span> Kg /
                      <span id="recapStrukGrandTotalKarung"></span> Krg
                    </strong>
                  </p>
                  <p id="recapStrukTambahanRow" class="hidden">
                    <span class="recap-receipt-label" data-group="recap-summary"
                      ><strong>Saro JJ</strong></span
                    >
                    <span class="recap-receipt-colon">:</span>
                    <span
                      class="recap-receipt-value"
                      id="recapStrukTambahanValue"
                      style="font-size: 14px"
                    ></span>
                  </p>
                  <p>
                    <span class="recap-receipt-label" data-group="recap-summary"
                      ><strong>Total Saro</strong></span
                    >
                    <span class="recap-receipt-colon">:</span>
                    <strong
                      class="recap-receipt-value bold"
                      id="recapStrukTotalJasa"
                    ></strong>
                  </p>
                </div>
                <div class="recap-receipt-footer">
                  <div
                    id="recapStrukCatatanSection"
                    class="recap-struk-catatan"
                  ></div>
                </div>
              </div>
            </div>
            <div class="print-button-container">
              <button
                id="saveRecapAsJpgButton"
                class="w-full max-w-sm btn btn-secondary"
              >
                <i class="fas fa-file-image mr-2"></i>Simpan Rekap (JPG)
              </button>
            </div>
          </div>
        </div>

        <!-- ===== BAGIAN 4: Rekap Gaji Buruh ===== -->
        <div id="rekap-gaji-app" class="main-app-section">
          <div
            class="container mx-auto max-w-4xl form-card p-6 sm:p-10 rounded-xl shadow-lg"
          >
            <div class="form-header-container">
              <h1 class="form-title">
                <i class="fas fa-users mr-3"></i>Rekap Saro Panca
              </h1>
              <button
                id="resetGajiButton"
                title="Hapus semua input pada form ini"
                class="reset-form-button"
              >
                <i class="fas fa-eraser"></i>Reset
              </button>
            </div>
            <form id="gajiBuruhForm" class="space-y-8">
              <div class="form-input-group">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="gajiFormTanggalMulai" class="input-label"
                      >Tanggal Mulai Periode</label
                    >
                    <input
                      type="date"
                      id="gajiFormTanggalMulai"
                      name="formTanggalMulai"
                      required
                      class="form-input"
                    />
                  </div>
                  <div>
                    <label for="gajiFormTanggalSelesai" class="input-label"
                      >Tanggal Selesai Periode</label
                    >
                    <input
                      type="date"
                      id="gajiFormTanggalSelesai"
                      name="formTanggalSelesai"
                      required
                      class="form-input"
                    />
                  </div>
                  <div>
                    <label for="gajiFormNoPlat" class="input-label"
                      >Nomor Plat Kendaraan</label
                    >
                    <input
                      type="text"
                      id="gajiFormNoPlat"
                      name="formNoPlat"
                      list="noPlatOptionsGaji"
                      placeholder="Contoh: DD 1234 AB"
                      required
                      class="form-input"
                    />
                    <datalist id="noPlatOptionsGaji">
                      <option value="DD 8951 AP"></option>
                      <option value="DD 8296 HJ"></option>
                      <option value="DP 8420 CZ"></option>
                      <option value="DC 8199 FC"></option>
                      <option value="DP 8950 CA"></option>
                    </datalist>
                  </div>
                  <div>
                    <label for="gajiFormRatePerKarung" class="input-label"
                      >Rate per Karung (Rp)</label
                    >
                    <input
                      type="number"
                      id="gajiFormRatePerKarung"
                      name="formRatePerKarung"
                      placeholder="Contoh: 6000"
                      min="0"
                      required
                      class="form-input"
                    />
                  </div>
                </div>
              </div>
              <div
                class="border-t pt-6"
                style="border-color: var(--border-color)"
              >
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-xl font-semibold">
                    Detail Ritase dan Saro Panca
                  </h2>
                  <div class="flex items-center gap-2">
                    <input
                      type="number"
                      id="gajiAddAmount"
                      class="form-input w-20 text-center"
                      placeholder="Jml"
                      min="1"
                    />
                    <button
                      type="button"
                      id="addGajiRitaseEntryButton"
                      class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md shadow-sm btn btn-secondary"
                    >
                      <i class="fas fa-plus mr-2"></i>Tambah
                    </button>
                  </div>
                </div>
                <div
                  id="gajiRitaseEntriesContainer"
                  class="space-y-4 scrollable-container"
                ></div>
              </div>
              <div class="filter-section hidden" id="gajiBuruhFilterContainer">
                <label class="input-label mb-3"
                  >Filter Buruh untuk Ditampilkan di Struk:</label
                >
                <div
                  id="gajiBuruhCheckboxList"
                  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mb-3"
                ></div>
                <div class="flex items-center mt-3">
                  <input
                    type="checkbox"
                    id="selectAllGajiBuruh"
                    class="h-4 w-4 rounded focus:ring-indigo-500"
                    style="color: var(--brand-primary)"
                  />
                  <label for="selectAllGajiBuruh" class="ml-2 block text-sm"
                    >Pilih Semua / Hapus Pilihan</label
                  >
                </div>
              </div>
              <!-- Input Catatan Dinamis -->
              <div
                class="border-t pt-6"
                style="border-color: var(--border-color)"
              >
                <button
                  type="button"
                  id="addCatatanBtn_Gaji"
                  class="w-full text-left text-blue-600 hover:text-blue-800 text-sm font-medium"
                >
                  <i class="fas fa-plus mr-2"></i>Tambah Catatan
                </button>
                <div id="catatanInputWrapper_Gaji" class="hidden">
                  <div class="catatan-input-wrapper">
                    <label for="gajiCatatanInput" class="input-label"
                      >Catatan Struk (Opsional)</label
                    >
                    <textarea
                      id="gajiCatatanInput"
                      class="form-textarea"
                      placeholder="Ketik catatan yang akan ditampilkan di struk..."
                    ></textarea>
                    <button
                      type="button"
                      title="Hapus Catatan"
                      class="remove-catatan-btn removeCatatanBtn_Gaji"
                    >
                      &times;
                    </button>
                  </div>
                </div>
              </div>
              <div class="pt-6">
                <button
                  type="submit"
                  class="w-full py-3 px-4 text-base rounded-md shadow-sm font-semibold btn btn-primary"
                >
                  <i class="fas fa-cogs mr-2"></i>Hitung & Tampilkan Rekap Saro
                  Panca
                </button>
              </div>
            </form>
          </div>
          <!-- Output Section (Struk) -->
          <div id="gajiOutputSection" class="hidden mt-8">
            <div id="gajiStrukContainer" class="mx-auto">
              <div class="gaji-struk-content">
                <div class="gaji-struk-header">
                  <h2>REKAP SARO PANCA</h2>
                  <div class="gaji-struk-header-divider"></div>
                </div>

                <div class="gaji-struk-info">
                  <p><span>Periode</span><span id="strukPeriodeGaji"></span></p>
                  <p>
                    <span>No. Plat</span><strong id="strukNoPlatGaji"></strong>
                  </p>
                  <p>
                    <span>Rate/Karung</span
                    ><strong id="strukRatePerKarungGaji"></strong>
                  </p>
                  <p>
                    <span>Total Ritase</span
                    ><span id="strukTotalRitaseGaji"></span>
                  </p>

                  <p>
                    <span>Total Gabah</span>
                    <strong id="strukTotalKarungKeseluruhanGaji"></strong>
                  </p>
                  <p>
                    <span>Total Gaji</span>
                    <strong
                      id="strukTotalGajiKeseluruhan"
                      style="font-size: 1.1em"
                    ></strong>
                  </p>
                </div>

                <div class="gaji-struk-divider"></div>

                <div id="strukBuruhDetailsContainer"></div>

                <div class="gaji-struk-final-footer">
                  <div id="gajiStrukCatatanSection"></div>
                </div>
              </div>
            </div>

            <div class="print-button-container">
              <button
                id="saveGajiStrukAsJpgButton"
                class="w-full max-w-sm btn btn-secondary"
              >
                <i class="fas fa-file-image mr-2"></i>Simpan Rekap Saro Panca
                (JPG)
              </button>
            </div>
          </div>
        </div>
        <!-- ===== BAGIAN 5: Kalkulator Saro (MODUL BARU) ===== -->
        <div id="kalkulator-saro-app" class="main-app-section">
          <div
            class="container mx-auto max-w-4xl form-card p-6 sm:p-10 rounded-xl shadow-lg"
          >
            <div class="form-header-container">
              <h1 class="form-title">
                <i class="fas fa-calculator mr-3"></i>Kalkulator Saro
              </h1>
              <button
                id="resetSaroButton"
                title="Hapus semua input pada form ini"
                class="reset-form-button"
              >
                <i class="fas fa-eraser"></i>Reset
              </button>
            </div>

            <form id="kalkulatorSaroForm" class="space-y-8">
              <div class="form-input-group">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="saroTanggalMulai" class="input-label"
                      >Tanggal Mulai</label
                    >
                    <input
                      type="date"
                      id="saroTanggalMulai"
                      required
                      class="form-input"
                    />
                  </div>
                  <div>
                    <label for="saroTanggalSelesai" class="input-label"
                      >Tanggal Selesai</label
                    >
                    <input
                      type="date"
                      id="saroTanggalSelesai"
                      required
                      class="form-input"
                    />
                  </div>
                  <div>
                    <label for="saroTarifTimbang" class="input-label"
                      >Tarif Saro Timbang (Rp / Kg)</label
                    >
                    <input
                      type="number"
                      id="saroTarifTimbang"
                      value="100"
                      required
                      class="form-input"
                    />
                  </div>
                  <div>
                    <label for="saroTarifAngkut" class="input-label"
                      >Tarif Saro Mobil (Rp / Kg)</label
                    >
                    <input
                      type="number"
                      id="saroTarifAngkut"
                      value="125"
                      required
                      class="form-input"
                    />
                  </div>
                </div>
              </div>

              <div
                class="border-t pt-6"
                style="border-color: var(--border-color)"
              >
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-xl font-semibold">
                    Rincian Berat per Faktur/Muatan
                  </h2>
                  <div class="flex items-center gap-2">
                    <input
                      type="number"
                      id="saroAddAmount"
                      class="form-input w-20 text-center"
                      placeholder="Jml"
                      min="1"
                    />
                    <button
                      type="button"
                      id="addSaroDataBtn"
                      class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md shadow-sm btn btn-secondary"
                    >
                      <i class="fas fa-plus mr-2"></i>Tambah
                    </button>
                  </div>
                </div>
                <div
                  id="rincianBeratContainer"
                  class="space-y-3 max-h-60 overflow-y-auto pr-2 border rounded-md p-4 bg-gray-50/50"
                >
                  <!-- Input dinamis akan ditambahkan di sini -->
                </div>
              </div>

              <!-- Input Catatan Dinamis -->
              <div
                class="border-t pt-6"
                style="border-color: var(--border-color)"
              >
                <button
                  type="button"
                  id="addCatatanBtn_Saro"
                  class="w-full text-left text-blue-600 hover:text-blue-800 text-sm font-medium"
                >
                  <i class="fas fa-plus mr-2"></i>Tambah Catatan
                </button>
                <div id="catatanInputWrapper_Saro" class="hidden">
                  <div class="catatan-input-wrapper">
                    <label for="saroCatatanInput" class="input-label"
                      >Catatan Struk (Opsional)</label
                    >
                    <textarea
                      id="saroCatatanInput"
                      class="form-textarea"
                      placeholder="Ketik catatan yang akan ditampilkan di struk..."
                    ></textarea>
                    <button
                      type="button"
                      title="Hapus Catatan"
                      class="remove-catatan-btn removeCatatanBtn_Saro"
                    >
                      &times;
                    </button>
                  </div>
                </div>
              </div>

              <div class="pt-6">
                <button
                  type="submit"
                  class="w-full py-3 px-4 text-base rounded-md shadow-sm font-semibold btn btn-primary"
                >
                  <i class="fas fa-cogs mr-2"></i>Hitung & Buat Rekap
                </button>
              </div>
            </form>
          </div>

          <!-- Output Struk -->
          <div id="output-kalkulator-jasa" class="hidden mt-10">
            <div id="strukJasaContainer">
              <div class="struk-header">
                <h2>Rekap Saro</h2>
                <p id="strukPeriode" class="text-sm text-center"></p>
              </div>
              <div class="struk-divider"></div>
              <div class="struk-body">
                <div class="struk-info-item">
                  <span class="label">Tarif Saro Timbang:</span>
                  <span id="strukTarifTimbang" class="value"></span>
                </div>
                <div class="struk-info-item">
                  <span class="label">Tarif Saro Mobil:</span>
                  <span id="strukTarifAngkut" class="value"></span>
                </div>
                <div class="struk-divider"></div>
                <div class="struk-info-item">
                  <span class="label">Total Nota:</span>
                  <span
                    id="strukTotalMuatan"
                    class="value summary-value"
                  ></span>
                </div>
                <div class="struk-info-item">
                  <span class="label">Total Muatan:</span>
                  <span id="strukTotalBerat" class="value summary-value"></span>
                </div>
              </div>
              <div class="struk-divider"></div>
              <div class="struk-results">
                <div class="struk-result-item">
                  <span class="label">Saro Timbang</span>
                  <span id="strukHasilTimbang" class="value"></span>
                </div>
                <div class="struk-result-item">
                  <span class="label">Saro Mobil</span>
                  <span id="strukHasilAngkut" class="value"></span>
                </div>
                <div class="struk-result-item total mt-4 bg-red-50">
                  <span class="label">Total</span>
                  <span id="strukHasilTotal" class="value"></span>
                </div>
              </div>
              <div id="saroStrukCatatanSection"></div>
            </div>
            <div class="mt-6 text-center">
              <button
                id="simpanJpgBtn"
                class="w-full max-w-sm btn btn-secondary"
              >
                <i class="fas fa-file-image mr-2"></i>Simpan Rekap (JPG)
              </button>
            </div>
          </div>
        </div>

        <!-- ===== BAGIAN 6: Rekap Laporan (MODUL DIPERBARUI) ===== -->
        <div id="rekap-laporan-app" class="main-app-section">
          <section class="history-section bg-gray-50">
            <div
              class="flex flex-col items-center justify-center gap-4 text-center"
            >
              <div>
                <h3 class="text-2xl font-bold text-gray-800">
                  Manajemen Data Riwayat
                </h3>
                <p class="text-lg text-gray-500">
                  Simpan semua data riwayat ke dalam file, atau pulihkan dari
                  file cadangan.
                </p>
              </div>
              <div class="flex flex-wrap justify-center gap-3">
                <button id="exportHistoryButton" class="btn btn-primary">
                  <i class="fas fa-file-export mr-2"></i>Cadangkan Riwayat
                  (JSON)
                </button>
                <button id="importHistoryButton" class="btn btn-secondary">
                  <i class="fas fa-file-import mr-2"></i>Pulihkan Riwayat (JSON)
                </button>
                <button
                  id="nukeHistoryButton"
                  class="btn btn-danger"
                  style="background-color: #dc2626; color: white"
                >
                  <i class="fas fa-bomb mr-2"></i>Hapus Semua Data
                </button>

                <input
                  type="file"
                  id="importFileInput"
                  class="hidden"
                  accept="application/json"
                />
              </div>
            </div>
          </section>
          >
          <!-- Riwayat Catatan Timbangan -->
          <section class="history-section">
            <div class="history-header">
              <h2 class="history-title">
                <i class="fas fa-weight-scale mr-3"></i>Riwayat Catatan
                Timbangan
              </h2>
              <div class="history-actions flex items-center gap-3">
                <button
                  class="btn btn-secondary export-txt-btn"
                  data-history-key="catatanTimbangan"
                >
                  <i class="fas fa-file-alt mr-2"></i>Simpan Laporan (.txt)
                </button>
                <button
                  class="btn btn-danger delete-history-btn"
                  data-history-key="catatanTimbangan"
                >
                  <i class="fas fa-trash-alt mr-2"></i>Hapus Riwayat
                </button>
              </div>
            </div>
            <div class="history-table-wrapper">
              <table id="historyTableCatatanTimbangan" class="history-table">
                <thead>
                  <tr>
                    <th>Tgl Simpan</th>
                    <th>Tgl Muat</th>
                    <th>No. Plat</th>
                    <th>Total Muatan</th>
                    <th>Rincian Owners</th>
                    <th class="col-center">Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div
              id="noHistoryCatatanTimbangan"
              class="no-history-message hidden"
            >
              <p>Belum ada riwayat Catatan Timbangan yang tersimpan.</p>
            </div>
          </section>

          <!-- Riwayat Nota Pembayaran -->
          <section class="history-section">
            <div class="history-header">
              <h2 class="history-title">
                <i class="fas fa-file-invoice-dollar mr-3"></i>Riwayat Nota
                Pembayaran
              </h2>
              <div class="history-actions flex items-center gap-3">
                <button
                  class="btn btn-secondary export-txt-btn"
                  data-history-key="notaPembayaran"
                >
                  <i class="fas fa-file-alt mr-2"></i>Simpan Laporan (.txt)
                </button>
                <button
                  class="btn btn-danger delete-history-btn"
                  data-history-key="notaPembayaran"
                >
                  <i class="fas fa-trash-alt mr-2"></i>Hapus Riwayat
                </button>
              </div>
            </div>
            <div class="history-table-wrapper">
              <table id="historyTableNotaPembayaran" class="history-table">
                <thead>
                  <tr>
                    <th>Tgl Simpan</th>
                    <th>Tgl Nota</th>
                    <th>Nama Owner</th>
                    <th class="col-right">Total Pembayaran</th>
                    <th class="col-center">Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="noHistoryNotaPembayaran" class="no-history-message hidden">
              <p>Belum ada riwayat Nota Pembayaran yang tersimpan.</p>
            </div>
          </section>

          <!-- Riwayat Rekap Muatan -->
          <section class="history-section">
            <div class="history-header">
              <h2 class="history-title">
                <i class="fas fa-truck-pickup mr-3"></i>Riwayat Rekap Muatan
              </h2>
              <div class="history-actions flex items-center gap-3">
                <button
                  class="btn btn-secondary export-txt-btn"
                  data-history-key="rekapMuatan"
                >
                  <i class="fas fa-file-alt mr-2"></i>Simpan Laporan (.txt)
                </button>
                <button
                  class="btn btn-danger delete-history-btn"
                  data-history-key="rekapMuatan"
                >
                  <i class="fas fa-trash-alt mr-2"></i>Hapus Riwayat
                </button>
              </div>
            </div>
            <div class="history-table-wrapper">
              <table id="historyTableRekapMuatan" class="history-table">
                <thead>
                  <tr>
                    <th>Tgl Simpan</th>
                    <th>Periode</th>
                    <th>No. Plat</th>
                    <th class="col-center">Total Rut/Faktur</th>
                    <th class="col-center">Total Muatan</th>
                    <th class="col-right">Total Jasa Saro</th>
                    <th class="col-center">Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="noHistoryRekapMuatan" class="no-history-message hidden">
              <p>Belum ada riwayat Rekap Muatan yang tersimpan.</p>
            </div>
          </section>

          <!-- Riwayat Rekap Gaji -->
          <section class="history-section">
            <div class="history-header">
              <h2 class="history-title">
                <i class="fas fa-users mr-3"></i>Riwayat Rekap Saro Panca
              </h2>
              <div class="history-actions flex items-center gap-3">
                <button
                  class="btn btn-secondary export-txt-btn"
                  data-history-key="rekapGaji"
                >
                  <i class="fas fa-file-alt mr-2"></i>Simpan Laporan (.txt)
                </button>
                <button
                  class="btn btn-danger delete-history-btn"
                  data-history-key="rekapGaji"
                >
                  <i class="fas fa-trash-alt mr-2"></i>Hapus Riwayat
                </button>
              </div>
            </div>
            <div class="history-table-wrapper">
              <table id="historyTableRekapGaji" class="history-table">
                <thead>
                  <tr>
                    <th>Tgl Simpan</th>
                    <th>Periode</th>
                    <th>No. Plat</th>
                    <th class="col-center">Total Rit</th>
                    <th>Rincian Saro Buruh</th>
                    <th class="col-right">Total Gaji</th>
                    <th class="col-center">Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="noHistoryRekapGaji" class="no-history-message hidden">
              <p>Belum ada riwayat Rekap Gaji yang tersimpan.</p>
            </div>
          </section>

          <!-- Riwayat Kalkulator Saro -->
          <section class="history-section">
            <div class="history-header">
              <h2 class="history-title">
                <i class="fas fa-calculator mr-3"></i>Riwayat Kalkulator Saro
              </h2>
              <div class="history-actions flex items-center gap-3">
                <button
                  class="btn btn-secondary export-txt-btn"
                  data-history-key="kalkulatorSaro"
                >
                  <i class="fas fa-file-alt mr-2"></i>Simpan Laporan (.txt)
                </button>
                <button
                  class="btn btn-danger delete-history-btn"
                  data-history-key="kalkulatorSaro"
                >
                  <i class="fas fa-trash-alt mr-2"></i>Hapus Riwayat
                </button>
              </div>
            </div>
            <div class="history-table-wrapper">
              <table id="historyTableKalkulatorSaro" class="history-table">
                <thead>
                  <tr>
                    <th>Tgl Simpan</th>
                    <th>Periode</th>
                    <th class="col-right">Total Muatan</th>
                    <th class="col-right">Total Saro</th>
                    <th class="col-center">Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="noHistoryKalkulatorSaro" class="no-history-message hidden">
              <p>Belum ada riwayat Kalkulator Saro yang tersimpan.</p>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- ===== Footnote ===== -->
    <footer class="main-footer">
      <div class="footer-content">
        <span>Powered by <strong>Gemini AI</strong></span>
        <span>.2025 <strong>Asdar Family</strong></span>
      </div>
    </footer>

    <!-- ===== SCRIPT JAVASCRIPT ===== -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- FUNGSI BANTUAN UNTUK LOADING BUTTON ---
        function showLoading(button) {
          button.dataset.originalHtml = button.innerHTML;
          button.disabled = true;
          button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...`;
        }

        function hideLoading(button) {
          if (button.dataset.originalHtml) {
            button.innerHTML = button.dataset.originalHtml;
          }
          button.disabled = false;
        }

        // --- Sistem Riwayat Global ---
        const HISTORY_STORAGE_KEY = "portalGabahHistory";

        const historyManager = {
          getHistory: () => {
            const history = localStorage.getItem(HISTORY_STORAGE_KEY);
            return history
              ? JSON.parse(history)
              : {
                  catatanTimbangan: [],
                  notaPembayaran: [],
                  rekapMuatan: [],
                  rekapGaji: [],
                  kalkulatorSaro: [],
                };
          },
          saveHistory: (historyData) => {
            localStorage.setItem(
              HISTORY_STORAGE_KEY,
              JSON.stringify(historyData)
            );
          },
          addEntry: (key, entryData) => {
            const history = historyManager.getHistory();
            if (!history[key]) {
              history[key] = [];
            }

            const newEntry = {
              id: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
              timestamp: new Date().toISOString(),
              ...entryData,
            };
            history[key].push(newEntry);

            // --- LOGIKA LIMIT 50 DATA ---
            if (history[key].length >= 50) {
              // 1. Buat nama file otomatis
              const today = new Date().toISOString().split("T")[0];
              const fileName = `AUTO_BACKUP_${key}_${today}.json`;

              // 2. Download data secara otomatis
              const jsonString = JSON.stringify(history[key], null, 2);
              const blob = new Blob([jsonString], { type: "application/json" });
              const link = document.createElement("a");
              link.href = URL.createObjectURL(blob);
              link.download = fileName;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

              // 3. Kosongkan riwayat di local storage
              history[key] = [];

              // 4. Beri notifikasi
              alert(
                `Penyimpanan '${key}' telah mencapai batas 50 riwayat.\n\nSistem telah otomatis mengunduh cadangan data dan mengosongkan penyimpanan lokal agar aplikasi tetap ringan.`
              );
            }
            // -----------------------------

            historyManager.saveHistory(history);
          },
          deleteEntry: (key, id) => {
            // PERUBAHAN: Fungsi baru untuk hapus per baris
            if (
              confirm(
                "Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan."
              )
            ) {
              const history = historyManager.getHistory();
              if (history[key]) {
                history[key] = history[key].filter((entry) => entry.id !== id);
                historyManager.saveHistory(history);
                renderAllHistory();
              }
            }
          },
          deleteHistory: (key) => {
            if (
              confirm(
                `Apakah Anda yakin ingin menghapus SEMUA riwayat untuk kategori ini? Tindakan ini tidak dapat dibatalkan.`
              )
            ) {
              const history = historyManager.getHistory();
              history[key] = [];
              historyManager.saveHistory(history);
              renderAllHistory(); // Re-render to show empty state
            }
          },
        };

        // Membuat historyManager global agar bisa diakses dari HTML (onclick)
        window.historyManager = historyManager;

        // --- Navigasi Global & Fungsi Bantuan ---
        const utilitasNavCard = document.getElementById("utilitas-nav-card");
        const utilitasSubmenu = document.getElementById("utilitas-submenu");

        window.showMainSection = function (id) {
          document
            .querySelectorAll(".main-app-section")
            .forEach((el) => el.classList.remove("active"));
          document.getElementById(id).classList.add("active");

          document
            .querySelectorAll(".main-nav-card")
            .forEach((card) => card.classList.remove("active"));

          const isUtilitasModule =
            id === "kalkulator-saro-app" || id === "rekap-laporan-app";

          if (isUtilitasModule) {
            utilitasNavCard.classList.add("active");
            utilitasSubmenu.classList.add("hidden"); // Sembunyikan submenu setelah pilihan dibuat
          } else {
            const selectedCard = document.querySelector(
              `.main-nav-card[onclick*="'${id}'"]`
            );
            if (selectedCard) {
              selectedCard.classList.add("active");
            }
          }

          if (id === "rekap-laporan-app") {
            renderAllHistory();
          }
        };

        // --- Logika Menu Utilitas ---
        utilitasNavCard.addEventListener("click", (event) => {
          event.stopPropagation();
          utilitasSubmenu.classList.toggle("hidden");
        });

        document.addEventListener("click", (event) => {
          if (!utilitasNavCard.parentElement.contains(event.target)) {
            utilitasSubmenu.classList.add("hidden");
          }
        });

        function formatAngka(angka) {
          const num = parseFloat(angka);
          if (Number.isInteger(num)) return num.toString();
          let s = num.toFixed(2);
          if (s.endsWith(".00")) return s.substring(0, s.length - 3);
          if (s.endsWith("0")) return s.substring(0, s.length - 1);
          return s;
        }

        function formatRupiah(angka, prefix = "Rp ") {
          return (
            prefix +
            new Intl.NumberFormat("id-ID", { minimumFractionDigits: 0 }).format(
              angka
            )
          );
        }

        function getTodayDateString() {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, "0");
          const day = String(today.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        function formatTanggalDariISO(isoString) {
          if (!isoString) return "-";
          const date = new Date(isoString);
          return (
            date.toLocaleDateString("id-ID", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            }) +
            " " +
            date.toLocaleTimeString("id-ID", {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
        }

        function formatTanggalInput(dateString) {
          if (!dateString) return "-";
          const [year, month, day] = dateString.split("-");
          return `${day}/${month}/${year}`;
        }

        let printCounters = {
          date: "",
          ct_np: 0,
        };

        function getPrintCount(currentDate) {
          // currentDate format: YYYY-MM-DD
          if (currentDate !== printCounters.date) {
            printCounters.date = currentDate;
            printCounters.ct_np = 1;
          } else {
            printCounters.ct_np++;
          }
          return printCounters.ct_np;
        }

        function formatDateForFilename(dateString) {
          // YYYY-MM-DD -> YYMMDD
          if (!dateString) return "";
          const [year, month, day] = dateString.split("-");
          return `${year.slice(-2)}${month}${day}`;
        }

        // Fungsi untuk menampilkan catatan (sistem standar)
        function displayCatatanOnStruk(
          containerElement,
          catatanText,
          dividerClass = "receipt-divider"
        ) {
          containerElement.innerHTML = "";
          if (catatanText && catatanText.trim() !== "") {
            const divider = document.createElement("div");
            divider.className = dividerClass;

            const catatanWrapper = document.createElement("div");
            catatanWrapper.className = "struk-catatan-section";
            catatanWrapper.innerHTML = `
                        <p class="catatan-title">CATATAN:</p>
                        <p class="catatan-content">${catatanText}</p>
                    `;

            containerElement.appendChild(divider);
            containerElement.appendChild(catatanWrapper);
          }
        }

        // Fungsi untuk menampilkan catatan (sistem hybrid)
        function displayHybridCatatanOnStruk(
          containerElement,
          catatanText,
          dividerClass = "nota-divider"
        ) {
          containerElement.innerHTML = "";
          let emptyLinesHTML = "";
          const catatanTitle = '<p class="catatan-title">CATATAN:</p>';
          let catatanContent = "";
          const emptyLineStyle =
            'style="font-size: 12px; line-height: 1.3; height: 1em;"';

          if (catatanText && catatanText.trim() !== "") {
            catatanContent = `<p class="catatan-content" style="white-space: pre-wrap; word-wrap: break-word;">${catatanText}</p>`;
            for (let i = 0; i < 3; i++) {
              emptyLinesHTML += `<div ${emptyLineStyle}>&nbsp;</div>`;
            }
          } else {
            for (let i = 0; i < 3; i++) {
              emptyLinesHTML += `<div ${emptyLineStyle}>&nbsp;</div>`;
            }
          }

          const divider = document.createElement("div");
          divider.className = dividerClass;

          const catatanWrapper = document.createElement("div");
          catatanWrapper.className = "struk-catatan-section";
          catatanWrapper.innerHTML =
            catatanTitle + catatanContent + emptyLinesHTML;

          containerElement.appendChild(divider);
          containerElement.appendChild(catatanWrapper);
        }

        // Fungsi setup untuk catatan dinamis
        function setupDynamicCatatan(
          appContainer,
          moduleSuffix,
          saveDataCallback
        ) {
          const addBtn = appContainer.querySelector(
            `#addCatatanBtn_${moduleSuffix}`
          );
          const wrapper = appContainer.querySelector(
            `#catatanInputWrapper_${moduleSuffix}`
          );
          const textarea = wrapper.querySelector("textarea");
          const removeBtn = wrapper.querySelector(
            `.removeCatatanBtn_${moduleSuffix}`
          );

          addBtn.addEventListener("click", () => {
            addBtn.classList.add("hidden");
            wrapper.classList.remove("hidden");
            textarea.focus();
          });

          removeBtn.addEventListener("click", () => {
            textarea.value = "";
            wrapper.classList.add("hidden");
            addBtn.classList.remove("hidden");
            if (saveDataCallback) saveDataCallback();
          });
        }

        // ===== FUNGSI UPDATE DISPLAY TERPUSAT (LOKASI BARU YANG BENAR) =====

        /**
         * Fungsi ini menghitung total berat & karung dari sebuah kontainer input
         * dan mengupdate elemen display yang sesuai.
         */
        function updateSummaryDisplay(container, displayElement) {
          if (!container || !displayElement)
            return { totalBerat: 0, totalKarung: 0 };

          const allInputs = container.querySelectorAll('input[type="number"]');
          let totalBerat = 0;
          let totalKarung = 0;

          allInputs.forEach((input) => {
            const berat = parseFloat(input.value);
            if (!isNaN(berat) && berat > 0) {
              totalBerat += berat;
              totalKarung++;
            }
          });

          if (totalKarung > 0) {
            displayElement.innerHTML = `
            <div>
                <span class="value">${formatAngka(
                  totalBerat
                )}</span><span class="unit">Kg</span>
            </div>
            <div>
                <span class="value">${totalKarung}</span><span class="unit">K</span>
            </div>
        `;
          } else {
            displayElement.innerHTML = ""; // Kosongkan jika tidak ada input
          }

          return { totalBerat, totalKarung };
        }

        // GANTI SELURUH FUNGSI INI DENGAN VERSI YANG LEBIH SEDERHANA
        function updateAllCatatanDisplays() {
          const appContainer = document.getElementById("catatan-timbangan-app");
          const ownersListContainer = document.getElementById(
            "ownersListContainer"
          );
          const allOwnerSections =
            ownersListContainer.querySelectorAll(".owner-section");
          const grandTotalDisplay = document.getElementById(
            "catatanGrandTotalDisplay"
          );

          const potonganNormalKg =
            parseFloat(
              appContainer.querySelector("#potonganNormalCatatan").value
            ) || 0;
          const potonganAbnormalKg =
            parseFloat(
              appContainer.querySelector("#potonganAbnormalCatatan").value
            ) || 0;

          let grandTotalBeratBersih = 0;
          let grandTotalKarung = 0;

          const calculateGrossTotals = (container) => {
            let totalBerat = 0,
              totalKarung = 0;
            const allInputs = container.querySelectorAll(
              'input[type="number"]'
            );
            allInputs.forEach((input) => {
              const berat = parseFloat(input.value);
              if (!isNaN(berat) && berat > 0) {
                totalBerat += berat;
                totalKarung++;
              }
            });
            return { totalBerat, totalKarung };
          };

          allOwnerSections.forEach((section) => {
            const ownerId = section.dataset.ownerId;

            // Kalkulasi untuk Gabah Normal (tanpa update display-nya)
            const normalContainer = section.querySelector(
              ".owner-sacks-normal"
            );
            const normalGross = calculateGrossTotals(normalContainer);
            const normalPotongan = normalGross.totalKarung * potonganNormalKg;
            const normalNet = normalGross.totalBerat - normalPotongan;

            // Kalkulasi untuk Gabah T. Normal (tanpa update display-nya)
            const abnormalContainer = section.querySelector(
              ".owner-sacks-abnormal"
            );
            const abnormalGross = calculateGrossTotals(abnormalContainer);
            const abnormalPotongan =
              abnormalGross.totalKarung * potonganAbnormalKg;
            const abnormalNet = abnormalGross.totalBerat - abnormalPotongan;

            // Hitung dan update total BERSIH per-owner (ini tetap ada)
            const ownerTotalBeratBersih = normalNet + abnormalNet;
            const ownerTotalKarung =
              normalGross.totalKarung + abnormalGross.totalKarung;
            const ownerSummaryDisplay = section.querySelector(
              `#ownerSummaryDisplay_${ownerId}`
            );
            if (ownerTotalKarung > 0) {
              ownerSummaryDisplay.innerHTML = ` ${formatAngka(
                ownerTotalBeratBersih
              )} Kg | ${ownerTotalKarung} K `;
            } else {
              ownerSummaryDisplay.innerHTML = "";
            }

            // Akumulasi untuk Grand Total BERSIH
            grandTotalBeratBersih += ownerTotalBeratBersih;
            grandTotalKarung += ownerTotalKarung;
          });

          // Update display Grand Total (ini tetap ada)
          if (grandTotalKarung > 0) {
            grandTotalDisplay.classList.remove("hidden");
            grandTotalDisplay.innerHTML = `
            <span class="total-label">Total Muatan Saat Ini</span>
            <span class="total-value">${formatAngka(
              grandTotalBeratBersih
            )} Kg  |  ${grandTotalKarung} Karung</span>
        `;
          } else {
            grandTotalDisplay.classList.add("hidden");
          }
        }

        // GANTI SELURUH FUNGSI INI DENGAN VERSI BARU
        function updateAllNotaDisplays() {
          const appContainer = document.getElementById("nota-pembayaran-app");

          // Fungsi bantuan untuk menghitung total kotor
          const calculateGrossTotals = (container) => {
            let totalBerat = 0,
              totalKarung = 0;
            const allInputs = container.querySelectorAll(
              'input[type="number"]'
            );
            allInputs.forEach((input) => {
              const berat = parseFloat(input.value);
              if (!isNaN(berat) && berat > 0) {
                totalBerat += berat;
                totalKarung++;
              }
            });
            return { totalBerat, totalKarung };
          };

          // Ambil nilai potongan saat ini
          const potonganNormalKg =
            parseFloat(
              appContainer.querySelector("#formPotonganNormal").value
            ) || 0;
          const potonganTidakNormalKg =
            parseFloat(
              appContainer.querySelector("#formPotonganTidakNormal").value
            ) || 0;

          // Hitung total kotor
          const normalContainer = document.getElementById(
            "dynamicSackInputsNormalContainer"
          );
          const normalGross = calculateGrossTotals(normalContainer);
          const abnormalContainer = document.getElementById(
            "dynamicSackInputsTidakNormalContainer"
          );
          const abnormalGross = calculateGrossTotals(abnormalContainer);

          // Hitung total bersih untuk Grand Total
          const totalPotongan =
            normalGross.totalKarung * potonganNormalKg +
            abnormalGross.totalKarung * potonganTidakNormalKg;
          const grandTotalBeratKotor =
            normalGross.totalBerat + abnormalGross.totalBerat;
          const grandTotalBeratBersih = grandTotalBeratKotor - totalPotongan;
          const grandTotalKarung =
            normalGross.totalKarung + abnormalGross.totalKarung;

          // Update display Grand Total
          const grandTotalDisplay = document.getElementById(
            "notaGrandTotalDisplay"
          );
          if (grandTotalKarung > 0) {
            grandTotalDisplay.classList.remove("hidden");
            grandTotalDisplay.innerHTML = `
            <span class="total-label">Total Gabah Saat Ini</span>
            <span class="total-value">${formatAngka(
              grandTotalBeratBersih
            )} Kg  |  ${grandTotalKarung} Karung</span>
        `;
          } else {
            grandTotalDisplay.classList.add("hidden");
          }
        }

        // ===== FUNGSI BARU UNTUK SHARE GAMBAR =====
        async function shareImage(canvas, fileName, title) {
          // Cek apakah browser mendukung Web Share API
          if (!navigator.share || !navigator.canShare) {
            console.log("Web Share API tidak didukung di browser ini.");
            return; // Keluar dari fungsi jika tidak didukung
          }

          // Konversi canvas (gambar struk) menjadi format file
          const blob = await new Promise((resolve) =>
            canvas.toBlob(resolve, "image/jpeg")
          );
          const file = new File([blob], fileName, { type: "image/jpeg" });
          const filesArray = [file];

          // Cek apakah browser bisa membagikan file ini
          if (navigator.canShare({ files: filesArray })) {
            try {
              // Buka dialog "Share" dari sistem operasi
              await navigator.share({
                files: filesArray,
                title: title,
                text: `Struk ${title}`,
              });
              console.log("Gambar berhasil dibagikan.");
            } catch (error) {
              // Ini terjadi jika pengguna membatalkan dialog share
              console.log("Proses share dibatalkan oleh pengguna.", error);
            }
          } else {
            console.log("Browser ini tidak dapat membagikan jenis file ini.");
          }
        }

        // --- Logika Aplikasi 1: Catatan Timbangan ---
        (function () {
          const appContainer = document.getElementById("catatan-timbangan-app");
          if (!appContainer) return;

          // Variabel utama
          const STORAGE_KEY_CATATAN = "dataCatatanTimbangan";
          const MAX_WEIGHT = 151;
          const gabahForm = appContainer.querySelector("#gabahForm");
          const ownersListContainer = appContainer.querySelector(
            "#ownersListContainer"
          );
          const addOwnerButton = appContainer.querySelector("#addOwnerButton");
          const resetButton = appContainer.querySelector("#resetCatatanButton");
          const catatanOutputSection = appContainer.querySelector(
            "#catatanOutputSection"
          );
          const thermalReceiptContainer = appContainer.querySelector(
            "#thermalReceiptContainer"
          );
          const saveJpgButton = appContainer.querySelector(
            "#saveCatatanAsJpgButton"
          );
          const catatanInput = appContainer.querySelector(
            "#catatanCatatanInput"
          );
          let ownerIdCounter = 0;
          let isLoadingCatatan = false;
          let currentStrukData = {};
          let currentOwnersDataForNota = [];

          // Variabel Sesi Timbang Cepat
          const mainFormContainer = appContainer.querySelector(
            "#mainFormContainerCatatan"
          );
          const quickWeighSessionContainer =
            appContainer.querySelector("#quickWeighSession");
          const quickWeighToggleContainer = appContainer.querySelector(
            "#quickWeighToggleContainer"
          );
          const startQuickWeighButton = appContainer.querySelector(
            "#startQuickWeighButton"
          );
          const finishQuickWeighButton = appContainer.querySelector(
            "#finishQuickWeighButton"
          );
          const cancelQuickWeighButton = appContainer.querySelector(
            "#cancelQuickWeighButton"
          );
          const quickWeighInput =
            appContainer.querySelector("#quickWeighInput");
          const quickWeighOwnerButtonsContainer = appContainer.querySelector(
            "#quickWeighOwnerButtons"
          );
          const quickWeighCategoryButtons =
            quickWeighSessionContainer.querySelectorAll(
              ".quick-weigh-category-btn"
            );
          const quickWeighHistoryContainer =
            appContainer.querySelector("#quickWeighHistory");
          let quickWeighData = [];

          // --- FUNGSI LOCAL STORAGE ---
          function saveDataToLocalStorage() {
            if (isLoadingCatatan) return;
            const ownersData = Array.from(
              ownersListContainer.querySelectorAll(".owner-section")
            ).map((section) => {
              const ownerId = section.dataset.ownerId;
              const nameInput = section.querySelector(
                `input[name="ownerName_${ownerId}"]`
              );

              const getSackValues = (type) => {
                const container = section.querySelector(
                  type === "normal"
                    ? ".owner-sacks-normal"
                    : ".owner-sacks-abnormal"
                );
                return Array.from(
                  container.querySelectorAll(`input[type="number"]`)
                ).map((input) => input.value);
              };

              return {
                name: nameInput ? nameInput.value : "",
                normalSacks: getSackValues("normal"),
                abnormalSacks: getSackValues("abnormal"),
              };
            });

            const data = {
              tanggal: appContainer.querySelector("#tanggal").value,
              noPlat: appContainer.querySelector("#noPlatInput").value,
              lokasi: appContainer.querySelector("#lokasiInput").value,
              ritase: appContainer.querySelector("#ritase").value,
              potonganNormal: appContainer.querySelector(
                "#potonganNormalCatatan"
              ).value,
              potonganAbnormal: appContainer.querySelector(
                "#potonganAbnormalCatatan"
              ).value,
              catatan: catatanInput.value,
              owners: ownersData,
            };

            localStorage.setItem(STORAGE_KEY_CATATAN, JSON.stringify(data));
          }

          function loadDataFromLocalStorage() {
            isLoadingCatatan = true;
            const savedData = localStorage.getItem(STORAGE_KEY_CATATAN);
            if (!savedData) {
              appContainer.querySelector("#tanggal").value =
                getTodayDateString();
              addOwnerSection();
              isLoadingCatatan = false;
              return;
            }

            const data = JSON.parse(savedData);

            appContainer.querySelector("#tanggal").value =
              data.tanggal || getTodayDateString();
            appContainer.querySelector("#noPlatInput").value =
              data.noPlat || "";
            appContainer.querySelector("#lokasiInput").value =
              data.lokasi || "";
            appContainer.querySelector("#ritase").value = data.ritase || "";
            appContainer.querySelector("#potonganNormalCatatan").value =
              data.potonganNormal || "2";
            appContainer.querySelector("#potonganAbnormalCatatan").value =
              data.potonganAbnormal || "0";
            catatanInput.value = data.catatan || "";

            if (catatanInput.value) {
              appContainer
                .querySelector("#addCatatanBtn_Catatan")
                .classList.add("hidden");
              appContainer
                .querySelector("#catatanInputWrapper_Catatan")
                .classList.remove("hidden");
            }

            ownersListContainer.innerHTML = "";
            ownerIdCounter = 0;

            if (data.owners && data.owners.length > 0) {
              data.owners.forEach((owner) => {
                addOwnerSection(owner.name, owner);
              });
            } else {
              addOwnerSection();
            }
            toggleQuickWeighButton();
            updateAllCatatanDisplays();
            isLoadingCatatan = false;
          }

          function resetFormAndStorage() {
            if (
              confirm(
                "Apakah Anda yakin ingin menghapus semua data pada form Catatan Timbangan? Data yang tersimpan akan hilang."
              )
            ) {
              localStorage.removeItem(STORAGE_KEY_CATATAN);
              isLoadingCatatan = true;
              ownersListContainer.innerHTML = "";
              ownerIdCounter = 0;
              gabahForm.reset();
              appContainer.querySelector("#tanggal").value =
                getTodayDateString();

              // Reset catatan UI
              appContainer
                .querySelector("#catatanInputWrapper_Catatan")
                .classList.add("hidden");
              appContainer
                .querySelector("#addCatatanBtn_Catatan")
                .classList.remove("hidden");

              addOwnerSection();
              catatanOutputSection.classList.add("hidden");
              isLoadingCatatan = false;
              saveDataToLocalStorage();
            }
          }

          // --- Fungsi Form Utama ---
          // GANTI SELURUH FUNGSI INI (Catatan Timbangan)
          function addSackInput(
            sacksContainer,
            ownerIdx,
            type,
            weightValue = "",
            autoFocus = false
          ) {
            const sackItem = document.createElement("div");
            sackItem.className = "karung-input-item";
            const weightInput = document.createElement("input");
            Object.assign(weightInput, {
              type: "number",
              name: `ownerSackWeight_${type}_${ownerIdx}[]`,
              placeholder: "Berat (Kg)",
              min: "0",
              step: "0.1",
              className: "form-input w-40",
              value: weightValue,
            });

            // Event listener sederhana: hanya update display & simpan data
            weightInput.addEventListener("input", () => {
              if (parseFloat(weightInput.value) > MAX_WEIGHT) {
                weightInput.style.borderColor = "red";
                weightInput.style.color = "red";
              } else {
                weightInput.style.borderColor = "";
                weightInput.style.color = "";
              }
              updateAllCatatanDisplays();
              saveDataToLocalStorage();
            });

            weightInput.addEventListener("keydown", (e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                if (e.target.value.trim() !== "") {
                  addSackInput(sacksContainer, ownerIdx, type, "", true);
                }
              }
            });

            const removeBtn = document.createElement("button");
            Object.assign(removeBtn, {
              type: "button",
              innerHTML: "&times;",
              className: "text-red-500 hover:text-red-700 p-1 text-2xl",
            });
            removeBtn.onclick = () => {
              if (
                confirm("Apakah Anda yakin ingin menghapus data timbangan ini?")
              )
                sackItem.remove();
              updateSackCounters(sacksContainer);
              saveDataToLocalStorage();
              updateAllCatatanDisplays();
            };

            const counterLabel = document.createElement("span");
            counterLabel.className = "karung-counter-label";

            sackItem.append(counterLabel, weightInput, removeBtn);
            sacksContainer.appendChild(sackItem);
            updateSackCounters(sacksContainer);
            if (autoFocus) weightInput.focus();
          }

          function updateSackCounters(sacksContainer) {
            const sackItems =
              sacksContainer.querySelectorAll(".karung-input-item");
            sackItems.forEach((item, index) => {
              item.querySelector(".karung-counter-label").textContent = `K-${
                index + 1
              }:`;
            });
          }

          function addOwnerSection(name = "", ownerData = null) {
            ownerIdCounter++;
            const sectionDiv = document.createElement("div");
            sectionDiv.className = "owner-section";
            sectionDiv.dataset.ownerId = ownerIdCounter;
            sectionDiv.dataset.ownerName = name.toUpperCase();

            // GANTI SELURUH BLOK innerHTML INI
            sectionDiv.innerHTML = `
    <div class="owner-header">
        <input type="text" name="ownerName_${ownerIdCounter}" placeholder="Nama Pemilik ${ownerIdCounter}" required class="form-input flex-grow" value="${name}">
        <span class="owner-summary-display" id="ownerSummaryDisplay_${ownerIdCounter}"></span>
        <button type="button" class="remove-owner-btn ml-4 px-3 py-1.5 border border-red-500 text-red-500 hover:bg-red-50 text-xs font-medium rounded-md">Hapus</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        
        <div class="gabah-category-section-timbangan">
            <h3 class="gabah-category-title-timbangan text-green-800"><i class="fas fa-check-circle mr-2"></i>Gabah Normal</h3>
            <div class="owner-sacks-container owner-sacks-normal space-y-2"></div>
            <div class="mt-4">
                <button type="button" class="add-sack-btn-normal inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white btn-add-normal">
                    <i class="fas fa-plus mr-1"></i>Tambah
                </button>
            </div>
        </div>

        <div class="gabah-category-section-timbangan">
            <h3 class="gabah-category-title-timbangan text-yellow-800"><i class="fas fa-exclamation-triangle mr-2"></i>Gabah T. Normal</h3>
            <div class="owner-sacks-container owner-sacks-abnormal space-y-2"></div>
            <div class="mt-4">
                 <button type="button" class="add-sack-btn-abnormal inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white btn-add-abnormal">
                     <i class="fas fa-plus mr-1"></i>Tambah
                 </button>
            </div>
        </div>

    </div> `;

            const normalSacksContainer = sectionDiv.querySelector(
              ".owner-sacks-normal"
            );
            const abnormalSacksContainer = sectionDiv.querySelector(
              ".owner-sacks-abnormal"
            );

            sectionDiv.querySelector(".remove-owner-btn").onclick = () => {
              if (
                confirm(
                  "Apakah Anda yakin ingin menghapus data owner ini beserta semua rincian timbangannya?"
                )
              ) {
                sectionDiv.remove();
                toggleQuickWeighButton();
                saveDataToLocalStorage();
                updateAllCatatanDisplays();
              }
            };
            sectionDiv.querySelector(".add-sack-btn-normal").onclick = () =>
              addSackInput(
                normalSacksContainer,
                ownerIdCounter,
                "normal",
                "",
                true
              );
            sectionDiv.querySelector(".add-sack-btn-abnormal").onclick = () =>
              addSackInput(
                abnormalSacksContainer,
                ownerIdCounter,
                "abnormal",
                "",
                true
              );

            const ownerNameInput = sectionDiv.querySelector(
              `input[name^="ownerName_"]`
            );
            ownerNameInput.addEventListener("input", () => {
              sectionDiv.dataset.ownerName = ownerNameInput.value.toUpperCase();
              saveDataToLocalStorage();
            });

            ownersListContainer.appendChild(sectionDiv);

            if (ownerData) {
              if (ownerData.normalSacks && ownerData.normalSacks.length > 0) {
                ownerData.normalSacks.forEach((weight) =>
                  addSackInput(
                    normalSacksContainer,
                    ownerIdCounter,
                    "normal",
                    weight
                  )
                );
              } else {
                addSackInput(
                  normalSacksContainer,
                  ownerIdCounter,
                  "normal",
                  ""
                );
              }
              if (
                ownerData.abnormalSacks &&
                ownerData.abnormalSacks.length > 0
              ) {
                ownerData.abnormalSacks.forEach((weight) =>
                  addSackInput(
                    abnormalSacksContainer,
                    ownerIdCounter,
                    "abnormal",
                    weight
                  )
                );
              }
            } else {
              addSackInput(normalSacksContainer, ownerIdCounter, "normal", "");
            }

            if (!name) {
              sectionDiv.querySelector('input[name^="ownerName_"]').focus();
            }
            toggleQuickWeighButton();
          }

          // Fungsi Sesi Timbang Cepat
          function toggleQuickWeighButton() {
            const ownerCount =
              ownersListContainer.querySelectorAll(".owner-section").length;
            // Logika BARU: hanya muncul jika jumlah owner LEBIH DARI 1
            if (ownerCount > 1) {
              quickWeighToggleContainer.classList.remove("hidden");
            } else {
              quickWeighToggleContainer.classList.add("hidden");
            }
          }

          startQuickWeighButton.addEventListener("click", () => {
            const ownerSections =
              ownersListContainer.querySelectorAll(".owner-section");
            let allNamesValid = true;
            ownerSections.forEach((section) => {
              const nameInput = section.querySelector(
                'input[name^="ownerName_"]'
              );
              if (!nameInput.value.trim()) {
                allNamesValid = false;
                nameInput.focus();
              }
            });

            if (!allNamesValid) {
              alert(
                "Harap isi semua nama pemilik sebelum memulai sesi timbang cepat."
              );
              return;
            }
            saveDataToLocalStorage();
            mainFormContainer.classList.add("hidden");
            quickWeighSessionContainer.classList.remove("hidden");
            quickWeighData = [];
            updateQuickWeighUI();
            quickWeighInput.focus();
          });

          cancelQuickWeighButton.addEventListener("click", () => {
            if (
              quickWeighData.length > 0 &&
              !confirm(
                "Anda memiliki data di sesi ini. Apakah Anda yakin ingin membatalkan? Data akan hilang."
              )
            ) {
              return;
            }
            mainFormContainer.classList.remove("hidden");
            quickWeighSessionContainer.classList.add("hidden");
          });

          finishQuickWeighButton.addEventListener("click", () => {
            const groupedData = quickWeighData.reduce((acc, item) => {
              if (!acc[item.ownerName]) {
                acc[item.ownerName] = { normal: [], abnormal: [] };
              }
              acc[item.ownerName][item.category].push(item.weight);
              return acc;
            }, {});

            Object.keys(groupedData).forEach((ownerName) => {
              const ownerSection = ownersListContainer.querySelector(
                `.owner-section[data-owner-name="${ownerName}"]`
              );
              if (ownerSection) {
                const ownerId = ownerSection.dataset.ownerId;
                const normalContainer = ownerSection.querySelector(
                  ".owner-sacks-normal"
                );
                const abnormalContainer = ownerSection.querySelector(
                  ".owner-sacks-abnormal"
                );

                const firstNormalInput = normalContainer.querySelector("input");
                if (firstNormalInput && !firstNormalInput.value) {
                  firstNormalInput.parentElement.remove();
                  updateSackCounters(normalContainer);
                }
                const firstAbnormalInput =
                  abnormalContainer.querySelector("input");
                if (firstAbnormalInput && !firstAbnormalInput.value) {
                  firstAbnormalInput.parentElement.remove();
                  updateSackCounters(abnormalContainer);
                }

                groupedData[ownerName].normal.forEach((weight) =>
                  addSackInput(normalContainer, ownerId, "normal", weight)
                );
                groupedData[ownerName].abnormal.forEach((weight) =>
                  addSackInput(abnormalContainer, ownerId, "abnormal", weight)
                );
              }
            });

            mainFormContainer.classList.remove("hidden");
            quickWeighSessionContainer.classList.add("hidden");
            saveDataToLocalStorage();
          });

          function updateQuickWeighUI() {
            quickWeighOwnerButtonsContainer.innerHTML = "";
            const ownerSections =
              ownersListContainer.querySelectorAll(".owner-section");
            ownerSections.forEach((section, index) => {
              const name = section
                .querySelector('input[name^="ownerName_"]')
                .value.trim();
              const btn = document.createElement("button");
              btn.type = "button";
              btn.className = "quick-weigh-owner-btn";
              btn.textContent = name;
              btn.dataset.ownerName = name.toUpperCase();
              if (index === 0) btn.classList.add("active");
              btn.onclick = () => {
                quickWeighOwnerButtonsContainer
                  .querySelectorAll(".quick-weigh-owner-btn")
                  .forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                addQuickWeighEntry();
              };
              quickWeighOwnerButtonsContainer.appendChild(btn);
            });

            const totalItems = quickWeighData.length;
            quickWeighHistoryContainer.innerHTML = quickWeighData
              .map((item, index) => {
                const itemNumber = totalItems - index;
                return `<div class="quick-weigh-history-item">
                                    <span><strong>K-${itemNumber}:</strong> ${item.weight} Kg &rarr; ${item.ownerName} (${item.category})</span>
                                    <span class="delete-history-btn" data-index="${index}">[x]</span>
                                </div>`;
              })
              .join("");

            quickWeighHistoryContainer.scrollTop =
              quickWeighHistoryContainer.scrollHeight;
          }

          function addQuickWeighEntry() {
            const weight = parseFloat(quickWeighInput.value);
            if (isNaN(weight) || weight <= 0) return;

            const activeOwnerBtn =
              quickWeighOwnerButtonsContainer.querySelector(
                ".quick-weigh-owner-btn.active"
              );
            const activeCategoryBtn = quickWeighSessionContainer.querySelector(
              ".quick-weigh-category-btn.active"
            );

            if (!activeOwnerBtn || !activeCategoryBtn) {
              alert("Pilih pemilik dan kategori terlebih dahulu.");
              return;
            }

            quickWeighData.unshift({
              weight: weight,
              ownerName: activeOwnerBtn.dataset.ownerName,
              category: activeCategoryBtn.dataset.category,
            });

            quickWeighInput.value = "";
            quickWeighInput.focus();
            updateQuickWeighUI();
          }

          quickWeighHistoryContainer.addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("delete-history-btn")) {
              const index = parseInt(e.target.dataset.index, 10);
              quickWeighData.splice(index, 1);
              updateQuickWeighUI();
            }
          });

          quickWeighInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              addQuickWeighEntry();
            }
          });

          quickWeighCategoryButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              quickWeighCategoryButtons.forEach((b) =>
                b.classList.remove("active")
              );
              btn.classList.add("active");
            });
          });

          // --- Fungsi Struk & Integrasi Nota ---
          function renderBuatNotaButtons() {
            const container = appContainer.querySelector(
              "#buatNotaActionsContainer"
            );
            const buttonWrapper =
              appContainer.querySelector("#buatNotaButtons");
            buttonWrapper.innerHTML = "";

            if (
              currentOwnersDataForNota &&
              currentOwnersDataForNota.length > 0
            ) {
              currentOwnersDataForNota.forEach((owner) => {
                const button = document.createElement("button");
                button.className = "w-full max-w-sm btn btn-primary";
                button.innerHTML = `<i class="fas fa-file-invoice-dollar mr-2"></i>Buat Nota (${owner.name})`;
                button.addEventListener("click", () => {
                  window.populateNotaFromCatatan(owner);
                  showMainSection("nota-pembayaran-app");
                });
                buttonWrapper.appendChild(button);
              });
              container.classList.remove("hidden");
            } else {
              container.classList.add("hidden");
            }
          }

          function renderReceiptWeightColumns(container, weights) {
            container.innerHTML = "";
            if (!weights || weights.length === 0) return;

            const maxItemsPerCol = 5;
            const colsPerRow = 6;
            let columnCount = 0;
            for (let i = 0; i < weights.length; i += maxItemsPerCol) {
              columnCount++;
              if (
                columnCount > colsPerRow &&
                (columnCount - 1) % colsPerRow === 0
              ) {
                const separator = document.createElement("div");
                separator.className = "row-divider";
                container.appendChild(separator);
              }
              const chunk = weights.slice(i, i + maxItemsPerCol);
              const colDiv = document.createElement("div");
              colDiv.className = "receipt-column";
              let colSum = 0;
              for (let j = 0; j < maxItemsPerCol; j++) {
                const p = document.createElement("p");
                p.className = "receipt-item-value";
                if (j < chunk.length) {
                  const sack = chunk[j];
                  p.textContent = formatAngka(sack.weight);
                  if (sack.isOverweight) p.classList.add("overweight");
                  colSum += sack.weight;
                } else {
                  p.textContent = "-";
                  p.classList.add("receipt-item-placeholder");
                }
                colDiv.appendChild(p);
              }
              colDiv.innerHTML += `<p class="receipt-column-separator">---</p><p class="receipt-column-sum">${formatAngka(
                colSum
              )}</p>`;
              container.appendChild(colDiv);
            }
            const totalCols =
              container.querySelectorAll(".receipt-column").length;
            const remainder = totalCols % colsPerRow;
            if (remainder !== 0) {
              for (let i = 0; i < colsPerRow - remainder; i++) {
                const spacer = document.createElement("div");
                spacer.className = "receipt-column-spacer";
                container.appendChild(spacer);
              }
            }
          }

          // GANTI SELURUH BLOK FUNGSI LAMA DENGAN YANG INI
          gabahForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const potonganNormalKg =
              parseFloat(
                appContainer.querySelector("#potonganNormalCatatan").value
              ) || 0;
            const potonganAbnormalKg =
              parseFloat(
                appContainer.querySelector("#potonganAbnormalCatatan").value
              ) || 0;

            const getSacksDataFromSection = (section, type) => {
              const sacks = Array.from(
                section.querySelectorAll(
                  `input[name^="ownerSackWeight_${type}"]`
                )
              )
                .map((input) => {
                  return { weight: parseFloat(input.value) };
                })
                .filter((sack) => !isNaN(sack.weight) && sack.weight > 0);
              return { sacks, totalKarung: sacks.length };
            };

            const ownersData = Array.from(
              ownersListContainer.querySelectorAll(".owner-section")
            )
              .map((section) => {
                const ownerId = section.dataset.ownerId;
                const name = section
                  .querySelector(`input[name="ownerName_${ownerId}"]`)
                  .value.trim();

                const normalDataGross = getSacksDataFromSection(
                  section,
                  "normal"
                );
                const abnormalDataGross = getSacksDataFromSection(
                  section,
                  "abnormal"
                );

                if (
                  !name ||
                  (normalDataGross.totalKarung === 0 &&
                    abnormalDataGross.totalKarung === 0)
                )
                  return null;

                const normalSacksNet = normalDataGross.sacks.map((sack) => ({
                  weight: sack.weight - potonganNormalKg,
                  isOverweight: sack.weight > MAX_WEIGHT,
                }));
                const abnormalSacksNet = abnormalDataGross.sacks.map(
                  (sack) => ({
                    weight: sack.weight - potonganAbnormalKg,
                    isOverweight: sack.weight > MAX_WEIGHT,
                  })
                );

                const totalBeratNormalNet = normalSacksNet.reduce(
                  (sum, s) => sum + s.weight,
                  0
                );
                const totalBeratAbnormalNet = abnormalSacksNet.reduce(
                  (sum, s) => sum + s.weight,
                  0
                );

                return {
                  name: name.toUpperCase(),
                  normal: {
                    sacks: normalSacksNet,
                    totalKarung: normalDataGross.totalKarung,
                    totalBerat: totalBeratNormalNet,
                  },
                  abnormal: {
                    sacks: abnormalSacksNet,
                    totalKarung: abnormalDataGross.totalKarung,
                    totalBerat: totalBeratAbnormalNet,
                  },
                  totalKarung:
                    normalDataGross.totalKarung + abnormalDataGross.totalKarung,
                  totalBerat: totalBeratNormalNet + totalBeratAbnormalNet,
                  gross: {
                    normalSacks: normalDataGross.sacks,
                    abnormalSacks: abnormalDataGross.sacks,
                  },
                };
              })
              .filter(Boolean);

            if (ownersData.length === 0) {
              alert("Tidak ada data gabah yang valid.");
              return;
            }

            thermalReceiptContainer.querySelector("#strukTanggal").textContent =
              formatTanggalInput(appContainer.querySelector("#tanggal").value);
            thermalReceiptContainer.querySelector(
              "#strukNoPlatCatatan"
            ).textContent = appContainer
              .querySelector("#noPlatInput")
              .value.toUpperCase();
            thermalReceiptContainer.querySelector("#strukLokasi").textContent =
              appContainer.querySelector("#lokasiInput").value.toUpperCase();
            thermalReceiptContainer.querySelector("#strukRitase").textContent =
              appContainer.querySelector("#ritase").value;

            const ownersDetailsContainer =
              thermalReceiptContainer.querySelector("#receiptOwnersDetails");
            ownersDetailsContainer.innerHTML = "";

            // --- BLOK RENDER STRUK YANG DIPERBAIKI ---
            ownersData.forEach((owner, idx) => {
              const ownerDiv = document.createElement("div");

              const headerP = document.createElement("p");
              headerP.className = "receipt-owner-header-line";
              headerP.innerHTML = `<span class="owner-name-part">${
                owner.name
              }</span><span class="owner-inline-summary-part">[${formatAngka(
                owner.totalBerat
              )} Kg] [${owner.totalKarung} Karung]</span>`;
              ownerDiv.appendChild(headerP);

              if (owner.normal.sacks.length > 0) {
                if (owner.abnormal.sacks.length > 0) {
                  const titleP = document.createElement("p");
                  titleP.className = "receipt-category-title";
                  titleP.textContent = "Gabah Normal";
                  ownerDiv.appendChild(titleP);
                }
                const itemsContainer = document.createElement("div");
                itemsContainer.className = "receipt-item-columns-container";
                renderReceiptWeightColumns(
                  itemsContainer,
                  owner.gross.normalSacks
                );
                ownerDiv.appendChild(itemsContainer);
              }

              if (owner.abnormal.sacks.length > 0) {
                const titleP = document.createElement("p");
                titleP.className = "receipt-category-title";
                titleP.textContent = "Gabah Tidak Normal";
                ownerDiv.appendChild(titleP);

                const itemsContainer = document.createElement("div");
                itemsContainer.className = "receipt-item-columns-container";
                renderReceiptWeightColumns(
                  itemsContainer,
                  owner.gross.abnormalSacks
                );
                ownerDiv.appendChild(itemsContainer);
              }

              ownersDetailsContainer.appendChild(ownerDiv);
              if (idx < ownersData.length - 1) {
                const divider = document.createElement("div");
                divider.className = "receipt-owner-divider-strong";
                ownersDetailsContainer.appendChild(divider);
              }
            });
            // --- AKHIR BLOK YANG DIPERBAIKI ---

            let grandTotalBeratKotorNormal = 0;
            let grandTotalBeratKotorAbnormal = 0;
            let grandTotalKarungNormal = 0;
            let grandTotalKarungAbnormal = 0;

            ownersData.forEach((owner) => {
              grandTotalKarungNormal += owner.gross.normalSacks.length;
              grandTotalKarungAbnormal += owner.gross.abnormalSacks.length;
              owner.gross.normalSacks.forEach(
                (sack) => (grandTotalBeratKotorNormal += sack.weight)
              );
              owner.gross.abnormalSacks.forEach(
                (sack) => (grandTotalBeratKotorAbnormal += sack.weight)
              );
            });

            const totalPotonganNormal =
              grandTotalKarungNormal * potonganNormalKg;
            const totalPotonganAbnormal =
              grandTotalKarungAbnormal * potonganAbnormalKg;
            const totalBeratBersihNormal =
              grandTotalBeratKotorNormal - totalPotonganNormal;
            const totalBeratBersihAbnormal =
              grandTotalBeratKotorAbnormal - totalPotonganAbnormal;
            const grandTotalBeratBersih =
              totalBeratBersihNormal + totalBeratBersihAbnormal;
            const grandTotalKarung =
              grandTotalKarungNormal + grandTotalKarungAbnormal;

            const summaryEl =
              thermalReceiptContainer.querySelector(".receipt-summary");
            summaryEl.querySelector("#summaryTotalKarung").textContent =
              grandTotalKarung;
            summaryEl.querySelector(
              "#summaryBeratTimbangan"
            ).textContent = `N ${formatAngka(
              grandTotalBeratKotorNormal
            )}Kg | TN ${formatAngka(grandTotalBeratKotorAbnormal)}Kg`;
            summaryEl.querySelector(
              "#summaryPotongan"
            ).textContent = `N ${formatAngka(
              totalPotonganNormal
            )}Kg | TN ${formatAngka(totalPotonganAbnormal)}Kg`;
            summaryEl.querySelector(
              "#summaryBeratBersih"
            ).textContent = `N ${formatAngka(
              totalBeratBersihNormal
            )}Kg | TN ${formatAngka(totalBeratBersihAbnormal)}Kg`;
            summaryEl.querySelector("#summaryGrandTotalBerat").textContent =
              formatAngka(grandTotalBeratBersih);
            summaryEl.querySelector(
              "#summaryGrandTotalKarung"
            ).textContent = `${grandTotalKarung}`;

            currentStrukData = {
              tanggal: appContainer.querySelector("#tanggal").value,
              noPlat: appContainer
                .querySelector("#noPlatInput")
                .value.toUpperCase(),
              lokasi: appContainer
                .querySelector("#lokasiInput")
                .value.toUpperCase(),
              ritase: appContainer.querySelector("#ritase").value,
              grandTotalKarung: grandTotalKarung,
              grandTotalBerat: grandTotalBeratBersih,
              owners: ownersData.map((owner) => ({
                name: owner.name,
                totalBerat: owner.totalBerat,
                totalKarung: owner.totalKarung,
              })),
            };

            currentOwnersDataForNota = ownersData.map((owner) => ({
              name: owner.name,
              tanggal: appContainer.querySelector("#tanggal").value,
              lokasi: appContainer.querySelector("#lokasiInput").value,
              normalSacks: owner.gross.normalSacks.map((s) => s.weight),
              abnormalSacks: owner.gross.abnormalSacks.map((s) => s.weight),
              potonganNormal: potonganNormalKg,
              potonganAbnormal: potonganAbnormalKg,
            }));

            displayCatatanOnStruk(
              thermalReceiptContainer.querySelector("#receiptCatatanSection"),
              catatanInput.value
            );
            catatanOutputSection.classList.remove("hidden");
            renderBuatNotaButtons();
            catatanOutputSection.scrollIntoView({ behavior: "smooth" });
          });

          saveJpgButton.addEventListener("click", function () {
            showLoading(this);
            html2canvas(thermalReceiptContainer, {
              scale: 3,
              backgroundColor: "#ffffff",
              width: 310,
            })
              .then((canvas) => {
                const link = document.createElement("a");

                const tglValue = appContainer.querySelector("#tanggal").value;
                const plat = appContainer
                  .querySelector("#noPlatInput")
                  .value.replace(/\s/g, "");
                const ritase = appContainer.querySelector("#ritase").value;
                const tglFormatted = formatDateForFilename(tglValue);
                const count = getPrintCount(tglValue)
                  .toString()
                  .padStart(3, "0");

                link.download = `CT_${plat}_rit${ritase}_${tglFormatted}${count}.jpg`;

                link.href = canvas.toDataURL("image/jpeg", 0.95);
                link.click();

                historyManager.addEntry("catatanTimbangan", currentStrukData);
              })
              .finally(() => {
                hideLoading(this);
              });
          });

          // Inisialisasi
          setupDynamicCatatan(appContainer, "Catatan", saveDataToLocalStorage);
          appContainer
            .querySelector("#potonganNormalCatatan")
            .addEventListener("input", updateAllCatatanDisplays);
          appContainer
            .querySelector("#potonganAbnormalCatatan")
            .addEventListener("input", updateAllCatatanDisplays);
          gabahForm.addEventListener("input", saveDataToLocalStorage);
          addOwnerButton.addEventListener("click", () => {
            addOwnerSection();
            saveDataToLocalStorage();
          });
          resetButton.addEventListener("click", resetFormAndStorage);
          loadDataFromLocalStorage();
        })();

        // --- Logika Aplikasi 2: Nota Pembayaran ---
        (function () {
          const appContainer = document.getElementById("nota-pembayaran-app");
          if (!appContainer) return;

          // Variabel utama
          const STORAGE_KEY_NOTA = "dataNotaPembayaran";
          const MAX_WEIGHT = 151;
          const pembayaranForm = appContainer.querySelector(
            "#pembayaranGabahForm"
          );
          const resetButton = appContainer.querySelector("#resetNotaButton");
          const saveJpgButton = appContainer.querySelector(
            "#saveNotaAsJpgButton"
          );
          const notaOutputSection =
            appContainer.querySelector("#notaOutputSection");
          const notaContainer = appContainer.querySelector(
            "#notaPembayaranContainer"
          );
          const normalSackContainer = appContainer.querySelector(
            "#dynamicSackInputsNormalContainer"
          );
          const addNormalSackButton = appContainer.querySelector(
            "#addSackNormalButton"
          );
          const tidakNormalSackContainer = appContainer.querySelector(
            "#dynamicSackInputsTidakNormalContainer"
          );
          const addTidakNormalSackButton = appContainer.querySelector(
            "#addSackTidakNormalButton"
          );
          const catatanInput = appContainer.querySelector("#notaCatatanInput");
          let normalSackCounter = 0;
          let tidakNormalSackCounter = 0;
          let isLoadingNota = false;
          let currentStrukData = {};

          // --- FUNGSI LOCAL STORAGE ---
          function saveDataToLocalStorage() {
            if (isLoadingNota) return;
            const getSackValues = (container) => {
              return Array.from(
                container.querySelectorAll('input[type="number"]')
              ).map((input) => input.value);
            };

            const data = {
              tanggal: appContainer.querySelector("#formTanggalNota").value,
              owner: appContainer.querySelector("#formOwner").value,
              hargaNormal: appContainer.querySelector("#formHargaGabahNormal")
                .value,
              hargaTidakNormal: appContainer.querySelector(
                "#formHargaGabahTidakNormal"
              ).value,
              potonganNormal: appContainer.querySelector("#formPotonganNormal")
                .value,
              potonganTidakNormal: appContainer.querySelector(
                "#formPotonganTidakNormal"
              ).value,
              normalSacks: getSackValues(normalSackContainer),
              tidakNormalSacks: getSackValues(tidakNormalSackContainer),
              catatan: catatanInput.value,
            };
            localStorage.setItem(STORAGE_KEY_NOTA, JSON.stringify(data));
          }

          // GANTI SELURUH FUNGSI INI
          function loadDataFromLocalStorage() {
            isLoadingNota = true;
            const savedData = localStorage.getItem(STORAGE_KEY_NOTA);
            if (!savedData) {
              appContainer.querySelector("#formTanggalNota").value =
                getTodayDateString();
              addSackInput(normalSackContainer, "normal");
              updateAllNotaDisplays(); // PERBAIKAN KECIL: Memanggil fungsi yang benar
              isLoadingNota = false;
              return;
            }

            const data = JSON.parse(savedData);
            appContainer.querySelector("#formTanggalNota").value =
              data.tanggal || getTodayDateString();
            appContainer.querySelector("#formOwner").value = data.owner || "";
            appContainer.querySelector("#formHargaGabahNormal").value =
              data.hargaNormal || "";
            appContainer.querySelector("#formHargaGabahTidakNormal").value =
              data.hargaTidakNormal || "";

            // --- PERBAIKAN UTAMA ADA DI SINI ---
            // Menggunakan ?? agar nilai 0 tetap dianggap valid
            appContainer.querySelector("#formPotonganNormal").value =
              data.potonganNormal ?? "0";
            appContainer.querySelector("#formPotonganTidakNormal").value =
              data.potonganTidakNormal ?? "0";
            // --- AKHIR PERBAIKAN ---

            catatanInput.value = data.catatan || "";

            if (catatanInput.value) {
              appContainer
                .querySelector("#addCatatanBtn_Nota")
                .classList.add("hidden");
              appContainer
                .querySelector("#catatanInputWrapper_Nota")
                .classList.remove("hidden");
            }

            normalSackContainer.innerHTML = "";
            tidakNormalSackContainer.innerHTML = "";
            normalSackCounter = 0;
            tidakNormalSackCounter = 0;

            if (data.normalSacks && data.normalSacks.length > 0) {
              data.normalSacks.forEach((val) =>
                addSackInput(normalSackContainer, "normal", false, val)
              );
            } else {
              addSackInput(normalSackContainer, "normal");
            }

            if (data.tidakNormalSacks && data.tidakNormalSacks.length > 0) {
              data.tidakNormalSacks.forEach((val) =>
                addSackInput(
                  tidakNormalSackContainer,
                  "tidak-normal",
                  false,
                  val
                )
              );
            }
            isLoadingNota = false;
          }

          function resetFormAndStorage(force = false) {
            const doReset = () => {
              localStorage.removeItem(STORAGE_KEY_NOTA);
              isLoadingNota = true;
              pembayaranForm.reset();
              normalSackContainer.innerHTML = "";
              tidakNormalSackContainer.innerHTML = "";
              normalSackCounter = 0;
              tidakNormalSackCounter = 0;
              appContainer.querySelector("#formTanggalNota").value =
                getTodayDateString();

              appContainer
                .querySelector("#catatanInputWrapper_Nota")
                .classList.add("hidden");
              appContainer
                .querySelector("#addCatatanBtn_Nota")
                .classList.remove("hidden");

              addSackInput(normalSackContainer, "normal");
              notaOutputSection.classList.add("hidden");
              isLoadingNota = false;
              saveDataToLocalStorage();
              updateAllNotaDisplays();
            };

            if (force) {
              doReset();
            } else {
              if (
                confirm(
                  "Apakah Anda yakin ingin menghapus semua data pada form Nota Pembayaran? Data yang tersimpan akan hilang."
                )
              ) {
                doReset();
              }
            }
          }

          // --- Fungsi Form Utama & Integrasi ---
          function populateForm(data) {
            resetFormAndStorage(true); // Mereset form

            isLoadingNota = true;
            appContainer.querySelector("#formTanggalNota").value = data.tanggal;
            appContainer.querySelector("#formOwner").value = data.name;
            appContainer.querySelector("#formLokasiNota").value = data.lokasi;

            // --- Logika Baru yang Diperbaiki ---
            // 1. Bersihkan semua input default yang mungkin dibuat oleh fungsi reset
            normalSackContainer.innerHTML = "";
            normalSackCounter = 0;
            tidakNormalSackContainer.innerHTML = "";
            tidakNormalSackCounter = 0;

            // 2. Hanya isi slot 'Gabah Normal' jika ada datanya
            if (data.normalSacks && data.normalSacks.length > 0) {
              data.normalSacks.forEach((weight) => {
                addSackInput(normalSackContainer, "normal", false, weight);
              });
            }

            // 3. Hanya isi slot 'Gabah Tdk Normal' jika ada datanya
            if (data.abnormalSacks && data.abnormalSacks.length > 0) {
              data.abnormalSacks.forEach((weight) => {
                addSackInput(
                  tidakNormalSackContainer,
                  "tidak-normal",
                  false,
                  weight
                );
              });
            }

            // 4. Sebagai fallback, jika tidak ada data normal sama sekali, tambahkan satu input kosong
            if (normalSackContainer.children.length === 0) {
              addSackInput(normalSackContainer, "normal");
            }
            // --- Akhir Logika Baru ---

            isLoadingNota = false;
            saveDataToLocalStorage();
          }
          window.populateNotaFromCatatan = populateForm;

          function addSackInput(
            container,
            type,
            autoFocus = false,
            value = ""
          ) {
            let currentCounter;
            if (type === "normal") {
              normalSackCounter++;
              currentCounter = normalSackCounter;
            } else {
              tidakNormalSackCounter++;
              currentCounter = tidakNormalSackCounter;
            }

            const sackItem = document.createElement("div");
            sackItem.className = "sack-input-item";

            const label = document.createElement("label");
            label.textContent = `K-${currentCounter}:`;

            const weightInput = document.createElement("input");
            Object.assign(weightInput, {
              type: "number",
              name: `beratKarung_${type}_${currentCounter}`,
              placeholder: "Berat (Kg)",
              min: "0",
              step: "0.1",
              required: true,
              className: "form-input w-40",
              value: value,
            });

            weightInput.addEventListener("input", () => {
              if (parseFloat(weightInput.value) > MAX_WEIGHT) {
                weightInput.style.borderColor = "red";
                weightInput.style.color = "red";
              } else {
                weightInput.style.borderColor = "";
                weightInput.style.color = "";
              }
              saveDataToLocalStorage();
              updateAllNotaDisplays();
            });
            weightInput.addEventListener("keydown", (e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                if (e.target.value.trim() !== "") {
                  addSackInput(container, type, true);
                }
              }
            });

            const removeBtn = document.createElement("button");
            Object.assign(removeBtn, {
              type: "button",
              innerHTML: "&times;",
              className: "text-red-500 hover:text-red-700 p-1 text-2xl",
            });

            removeBtn.onclick = () => {
              if (
                confirm("Apakah Anda yakin ingin menghapus data timbangan ini?")
              )
                sackItem.remove();
              const allLabels = container.querySelectorAll(
                ".sack-input-item label"
              );
              allLabels.forEach((lbl, index) => {
                lbl.textContent = `K-${index + 1}:`;
              });
              if (type === "normal") {
                normalSackCounter = allLabels.length;
              } else {
                tidakNormalSackCounter = allLabels.length;
              }
              saveDataToLocalStorage();
              updateAllNotaDisplays();
            };

            sackItem.append(label, weightInput, removeBtn);
            container.appendChild(sackItem);
            updateAllNotaDisplays();
            if (autoFocus) weightInput.focus();
          }

          addNormalSackButton.addEventListener("click", () => {
            addSackInput(normalSackContainer, "normal", true);
            saveDataToLocalStorage();
          });
          addTidakNormalSackButton.addEventListener("click", () => {
            addSackInput(tidakNormalSackContainer, "tidak-normal", true);
            saveDataToLocalStorage();
          });

          function formatTanggalNota(tanggalStr) {
            if (!tanggalStr) return "";
            const [year, month, day] = tanggalStr.split("-");
            return new Date(year, month - 1, day).toLocaleDateString("id-ID", {
              day: "numeric",
              month: "long",
              year: "numeric",
            });
          }

          function renderWeightDetails(container, weights) {
            container.innerHTML = "";
            if (weights.length === 0) return;

            const maxItemsPerCol = 5;
            const colsPerRow = 5;
            let columnCount = 0;

            for (let i = 0; i < weights.length; i += maxItemsPerCol) {
              columnCount++;
              if (
                columnCount > colsPerRow &&
                (columnCount - 1) % colsPerRow === 0
              ) {
                const separator = document.createElement("div");
                separator.className = "row-divider";
                container.appendChild(separator);
              }

              const chunk = weights.slice(i, i + maxItemsPerCol);
              const colDiv = document.createElement("div");
              colDiv.className = "detail-column";
              let colSum = 0;
              for (let j = 0; j < maxItemsPerCol; j++) {
                const p = document.createElement("p");
                p.className = "detail-item-value";
                if (j < chunk.length) {
                  const sack = chunk[j];
                  p.textContent = formatAngka(sack.value);
                  if (sack.isOverweight) p.classList.add("overweight");
                  colSum += sack.value;
                } else {
                  p.textContent = "-";
                  p.classList.add("receipt-item-placeholder");
                }
                colDiv.appendChild(p);
              }
              colDiv.innerHTML += `<p class="detail-column-separator">---</p><p class="detail-column-sum">${formatAngka(
                colSum
              )}</p>`;
              container.appendChild(colDiv);
            }
            const totalCols =
              container.querySelectorAll(".detail-column").length;
            const remainder = totalCols % colsPerRow;
            if (remainder !== 0) {
              for (let i = 0; i < colsPerRow - remainder; i++) {
                const spacer = document.createElement("div");
                spacer.className = "detail-column-spacer";
                container.appendChild(spacer);
              }
            }
          }

          // GANTI SELURUH BLOK FUNGSI LAMA DENGAN YANG INI
          pembayaranForm.addEventListener("submit", function (e) {
            e.preventDefault();

            // 1. Baca semua nilai dari form
            const hargaNormal =
              parseFloat(
                appContainer.querySelector("#formHargaGabahNormal").value
              ) || 0;
            const hargaTidakNormal =
              parseFloat(
                appContainer.querySelector("#formHargaGabahTidakNormal").value
              ) || 0;
            const potonganNormalKg =
              parseFloat(
                appContainer.querySelector("#formPotonganNormal").value
              ) || 0;
            const potonganTidakNormalKg =
              parseFloat(
                appContainer.querySelector("#formPotonganTidakNormal").value
              ) || 0;

            const getSackData = (container) => {
              const weights = Array.from(
                container.querySelectorAll('input[type="number"]')
              )
                .map((input) => ({
                  value: parseFloat(input.value),
                  isOverweight: parseFloat(input.value) > 151,
                }))
                .filter((item) => !isNaN(item.value) && item.value > 0);
              return {
                weights,
                totalKarung: weights.length,
              };
            };

            const normalDataGross = getSackData(normalSackContainer);
            const tidakNormalDataGross = getSackData(tidakNormalSackContainer);

            if (
              normalDataGross.totalKarung === 0 &&
              tidakNormalDataGross.totalKarung === 0
            ) {
              alert("Mohon tambahkan setidaknya satu detail berat karung.");
              return;
            }

            // 2. Kalkulasi
            const totalBeratKotorNormal = normalDataGross.weights.reduce(
              (sum, s) => sum + s.value,
              0
            );
            const totalPotonganNormal =
              normalDataGross.totalKarung * potonganNormalKg;
            const totalBeratBersihNormal =
              totalBeratKotorNormal - totalPotonganNormal;

            const totalBeratKotorTidakNormal =
              tidakNormalDataGross.weights.reduce((sum, s) => sum + s.value, 0);
            const totalPotonganTidakNormal =
              tidakNormalDataGross.totalKarung * potonganTidakNormalKg;
            const totalBeratBersihTidakNormal =
              totalBeratKotorTidakNormal - totalPotonganTidakNormal;

            const subTotalNormal = totalBeratBersihNormal * hargaNormal;
            const subTotalTidakNormal =
              totalBeratBersihTidakNormal * hargaTidakNormal;
            const grandTotal = subTotalNormal + subTotalTidakNormal;
            const grandTotalKarung =
              normalDataGross.totalKarung + tidakNormalDataGross.totalKarung;

            // 3. Update Tampilan Struk (Bagian Atas)
            notaContainer.querySelector("#notaTanggal").textContent =
              formatTanggalNota(
                appContainer.querySelector("#formTanggalNota").value
              );
            notaContainer.querySelector("#notaLokasi").textContent =
              appContainer.querySelector("#formLokasiNota").value.toUpperCase();
            notaContainer.querySelector("#notaOwner").textContent = appContainer
              .querySelector("#formOwner")
              .value.toUpperCase();
            notaContainer.querySelector(
              "#notaJumlahKarung"
            ).textContent = `${grandTotalKarung} Karung`;

            // --- LOGIKA DINAMIS BARU UNTUK JUDUL & PEMISAH KATEGORI ---
            const rincianNormalSection = notaContainer.querySelector(
              "#notaRincianNormalSection"
            );
            const rincianTidakNormalSection = notaContainer.querySelector(
              "#notaRincianTidakNormalSection"
            );
            const headerNormal = rincianNormalSection.querySelector(
              ".nota-category-header"
            );
            const headerTidakNormal = rincianTidakNormalSection.querySelector(
              ".nota-category-header"
            );
            const dividerAntarKategori =
              rincianTidakNormalSection.querySelector(".nota-divider");

            if (
              normalDataGross.totalKarung > 0 &&
              tidakNormalDataGross.totalKarung > 0
            ) {
              headerNormal.style.display = "block";
              headerTidakNormal.style.display = "block";
              if (dividerAntarKategori)
                dividerAntarKategori.style.display = "block";
            } else {
              headerNormal.style.display = "none";
              headerTidakNormal.style.display = "none";
              if (dividerAntarKategori)
                dividerAntarKategori.style.display = "none";
              if (
                normalDataGross.totalKarung === 0 &&
                tidakNormalDataGross.totalKarung > 0
              ) {
                headerTidakNormal.style.display = "block";
              }
            }

            // Render Rincian Gabah Normal
            if (normalDataGross.totalKarung > 0) {
              rincianNormalSection.style.display = "block";
              renderWeightDetails(
                rincianNormalSection.querySelector(
                  "#notaDetailTimbanganNormalContainer"
                ),
                normalDataGross.weights
              );

              // --- LOGIKA BARU UNTUK MENYEMBUNYIKAN POTONGAN ---
              let summaryHTMLNormal = `<span class="nota-label">Total Berat</span><span class="nota-colon">:</span><strong class="nota-value bold">${formatAngka(
                totalBeratKotorNormal
              )} Kg</strong>`;
              if (totalPotonganNormal > 0) {
                summaryHTMLNormal += `
                <span class="nota-label">Potongan</span><span class="nota-colon">:</span><strong class="nota-value bold">${formatAngka(
                  totalPotonganNormal
                )} Kg</strong>
                <span class="nota-label">Berat Bersih</span><span class="nota-colon">:</span><strong class="nota-value bold">${formatAngka(
                  totalBeratBersihNormal
                )} Kg</strong>
            `;
              }
              summaryHTMLNormal += `<span class="nota-label">Harga/Kg</span><span class="nota-colon">:</span><strong class="nota-value bold">${formatRupiah(
                hargaNormal
              )}</strong>`;

              rincianNormalSection.querySelector(
                ".nota-summary-section"
              ).innerHTML = `<div class="nota-summary-grid">${summaryHTMLNormal}</div>`;
            } else {
              rincianNormalSection.style.display = "none";
            }

            // Render Rincian Gabah Tidak Normal
            if (tidakNormalDataGross.totalKarung > 0) {
              rincianTidakNormalSection.style.display = "block";
              renderWeightDetails(
                rincianTidakNormalSection.querySelector(
                  "#notaDetailTimbanganTidakNormalContainer"
                ),
                tidakNormalDataGross.weights
              );

              // --- LOGIKA BARU UNTUK MENYEMBUNYIKAN POTONGAN ---
              let summaryHTMLTidakNormal = `<span class="nota-label">Total</span><span class="nota-colon">:</span><strong class="nota-value bold">${formatAngka(
                totalBeratKotorTidakNormal
              )} Kg</strong>`;
              if (totalPotonganTidakNormal > 0) {
                summaryHTMLTidakNormal += `
                <span class="nota-label">Potongan</span><span class="nota-colon">:</span><strong class="nota-value bold">${formatAngka(
                  totalPotonganTidakNormal
                )} Kg</strong>
                <span class="nota-label">Berat Bersih</span><span class="nota-colon">:</span><strong class="nota-value bold">${formatAngka(
                  totalBeratBersihTidakNormal
                )} Kg</strong>
            `;
              }
              summaryHTMLTidakNormal += `<span class="nota-label">Harga/Kg</span><span class="nota-colon">:</span><strong class="nota-value bold">${formatRupiah(
                hargaTidakNormal
              )}</strong>`;

              rincianTidakNormalSection.querySelector(
                ".nota-summary-section"
              ).innerHTML = `<div class="nota-summary-grid">${summaryHTMLTidakNormal}</div>`;
            } else {
              rincianTidakNormalSection.style.display = "none";
            }

            // Sisa fungsi tetap sama
            notaContainer.querySelector(
              "#notaGrandTotalPembayaranValue"
            ).textContent = formatRupiah(grandTotal);

            currentStrukData = {
              tanggal: appContainer.querySelector("#formTanggalNota").value,
              owner: appContainer
                .querySelector("#formOwner")
                .value.toUpperCase(),
              totalBerat: totalBeratBersihNormal + totalBeratBersihTidakNormal,
              totalKarung: grandTotalKarung,
              totalPembayaran: grandTotal,
              rincianGabah: {
                normal: {
                  berat: totalBeratBersihNormal,
                  karung: normalDataGross.totalKarung,
                },
                tidakNormal: {
                  berat: totalBeratBersihTidakNormal,
                  karung: tidakNormalDataGross.totalKarung,
                },
              },
            };

            displayHybridCatatanOnStruk(
              notaContainer.querySelector("#notaStrukCatatanSection"),
              catatanInput.value,
              "nota-divider"
            );
            notaOutputSection.classList.remove("hidden");
            notaOutputSection.scrollIntoView({ behavior: "smooth" });
          });

          saveJpgButton.addEventListener("click", function () {
            showLoading(this);
            html2canvas(notaContainer, {
              scale: 3,
              backgroundColor: "#ffffff",
              width: 310,
            })
              .then((canvas) => {
                const tglValue =
                  appContainer.querySelector("#formTanggalNota").value;
                const owner = appContainer
                  .querySelector("#formOwner")
                  .value.replace(/\s/g, "_");
                const tglFormatted = formatDateForFilename(tglValue);
                const count = getPrintCount(tglValue)
                  .toString()
                  .padStart(3, "0");
                const fileName = `NP_${owner}_${tglFormatted}${count}.jpg`;
                const title = `Nota Pembayaran ${owner}`;

                // 1. Simpan file seperti biasa (download)
                const link = document.createElement("a");
                link.download = fileName;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                link.click();

                historyManager.addEntry("notaPembayaran", currentStrukData);

                // 2. Panggil fungsi share (BARU)
                shareImage(canvas, fileName, title);
              })
              .finally(() => {
                hideLoading(this);
              });
          });

          // Inisialisasi
          setupDynamicCatatan(appContainer, "Nota", saveDataToLocalStorage);
          pembayaranForm.addEventListener("input", saveDataToLocalStorage);
          appContainer
            .querySelector("#formPotonganNormal")
            .addEventListener("input", updateAllNotaDisplays);
          appContainer
            .querySelector("#formPotonganTidakNormal")
            .addEventListener("input", updateAllNotaDisplays);
          resetButton.addEventListener("click", () =>
            resetFormAndStorage(false)
          );
          loadDataFromLocalStorage();
        })();

        // --- Logika Aplikasi 3: Rekap Muatan (DIPERBARUI DENGAN CHECKLIST JJ) ---
        (function () {
          const appContainer = document.getElementById("rekapitulasi-app");
          if (!appContainer) return;

          // Variabel utama
          const STORAGE_KEY_REKAP = "dataRekapMuatan";
          const rekapGabahForm = appContainer.querySelector("#rekapGabahForm");
          const ritaseListContainer = appContainer.querySelector(
            "#ritaseListContainer"
          );
          const addRitaseButton =
            appContainer.querySelector("#addRitaseButton");
          const addAmountInput = appContainer.querySelector("#rekapAddAmount");
          const resetButton = appContainer.querySelector("#resetRekapButton");
          const rekapOutputSection = appContainer.querySelector(
            "#rekapOutputSection"
          );
          const recapReceiptContainer = appContainer.querySelector(
            "#recapReceiptContainer"
          );
          const saveJpgButton = appContainer.querySelector(
            "#saveRecapAsJpgButton"
          );

          // Input Field
          const hargaJasaInput = appContainer.querySelector("#rekapHargaJasa");
          const hargaTambahanInput = appContainer.querySelector(
            "#rekapHargaTambahan"
          ); // Input Baru
          const catatanInput = appContainer.querySelector("#rekapCatatanInput");

          let ritaseIdCounter = 0;
          let isLoadingRekap = false;
          let currentStrukData = {};

          // --- FUNGSI LOCAL STORAGE ---
          function saveDataToLocalStorage() {
            if (isLoadingRekap) return;
            const ritaseItems = Array.from(
              ritaseListContainer.querySelectorAll(".ritase-input-item")
            ).map((item) => ({
              date: item.querySelector('input[name="ritaseDate"]').value,
              berat: item.querySelector('input[name="ritaseBerat"]').value,
              karung: item.querySelector('input[name="ritaseKarung"]').value,
              isJauh: item.querySelector('input[name="ritaseIsJarakJauh"]')
                .checked, // Simpan status checkbox
            }));

            const data = {
              tanggalMulai:
                appContainer.querySelector("#rekapTanggalMulai").value,
              tanggalSelesai: appContainer.querySelector("#rekapTanggalSelesai")
                .value,
              noPlat: appContainer.querySelector("#rekapNoPlatInput").value,
              hargaJasa: hargaJasaInput.value,
              hargaTambahan: hargaTambahanInput.value, // Simpan harga tambahan
              catatan: catatanInput.value,
              ritase: ritaseItems,
            };
            localStorage.setItem(STORAGE_KEY_REKAP, JSON.stringify(data));
          }

          function loadDataFromLocalStorage() {
            isLoadingRekap = true;
            const savedData = localStorage.getItem(STORAGE_KEY_REKAP);
            const today = getTodayDateString();

            if (!savedData) {
              appContainer.querySelector("#rekapTanggalMulai").value = today;
              appContainer.querySelector("#rekapTanggalSelesai").value = today;
              addRitaseInputSection();
              isLoadingRekap = false;
              return;
            }

            const data = JSON.parse(savedData);
            appContainer.querySelector("#rekapTanggalMulai").value =
              data.tanggalMulai || today;
            appContainer.querySelector("#rekapTanggalSelesai").value =
              data.tanggalSelesai || today;
            appContainer.querySelector("#rekapNoPlatInput").value =
              data.noPlat || "";
            hargaJasaInput.value = data.hargaJasa || "125";
            hargaTambahanInput.value = data.hargaTambahan || "40000"; // Load harga tambahan
            catatanInput.value = data.catatan || "";

            if (catatanInput.value) {
              appContainer
                .querySelector("#addCatatanBtn_Rekap")
                .classList.add("hidden");
              appContainer
                .querySelector("#catatanInputWrapper_Rekap")
                .classList.remove("hidden");
            }

            ritaseListContainer.innerHTML = "";
            ritaseIdCounter = 0;

            if (data.ritase && data.ritase.length > 0) {
              data.ritase.forEach((rit) => addRitaseInputSection(false, rit));
            } else {
              addRitaseInputSection();
            }
            isLoadingRekap = false;
          }

          function resetFormAndStorage() {
            if (
              confirm(
                "Apakah Anda yakin ingin menghapus semua data pada form Rekap Muatan?"
              )
            ) {
              localStorage.removeItem(STORAGE_KEY_REKAP);
              isLoadingRekap = true;
              rekapGabahForm.reset();
              hargaJasaInput.value = "125";
              hargaTambahanInput.value = "40000";

              appContainer
                .querySelector("#catatanInputWrapper_Rekap")
                .classList.add("hidden");
              appContainer
                .querySelector("#addCatatanBtn_Rekap")
                .classList.remove("hidden");

              ritaseListContainer.innerHTML = "";
              ritaseIdCounter = 0;
              appContainer.querySelector("#rekapTanggalMulai").value =
                getTodayDateString();
              appContainer.querySelector("#rekapTanggalSelesai").value =
                getTodayDateString();
              addRitaseInputSection();
              rekapOutputSection.classList.add("hidden");
              isLoadingRekap = false;
              saveDataToLocalStorage();
            }
          }

          // --- Fungsi Form Utama (DENGAN CHECKBOX) ---
          function addRitaseInputSection(autoFocusDate = false, data = {}) {
            ritaseIdCounter++;
            const itemDiv = document.createElement("div");
            itemDiv.className = "ritase-input-item";
            itemDiv.dataset.ritaseId = ritaseIdCounter;

            // Status checkbox
            const isChecked = data.isJauh ? "checked" : "";

            itemDiv.innerHTML = `
        <div class="flex items-center justify-center">
            <label class="inline-flex items-center cursor-pointer" title="Ceklis jika lokasi jauh">
                <input type="checkbox" name="ritaseIsJarakJauh" class="form-checkbox h-5 w-5 text-green-600" ${isChecked}>
                <span class="ml-1 text-xs font-bold text-green-700">JJ</span>
            </label>
        </div>

        <label class="ritase-number">R-${ritaseIdCounter}:</label>
        
        <input type="date" name="ritaseDate" required class="form-input" value="${
          data.date || ""
        }">
        <input type="number" name="ritaseBerat" placeholder="Berat (Kg)" min="0" step="0.1" required class="form-input" value="${
          data.berat || ""
        }">
        <input type="number" name="ritaseKarung" placeholder="Karung" min="0" required class="form-input" value="${
          data.karung || ""
        }">
        
        <button type="button" class="remove-ritase-btn text-red-500 hover:text-red-700 p-1 text-xl">&times;</button>
    `;
            itemDiv.style.gridTemplateColumns =
              "auto auto 2fr 1.5fr 1.5fr auto";

            ritaseListContainer.appendChild(itemDiv);

            // Event Listener
            itemDiv
              .querySelector('input[name="ritaseIsJarakJauh"]')
              .addEventListener("change", saveDataToLocalStorage);

            itemDiv.querySelector(".remove-ritase-btn").onclick = () => {
              itemDiv.remove();
              updateRitaseLabels();
              saveDataToLocalStorage();
            };

            if (autoFocusDate) {
              itemDiv.querySelector('input[type="date"]').focus();
            }
            updateRitaseLabels();
          }

          function updateRitaseLabels() {
            const items =
              ritaseListContainer.querySelectorAll(".ritase-input-item");
            items.forEach((item, index) => {
              item.querySelector("label.ritase-number").textContent = `R-${
                index + 1
              }:`;
              item.dataset.ritaseId = index + 1;
            });
            ritaseIdCounter = items.length;
          }

          addRitaseButton.addEventListener("click", () => {
            const amount = parseInt(addAmountInput.value, 10) || 1;
            for (let i = 0; i < amount; i++) {
              addRitaseInputSection(i === 0);
            }
            addAmountInput.value = "";
            saveDataToLocalStorage();
          });

          function formatTanggalSimple(tanggalStr) {
            if (!tanggalStr) return "";
            const [year, month, day] = tanggalStr.split("-");
            return `${day}/${month}/${year}`;
          }

          // Fungsi ukur teks untuk perataan titik dua

          rekapGabahForm.addEventListener("submit", function (event) {
            event.preventDefault();
            const tanggalMulai =
              appContainer.querySelector("#rekapTanggalMulai").value;
            const tanggalSelesai = appContainer.querySelector(
              "#rekapTanggalSelesai"
            ).value;
            const noPlat = appContainer
              .querySelector("#rekapNoPlatInput")
              .value.toUpperCase();

            const hargaJasa = parseFloat(hargaJasaInput.value) || 0;
            const hargaTambahan = parseFloat(hargaTambahanInput.value) || 0;

            const ritaseDetails = [];
            const ritaseInputItems =
              ritaseListContainer.querySelectorAll(".ritase-input-item");
            let grandTotalBerat = 0;
            let grandTotalKarung = 0;
            let jumlahRitJauh = 0; // Counter untuk JJ
            let formIsValid = true;

            if (ritaseInputItems.length === 0) {
              alert("Mohon tambahkan minimal satu detail ritase.");
              return;
            }

            ritaseInputItems.forEach((item, index) => {
              if (!formIsValid) return;
              const dateInput = item.querySelector('input[name="ritaseDate"]');
              const beratInput = item.querySelector(
                'input[name="ritaseBerat"]'
              );
              const karungInput = item.querySelector(
                'input[name="ritaseKarung"]'
              );
              const isJauhInput = item.querySelector(
                'input[name="ritaseIsJarakJauh"]'
              );

              const tanggalRitase = dateInput.value;
              const totalBerat = parseFloat(beratInput.value);
              const totalKarung = parseInt(karungInput.value);
              const isJauh = isJauhInput.checked;

              if (
                !tanggalRitase ||
                isNaN(totalBerat) ||
                totalBerat < 0 ||
                isNaN(totalKarung) ||
                totalKarung < 0
              ) {
                alert(`Data ritase ke-${index + 1} tidak valid.`);
                formIsValid = false;
                dateInput.focus();
                return;
              }

              if (isJauh) {
                jumlahRitJauh++;
              }

              ritaseDetails.push({
                tanggal: tanggalRitase,
                berat: totalBerat,
                karung: totalKarung,
                isJauh: isJauh,
              });
              grandTotalBerat += totalBerat;
              grandTotalKarung += totalKarung;
            });

            if (!formIsValid) return;

            // --- KALKULASI TOTAL ---
            const totalJasaDasar = grandTotalBerat * hargaJasa;
            const totalBiayaTambahan = jumlahRitJauh * hargaTambahan;
            const totalJasaAkhir = totalJasaDasar + totalBiayaTambahan;

            // --- RENDER STRUK ---
            recapReceiptContainer.querySelector(
              "#recapStrukPeriode"
            ).textContent = `${formatTanggalSimple(
              tanggalMulai
            )} - ${formatTanggalSimple(tanggalSelesai)}`;
            recapReceiptContainer.querySelector(
              "#recapStrukNoPlat"
            ).textContent = noPlat;
            recapReceiptContainer.querySelector(
              "#recapStrukTotalRitase"
            ).textContent = ritaseDetails.length;

            const detailRitaseBody = recapReceiptContainer.querySelector(
              "#recapStrukDetailRitaseBody"
            );
            detailRitaseBody.innerHTML = "";

            ritaseDetails.forEach((detail, index) => {
              const row = detailRitaseBody.insertRow();

              // LOGIKA NOMOR URUT: Tambahkan (JJ) jika checklist dicentang
              const nomorUrut = index + 1;
              row.insertCell().textContent = detail.isJauh
                ? `${nomorUrut} (JJ)`
                : nomorUrut;

              row.insertCell().textContent = formatTanggalSimple(
                detail.tanggal
              );
              row.insertCell().textContent = formatAngka(detail.berat);
              row.insertCell().textContent = detail.karung;
            });

            recapReceiptContainer.querySelector(
              "#recapStrukGrandTotalBerat"
            ).textContent = formatAngka(grandTotalBerat);
            recapReceiptContainer.querySelector(
              "#recapStrukGrandTotalKarung"
            ).textContent = grandTotalKarung;

            // --- RENDER BARIS TAMBAHAN DI SUMMARY ---
            const rowTambahan = recapReceiptContainer.querySelector(
              "#recapStrukTambahanRow"
            );
            if (jumlahRitJauh > 0) {
              rowTambahan.classList.remove("hidden");
              const valSpan = rowTambahan.querySelector(
                "#recapStrukTambahanValue"
              );
              // Format Teks: "2 Rit x 40.000 = 80.000"
              valSpan.innerHTML = `${jumlahRitJauh} Rit x ${formatAngka(
                hargaTambahan
              )} = <strong>${formatRupiah(totalBiayaTambahan)}</strong>`;
            } else {
              rowTambahan.classList.add("hidden");
            }

            recapReceiptContainer.querySelector(
              "#recapStrukTotalJasa"
            ).textContent = formatRupiah(totalJasaAkhir);

            displayHybridCatatanOnStruk(
              recapReceiptContainer.querySelector("#recapStrukCatatanSection"),
              catatanInput.value,
              "recap-receipt-divider"
            );

            currentStrukData = {
              tanggalMulai: tanggalMulai,
              tanggalSelesai: tanggalSelesai,
              noPlat: noPlat,
              totalRitase: ritaseDetails.length,
              totalMuatan: grandTotalBerat,
              totalJasa: totalJasaAkhir,
              extraCharge: {
                count: jumlahRitJauh,
                rate: hargaTambahan,
                total: totalBiayaTambahan,
              },
            };

            // alignRecapColons();
            rekapOutputSection.classList.remove("hidden");
            rekapOutputSection.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          });

          saveJpgButton.addEventListener("click", function () {
            showLoading(this);
            html2canvas(recapReceiptContainer, {
              scale: 3,
              useCORS: true,
              backgroundColor: "#ffffff",
              logging: false,
            })
              .then((canvas) => {
                const image = canvas.toDataURL("image/jpeg", 0.95);
                const link = document.createElement("a");
                const plat = appContainer
                  .querySelector("#rekapNoPlatInput")
                  .value.replace(/\s/g, "");
                const tglMulai = formatDateForFilename(
                  appContainer.querySelector("#rekapTanggalMulai").value
                );
                const tglSelesai = formatDateForFilename(
                  appContainer.querySelector("#rekapTanggalSelesai").value
                );

                link.download = `RM_${plat}_${tglMulai}-${tglSelesai}.jpg`;
                link.href = image;
                link.click();

                historyManager.addEntry("rekapMuatan", currentStrukData);
              })
              .catch((err) => {
                console.error("Error generating JPG:", err);
                alert("Gagal membuat file JPG.");
              })
              .finally(() => {
                hideLoading(this);
              });
          });

          // Inisialisasi
          setupDynamicCatatan(appContainer, "Rekap", saveDataToLocalStorage);
          rekapGabahForm.addEventListener("input", saveDataToLocalStorage);
          resetButton.addEventListener("click", resetFormAndStorage);
          loadDataFromLocalStorage();
        })();

        // --- Logika Aplikasi 4: Rekap Gaji Buruh ---
        (function () {
          const appContainer = document.getElementById("rekap-gaji-app");
          if (!appContainer) return;

          // Variabel utama
          const STORAGE_KEY_GAJI = "dataRekapGaji";
          const gajiBuruhForm = appContainer.querySelector("#gajiBuruhForm");
          const addRitaseEntryButton = appContainer.querySelector(
            "#addGajiRitaseEntryButton"
          );
          const addAmountInput = appContainer.querySelector("#gajiAddAmount");
          const ritaseEntriesContainer = appContainer.querySelector(
            "#gajiRitaseEntriesContainer"
          );
          const resetButton = appContainer.querySelector("#resetGajiButton");
          const buruhFilterContainer = appContainer.querySelector(
            "#gajiBuruhFilterContainer"
          );
          const buruhCheckboxList = appContainer.querySelector(
            "#gajiBuruhCheckboxList"
          );
          const selectAllBuruhCheckbox = appContainer.querySelector(
            "#selectAllGajiBuruh"
          );
          const gajiOutputSection =
            appContainer.querySelector("#gajiOutputSection");
          const gajiStrukContainer = appContainer.querySelector(
            "#gajiStrukContainer"
          );
          const saveJpgButton = appContainer.querySelector(
            "#saveGajiStrukAsJpgButton"
          );
          const catatanInput = appContainer.querySelector("#gajiCatatanInput");
          let ritaseEntryIdCounter = 0;
          let allBuruhDataGlobal = {};
          let grandTotalKarungGlobal = 0;
          let grandTotalGajiGlobal = 0;
          let isLoadingGaji = false;
          let currentStrukData = {};

          // --- FUNGSI LOCAL STORAGE ---
          function saveDataToLocalStorage() {
            if (isLoadingGaji) return;
            const ritaseEntries = Array.from(
              ritaseEntriesContainer.querySelectorAll(".ritase-card")
            ).map((entry) => {
              const ritaseId = entry.dataset.ritaseId;
              const buruhNames = Array.from(
                entry.querySelectorAll(
                  `input[name^="gaji_buruhName_${ritaseId}_"]`
                )
              ).map((input) => input.value);
              return {
                karung: entry.querySelector(
                  `input[name="gaji_ritaseKarung_${ritaseId}"]`
                ).value,
                jmlBuruh: entry.querySelector(
                  `input[name="gaji_ritaseJmlBuruh_${ritaseId}"]`
                ).value,
                buruh: buruhNames,
              };
            });

            const data = {
              tanggalMulai: gajiBuruhForm.gajiFormTanggalMulai.value,
              tanggalSelesai: gajiBuruhForm.gajiFormTanggalSelesai.value,
              noPlat: gajiBuruhForm.gajiFormNoPlat.value,
              ratePerKarung: gajiBuruhForm.gajiFormRatePerKarung.value,
              catatan: catatanInput.value,
              ritase: ritaseEntries,
            };
            localStorage.setItem(STORAGE_KEY_GAJI, JSON.stringify(data));
          }

          function loadDataFromLocalStorage() {
            isLoadingGaji = true;
            const savedData = localStorage.getItem(STORAGE_KEY_GAJI);
            const today = getTodayDateString();
            if (!savedData) {
              gajiBuruhForm.gajiFormTanggalMulai.value = today;
              gajiBuruhForm.gajiFormTanggalSelesai.value = today;
              addRitaseEntry();
              isLoadingGaji = false;
              return;
            }

            const data = JSON.parse(savedData);
            gajiBuruhForm.gajiFormTanggalMulai.value =
              data.tanggalMulai || today;
            gajiBuruhForm.gajiFormTanggalSelesai.value =
              data.tanggalSelesai || today;
            gajiBuruhForm.gajiFormNoPlat.value = data.noPlat || "";
            gajiBuruhForm.gajiFormRatePerKarung.value =
              data.ratePerKarung || "";
            catatanInput.value = data.catatan || "";

            if (catatanInput.value) {
              appContainer
                .querySelector("#addCatatanBtn_Gaji")
                .classList.add("hidden");
              appContainer
                .querySelector("#catatanInputWrapper_Gaji")
                .classList.remove("hidden");
            }

            ritaseEntriesContainer.innerHTML = "";
            ritaseEntryIdCounter = 0;

            if (data.ritase && data.ritase.length > 0) {
              data.ritase.forEach((rit) => addRitaseEntry(rit));
            } else {
              addRitaseEntry();
            }
            isLoadingGaji = false;
          }

          function resetFormAndStorage() {
            if (
              confirm(
                "Apakah Anda yakin ingin menghapus semua data pada form Rekap Gaji? Data yang tersimpan akan hilang."
              )
            ) {
              localStorage.removeItem(STORAGE_KEY_GAJI);
              isLoadingGaji = true;
              gajiBuruhForm.reset();

              appContainer
                .querySelector("#catatanInputWrapper_Gaji")
                .classList.add("hidden");
              appContainer
                .querySelector("#addCatatanBtn_Gaji")
                .classList.remove("hidden");

              ritaseEntriesContainer.innerHTML = "";
              ritaseEntryIdCounter = 0;
              gajiBuruhForm.gajiFormTanggalMulai.value = getTodayDateString();
              gajiBuruhForm.gajiFormTanggalSelesai.value = getTodayDateString();
              addRitaseEntry();
              gajiOutputSection.classList.add("hidden");
              buruhFilterContainer.classList.add("hidden");
              isLoadingGaji = false;
              saveDataToLocalStorage();
            }
          }

          // --- Fungsi Form Utama ---
          function formatTanggalIndoSimple(tanggalStr) {
            if (!tanggalStr) return "";
            const [year, month, day] = tanggalStr.split("-");
            return `${day}/${month}/${year}`;
          }

          function addBuruhNameInput(
            buruhContainer,
            ritaseId,
            buruhIndex,
            name = ""
          ) {
            const itemDiv = document.createElement("div");
            itemDiv.classList.add("buruh-name-input-wrapper");

            itemDiv.innerHTML = `
                        <label class="input-label text-xs w-20 text-right mr-2">B-${
                          buruhIndex + 1
                        }:</label>
                        <input type="text" name="gaji_buruhName_${ritaseId}_${buruhIndex}" placeholder="Nama" required class="form-input text-sm" value="${name}">
                    `;

            buruhContainer.appendChild(itemDiv);
          }

          function updateBuruhNameInputs(
            ritaseEntryDiv,
            ritaseId,
            jumlahBuruh,
            names = []
          ) {
            const buruhListContainer = ritaseEntryDiv.querySelector(
              ".buruh-input-list-dynamic"
            );
            buruhListContainer.innerHTML = "";
            if (jumlahBuruh > 0) {
              for (let i = 0; i < jumlahBuruh; i++) {
                addBuruhNameInput(
                  buruhListContainer,
                  ritaseId,
                  i,
                  names[i] || ""
                );
              }
            }
          }

          function addRitaseEntry(data = {}) {
            ritaseEntryIdCounter++;
            const ritaseId = ritaseEntryIdCounter;

            const entryDiv = document.createElement("div");
            entryDiv.classList.add("ritase-card");
            entryDiv.dataset.ritaseId = ritaseId;

            entryDiv.innerHTML = `
                        <div class="ritase-header">
                            <span class="ritase-title">Data Ritase Ke-${ritaseId}</span>
                            <button type="button" class="remove-gaji-ritase-btn text-red-500 bg-red-100 hover:bg-red-200 font-bold p-2 h-8 w-8 flex items-center justify-center rounded-md transition-colors"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-3">
                            <div>
                                <label for="gaji_ritaseKarung_${ritaseId}" class="input-label">Jml Karung</label>
                                <input type="number" id="gaji_ritaseKarung_${ritaseId}" name="gaji_ritaseKarung_${ritaseId}" min="1" required class="form-input" value="${
              data.karung || ""
            }">
                            </div>
                            <div>
                                <label for="gaji_ritaseJmlBuruh_${ritaseId}" class="input-label">Jml Buruh</label>
                                <input type="number" id="gaji_ritaseJmlBuruh_${ritaseId}" name="gaji_ritaseJmlBuruh_${ritaseId}" min="1" placeholder="1" required class="form-input" value="${
              data.jmlBuruh || ""
            }">
                            </div>
                        </div>
                        <div class="buruh-input-list-dynamic mt-3 space-y-2"></div>`;

            ritaseEntriesContainer.appendChild(entryDiv);
            entryDiv.querySelector(".remove-gaji-ritase-btn").onclick = () => {
              entryDiv.remove();
              updateAllRitaseTitles();
              saveDataToLocalStorage();
            };

            const jmlBuruhInput = entryDiv.querySelector(
              `#gaji_ritaseJmlBuruh_${ritaseId}`
            );
            jmlBuruhInput.addEventListener("input", () => {
              const jumlah = parseInt(jmlBuruhInput.value) || 0;
              updateBuruhNameInputs(entryDiv, ritaseId, jumlah);
            });

            if (ritaseEntriesContainer.children.length > 1) {
              entryDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }
            updateBuruhNameInputs(
              entryDiv,
              ritaseId,
              parseInt(data.jmlBuruh) || 0,
              data.buruh || []
            );
            updateAllRitaseTitles();
          }

          function updateAllRitaseTitles() {
            const allEntries =
              ritaseEntriesContainer.querySelectorAll(".ritase-card");
            allEntries.forEach((entry, index) => {
              const newId = index + 1;
              entry.querySelector(
                ".ritase-title"
              ).textContent = `Data Ritase Ke-${newId}`;
              entry.dataset.ritaseId = newId;
              entry.querySelectorAll('[id*="gaji_"]').forEach((el) => {
                const oldId = el.id.match(/_(\d+)$/)[1];
                el.id = el.id.replace(`_${oldId}`, `_${newId}`);
              });
              entry.querySelectorAll('[name*="gaji_"]').forEach((el) => {
                const match = el.name.match(/_(\d+)(_(\d+))?$/);
                if (match) {
                  const oldRitaseId = match[1];
                  el.name = el.name.replace(`_${oldRitaseId}`, `_${newId}`);
                }
              });
            });
            ritaseEntryIdCounter = allEntries.length;
          }

          addRitaseEntryButton.addEventListener("click", () => {
            const amount = parseInt(addAmountInput.value, 10) || 1;
            for (let i = 0; i < amount; i++) {
              addRitaseEntry();
            }
            addAmountInput.value = "";
            saveDataToLocalStorage();
          });

          function formatRupiahGaji(angka) {
            return new Intl.NumberFormat("id-ID", {
              style: "currency",
              currency: "IDR",
              minimumFractionDigits: 0,
            })
              .format(angka)
              .replace("Rp", "Rp. ");
          }

          function populateBuruhFilter(buruhNames) {
            buruhCheckboxList.innerHTML = "";
            if (buruhNames.length > 0) {
              buruhFilterContainer.classList.remove("hidden");
              selectAllBuruhCheckbox.checked = true;
              buruhNames.forEach((nama) => {
                const itemDiv = document.createElement("div");
                itemDiv.classList.add(
                  "filter-checkbox-item",
                  "flex",
                  "items-center"
                );
                itemDiv.innerHTML = `
                                <input type="checkbox" id="filter_buruh_${nama.replace(
                                  /\s+/g,
                                  "_"
                                )}" value="${nama}" checked class="h-4 w-4 rounded focus:ring-indigo-500 filter-buruh-checkbox" style="color: var(--brand-primary);">
                                <label for="filter_buruh_${nama.replace(
                                  /\s+/g,
                                  "_"
                                )}" class="ml-2 text-sm">${nama}</label>
                            `;
                buruhCheckboxList.appendChild(itemDiv);
              });
            } else {
              buruhFilterContainer.classList.add("hidden");
            }
          }

          function displayStruk(
            noPlat,
            ratePerKarung,
            periode,
            totalRitase,
            buruhDataToDisplay,
            grandTotalKarung,
            grandTotalGaji
          ) {
            // --- 1. Update Header Info Struk (Bagian Paling Atas) ---
            gajiStrukContainer.querySelector("#strukPeriodeGaji").textContent =
              periode;
            gajiStrukContainer.querySelector("#strukNoPlatGaji").textContent =
              noPlat;
            gajiStrukContainer.querySelector(
              "#strukRatePerKarungGaji"
            ).textContent = formatRupiahGaji(ratePerKarung);
            gajiStrukContainer.querySelector(
              "#strukTotalRitaseGaji"
            ).textContent = totalRitase;

            // Update Total Gabah & Gaji (Segmen Info Atas)
            gajiStrukContainer.querySelector(
              "#strukTotalKarungKeseluruhanGaji"
            ).textContent = `${grandTotalKarung} Krg`;
            gajiStrukContainer.querySelector(
              "#strukTotalGajiKeseluruhan"
            ).textContent = formatRupiahGaji(grandTotalGaji);

            // --- 2. Update Rincian Per Buruh ---
            const strukBuruhDetailsContainer = gajiStrukContainer.querySelector(
              "#strukBuruhDetailsContainer"
            );
            strukBuruhDetailsContainer.innerHTML = "";

            Object.keys(buruhDataToDisplay)
              .sort()
              .forEach((namaBuruh, index, array) => {
                const data = buruhDataToDisplay[namaBuruh];
                const buruhDiv = document.createElement("div");
                buruhDiv.classList.add("buruh-gaji-detail");

                // Mengubah kata "Ritase" menjadi "Rit" di dalam rincian
                let rincianHtml = data.rincian
                  .map(
                    (r) =>
                      `<p class="rincian-item">- Rit ${r.ritaseKe}: ${
                        r.karungRitase
                      } krg x ${formatRupiahGaji(
                        r.upahPerKarung
                      )} = ${formatRupiahGaji(r.gajiRitase)}</p>`
                  )
                  .join("");

                // --- PERUBAHAN TATA LETAK UTAMA ---
                buruhDiv.innerHTML = `
          <div style="font-size: 0.95em; font-weight: bold; color: #333; margin-bottom: 2px;">
              ${noPlat} (${periode})
          </div>
          
          <h3 style="margin-top: 0; margin-bottom: 6px;">${namaBuruh}</h3>
          
          <p style="display: flex; justify-content: space-between; margin-bottom: 2px;">
              <span>Total Panca</span>
              <strong>${data.totalKarung} Krg</strong>
          </p>

          <p class="total-gaji-buruh" style="display: flex; justify-content: space-between; margin-top: 0;">
              <span>Total Saro Panca</span>
              <strong>${formatRupiahGaji(data.totalGaji)}</strong>
          </p>

          <div style="border-top: 1px dashed #888; margin: 8px 0 6px 0;"></div>

          <p class="rincian-upah-header" style="font-weight: bold; margin-bottom: 3px;">Rincian Saro:</p>
          
          ${rincianHtml}
      `;
                // ---------------------------------

                strukBuruhDetailsContainer.appendChild(buruhDiv);
                if (index < array.length - 1) {
                  const divider = document.createElement("div");
                  divider.classList.add("gaji-struk-divider");
                  divider.style.borderTopStyle = "dotted"; // Pemisah antar buruh
                  strukBuruhDetailsContainer.appendChild(divider);
                }
              });

            displayCatatanOnStruk(
              gajiStrukContainer.querySelector("#gajiStrukCatatanSection"),
              catatanInput.value,
              "gaji-struk-divider"
            );

            gajiOutputSection.classList.remove("hidden");
            gajiOutputSection.scrollIntoView({
              behavior: "smooth",
              block: "nearest",
            });
          }

          function handleFilterChange() {
            const form = gajiBuruhForm;
            const noPlat = form.gajiFormNoPlat.value;
            const ratePerKarung = parseFloat(form.gajiFormRatePerKarung.value);
            const periode = `${formatTanggalIndoSimple(
              form.gajiFormTanggalMulai.value
            )} - ${formatTanggalIndoSimple(form.gajiFormTanggalSelesai.value)}`;
            const totalRitase =
              ritaseEntriesContainer.querySelectorAll(".ritase-card").length;

            const selectedBuruhForDisplay = {};
            buruhCheckboxList
              .querySelectorAll(".filter-buruh-checkbox")
              .forEach((cb) => {
                if (cb.checked && allBuruhDataGlobal[cb.value]) {
                  selectedBuruhForDisplay[cb.value] =
                    allBuruhDataGlobal[cb.value];
                }
              });

            displayStruk(
              noPlat,
              ratePerKarung,
              periode,
              totalRitase,
              selectedBuruhForDisplay,
              grandTotalKarungGlobal,
              grandTotalGajiGlobal
            );
          }

          function handleSelectAllChange() {
            buruhCheckboxList
              .querySelectorAll(".filter-buruh-checkbox")
              .forEach((cb) => (cb.checked = this.checked));
            handleFilterChange();
          }

          gajiBuruhForm.addEventListener("submit", function (event) {
            event.preventDefault();
            allBuruhDataGlobal = {};
            grandTotalKarungGlobal = 0;
            grandTotalGajiGlobal = 0;
            let formIsValid = true;

            const tanggalMulai = gajiBuruhForm.gajiFormTanggalMulai.value;
            const tanggalSelesai = gajiBuruhForm.gajiFormTanggalSelesai.value;
            const noPlat = gajiBuruhForm.gajiFormNoPlat.value;
            const ratePerKarung = parseFloat(
              gajiBuruhForm.gajiFormRatePerKarung.value
            );

            if (isNaN(ratePerKarung) || ratePerKarung <= 0) {
              alert("Rate per karung tidak valid.");
              return;
            }
            if (!tanggalMulai || !tanggalSelesai) {
              alert("Tanggal periode laporan harus diisi.");
              return;
            }

            const ritaseEntries =
              ritaseEntriesContainer.querySelectorAll(".ritase-card");
            if (ritaseEntries.length === 0) {
              alert("Mohon tambahkan minimal satu entri ritase.");
              return;
            }

            ritaseEntries.forEach((entry, index) => {
              if (!formIsValid) return;
              const ritaseId = entry.dataset.ritaseId;
              const karungRitaseInput = entry.querySelector(
                `input[name="gaji_ritaseKarung_${ritaseId}"]`
              );
              const jmlBuruhInput = entry.querySelector(
                `input[name="gaji_ritaseJmlBuruh_${ritaseId}"]`
              );
              const karungRitase = parseInt(karungRitaseInput.value);
              const jmlBuruhRitase = parseInt(jmlBuruhInput.value);

              if (isNaN(karungRitase) || karungRitase <= 0) {
                alert(`Jumlah karung pada Ritase ${index + 1} tidak valid.`);
                karungRitaseInput.focus();
                formIsValid = false;
                return;
              }
              if (isNaN(jmlBuruhRitase) || jmlBuruhRitase <= 0) {
                alert(
                  `Jumlah buruh pada Ritase ${
                    index + 1
                  } harus diisi dan lebih dari 0.`
                );
                jmlBuruhInput.focus();
                formIsValid = false;
                return;
              }

              grandTotalKarungGlobal += karungRitase;
              const upahPerKarungRitase = ratePerKarung / jmlBuruhRitase;

              const namaBuruhInputs = entry.querySelectorAll(
                `input[name^="gaji_buruhName_${ritaseId}_"]`
              );
              if (namaBuruhInputs.length !== jmlBuruhRitase) {
                alert(
                  `Jumlah nama buruh pada Ritase ${index + 1} tidak sesuai.`
                );
                formIsValid = false;
                return;
              }

              namaBuruhInputs.forEach((inputNama) => {
                const nama = inputNama.value.trim().toUpperCase();
                if (!nama) {
                  alert(
                    `Nama buruh pada Ritase ${index + 1} tidak boleh kosong.`
                  );
                  inputNama.focus();
                  formIsValid = false;
                  return;
                }
                if (!allBuruhDataGlobal[nama]) {
                  allBuruhDataGlobal[nama] = {
                    totalKarung: 0,
                    totalGaji: 0,
                    rincian: [],
                  };
                }
                allBuruhDataGlobal[nama].totalKarung += karungRitase;

                const gajiDariRitaseIni = karungRitase * upahPerKarungRitase;
                allBuruhDataGlobal[nama].totalGaji += gajiDariRitaseIni;
                allBuruhDataGlobal[nama].rincian.push({
                  karungRitase: karungRitase,
                  upahPerKarung: upahPerKarungRitase,
                  gajiRitase: gajiDariRitaseIni,
                  ritaseKe: index + 1,
                });
              });
              if (!formIsValid) return;
            });

            if (!formIsValid) return;

            grandTotalGajiGlobal = Object.values(allBuruhDataGlobal).reduce(
              (acc, buruh) => acc + buruh.totalGaji,
              0
            );

            const totalRitase = ritaseEntries.length; // Ambil jumlah ritase
            currentStrukData = {
              tanggalMulai: tanggalMulai,
              tanggalSelesai: tanggalSelesai,
              noPlat: noPlat,
              totalRitase: totalRitase, // <-- TAMBAHKAN BARIS INI
              totalGaji: grandTotalGajiGlobal,
              buruhDetails: Object.keys(allBuruhDataGlobal).map((nama) => ({
                name: nama,
                gaji: allBuruhDataGlobal[nama].totalGaji,
              })),
            };

            populateBuruhFilter(Object.keys(allBuruhDataGlobal).sort());
            handleFilterChange();

            buruhCheckboxList.removeEventListener("change", handleFilterChange);
            selectAllBuruhCheckbox.removeEventListener(
              "change",
              handleSelectAllChange
            );

            buruhCheckboxList.addEventListener("change", handleFilterChange);
            selectAllBuruhCheckbox.addEventListener(
              "change",
              handleSelectAllChange
            );
          });

          saveJpgButton.addEventListener("click", function () {
            showLoading(this);
            // const printButtons ... dan if(printButtons)... DIHAPUS

            html2canvas(gajiStrukContainer, {
              scale: 3,
              backgroundColor: "#ffffff",
            })
              .then((canvas) => {
                const link = document.createElement("a");

                const plat = gajiBuruhForm.gajiFormNoPlat.value.replace(
                  /\s/g,
                  ""
                );
                const tglMulai = formatDateForFilename(
                  gajiBuruhForm.gajiFormTanggalMulai.value
                );
                const tglSelesai = formatDateForFilename(
                  gajiBuruhForm.gajiFormTanggalSelesai.value
                );

                link.download = `RG_${plat}_${tglMulai}-${tglSelesai}.jpg`;

                link.href = canvas.toDataURL("image/jpeg", 0.95);
                link.click();

                historyManager.addEntry("rekapGaji", currentStrukData);
              })
              .catch((err) => {
                console.error("Gagal membuat JPG:", err);
                alert("Gagal membuat file JPG.");
              })
              .finally(() => {
                // if(printButtons)... DIHAPUS
                hideLoading(this);
              });
          });

          // Inisialisasi
          setupDynamicCatatan(appContainer, "Gaji", saveDataToLocalStorage);
          gajiBuruhForm.addEventListener("input", saveDataToLocalStorage);
          resetButton.addEventListener("click", resetFormAndStorage);
          loadDataFromLocalStorage();
        })();

        // --- Logika Aplikasi 5: Kalkulator Saro ---
        (function () {
          const appContainer = document.getElementById("kalkulator-saro-app");
          if (!appContainer) return;

          const STORAGE_KEY_SARO = "dataKalkulatorSaro";
          const form = appContainer.querySelector("#kalkulatorSaroForm");
          const rincianContainer = appContainer.querySelector(
            "#rincianBeratContainer"
          );
          const addAmountInput = appContainer.querySelector("#saroAddAmount");
          const tambahBtn = appContainer.querySelector("#addSaroDataBtn");
          const outputSection = appContainer.querySelector(
            "#output-kalkulator-jasa"
          );
          const simpanJpgBtn = appContainer.querySelector("#simpanJpgBtn");
          const strukContainer = appContainer.querySelector(
            "#strukJasaContainer"
          );
          const resetButton = appContainer.querySelector("#resetSaroButton");
          const catatanInput = appContainer.querySelector("#saroCatatanInput");
          let dataCounter = 0;
          let isLoadingSaro = false;
          let currentStrukData = {};

          // --- FUNGSI LOCAL STORAGE ---
          function saveDataToLocalStorageSaro() {
            if (isLoadingSaro) return;
            const beratInputs = Array.from(
              rincianContainer.querySelectorAll('input[name="berat"]')
            ).map((input) => input.value);
            const data = {
              tanggalMulai:
                appContainer.querySelector("#saroTanggalMulai").value,
              tanggalSelesai: appContainer.querySelector("#saroTanggalSelesai")
                .value,
              tarifTimbang:
                appContainer.querySelector("#saroTarifTimbang").value,
              tarifAngkut: appContainer.querySelector("#saroTarifAngkut").value,
              catatan: catatanInput.value,
              beratList: beratInputs,
            };
            localStorage.setItem(STORAGE_KEY_SARO, JSON.stringify(data));
          }

          function loadDataFromLocalStorageSaro() {
            isLoadingSaro = true;
            const savedData = localStorage.getItem(STORAGE_KEY_SARO);
            if (!savedData) {
              appContainer.querySelector("#saroTanggalMulai").value =
                getTodayDateString();
              appContainer.querySelector("#saroTanggalSelesai").value =
                getTodayDateString();
              addBeratInput(true);
              isLoadingSaro = false;
              return;
            }
            const data = JSON.parse(savedData);
            appContainer.querySelector("#saroTanggalMulai").value =
              data.tanggalMulai || getTodayDateString();
            appContainer.querySelector("#saroTanggalSelesai").value =
              data.tanggalSelesai || getTodayDateString();
            appContainer.querySelector("#saroTarifTimbang").value =
              data.tarifTimbang || "100";
            appContainer.querySelector("#saroTarifAngkut").value =
              data.tarifAngkut || "125";
            catatanInput.value = data.catatan || "";

            if (catatanInput.value) {
              appContainer
                .querySelector("#addCatatanBtn_Saro")
                .classList.add("hidden");
              appContainer
                .querySelector("#catatanInputWrapper_Saro")
                .classList.remove("hidden");
            }

            rincianContainer.innerHTML = "";
            dataCounter = 0;

            if (data.beratList && data.beratList.length > 0) {
              data.beratList.forEach((berat) => addBeratInput(false, berat));
            } else {
              addBeratInput(true);
            }
            isLoadingSaro = false;
          }

          // Helper functions
          const formatAngkaSaro = (angka) =>
            new Intl.NumberFormat("id-ID").format(angka);
          const formatDate = (dateStr) => {
            if (!dateStr) return "";
            const [year, month, day] = dateStr.split("-");
            return `${day}/${month}/${year}`;
          };

          // Core functions
          const addBeratInput = (autoFocus = false, value = "") => {
            dataCounter++;
            const div = document.createElement("div");
            div.className = "saro-input-item";
            div.innerHTML = `
                        <label class="saro-counter-label">${dataCounter}.</label>
                        <input type="number" name="berat" placeholder="Berat (Kg)" required class="form-input flex-grow" value="${value}">
                        <button type="button" class="remove-btn text-red-500 hover:text-red-700 p-1 text-xl">&times;</button>
                    `;

            const beratInput = div.querySelector('input[name="berat"]');
            beratInput.addEventListener("input", saveDataToLocalStorageSaro);
            beratInput.addEventListener("keydown", (e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                if (beratInput.value.trim() !== "") addBeratInput(true);
              }
            });

            rincianContainer.appendChild(div);
            div.querySelector(".remove-btn").onclick = () => {
              div.remove();
              updateSaroLabels();
              saveDataToLocalStorageSaro();
            };

            if (autoFocus) beratInput.focus();
            updateSaroLabels();
          };

          const updateSaroLabels = () => {
            const allItems =
              rincianContainer.querySelectorAll(".saro-input-item");
            allItems.forEach((item, index) => {
              item.querySelector("label.saro-counter-label").textContent = `${
                index + 1
              }.`;
            });
            dataCounter = allItems.length;
          };

          const calculateAndDisplayRekap = (e) => {
            e.preventDefault();
            const tanggalMulai =
              appContainer.querySelector("#saroTanggalMulai").value;
            const tanggalSelesai = appContainer.querySelector(
              "#saroTanggalSelesai"
            ).value;
            const tarifTimbang =
              parseFloat(
                appContainer.querySelector("#saroTarifTimbang").value
              ) || 0;
            const tarifAngkut =
              parseFloat(
                appContainer.querySelector("#saroTarifAngkut").value
              ) || 0;
            const beratInputs = rincianContainer.querySelectorAll(
              'input[name="berat"]'
            );
            if (beratInputs.length === 0) {
              alert("Mohon tambahkan setidaknya satu data berat.");
              return;
            }
            let grandTotalBerat = 0;
            beratInputs.forEach((input) => {
              grandTotalBerat += parseFloat(input.value) || 0;
            });
            const hasilTimbang = grandTotalBerat * tarifTimbang;
            const hasilAngkut = grandTotalBerat * tarifAngkut;
            const hasilTotal = hasilTimbang + hasilAngkut;
            appContainer.querySelector(
              "#strukPeriode"
            ).textContent = `${formatDate(tanggalMulai)} - ${formatDate(
              tanggalSelesai
            )}`;
            appContainer.querySelector(
              "#strukTotalMuatan"
            ).textContent = `${beratInputs.length} Faktur`;
            appContainer.querySelector(
              "#strukTotalBerat"
            ).textContent = `${formatAngkaSaro(grandTotalBerat)} Kg`;
            appContainer.querySelector(
              "#strukTarifTimbang"
            ).textContent = `${formatRupiah(tarifTimbang, "")} / Kg`;
            appContainer.querySelector(
              "#strukTarifAngkut"
            ).textContent = `${formatRupiah(tarifAngkut, "")} / Kg`;
            appContainer.querySelector("#strukHasilTimbang").textContent =
              formatRupiah(hasilTimbang);
            appContainer.querySelector("#strukHasilAngkut").textContent =
              formatRupiah(hasilAngkut);
            appContainer.querySelector("#strukHasilTotal").textContent =
              formatRupiah(hasilTotal);

            displayCatatanOnStruk(
              appContainer.querySelector("#saroStrukCatatanSection"),
              catatanInput.value,
              "struk-divider"
            );

            currentStrukData = {
              tanggalMulai: tanggalMulai,
              tanggalSelesai: tanggalSelesai,
              totalMuatan: grandTotalBerat,
              totalSaro: hasilTotal,
            };

            outputSection.classList.remove("hidden");
            outputSection.scrollIntoView({ behavior: "smooth" });
          };

          const resetSaroForm = () => {
            if (
              confirm("Apakah Anda yakin ingin mereset form Kalkulator Saro?")
            ) {
              localStorage.removeItem(STORAGE_KEY_SARO);
              isLoadingSaro = true;
              form.reset();

              appContainer
                .querySelector("#catatanInputWrapper_Saro")
                .classList.add("hidden");
              appContainer
                .querySelector("#addCatatanBtn_Saro")
                .classList.remove("hidden");

              rincianContainer.innerHTML = "";
              dataCounter = 0;
              appContainer.querySelector("#saroTanggalMulai").value =
                getTodayDateString();
              appContainer.querySelector("#saroTanggalSelesai").value =
                getTodayDateString();
              addBeratInput(true);
              outputSection.classList.add("hidden");
              isLoadingSaro = false;
              saveDataToLocalStorageSaro();
            }
          };

          // Event Listeners
          tambahBtn.addEventListener("click", () => {
            const amount = parseInt(addAmountInput.value, 10) || 1;
            for (let i = 0; i < amount; i++) {
              addBeratInput(i === 0);
            }
            addAmountInput.value = "";
            saveDataToLocalStorageSaro();
          });

          form.addEventListener("submit", calculateAndDisplayRekap);
          form.addEventListener("input", saveDataToLocalStorageSaro);
          resetButton.addEventListener("click", resetSaroForm);

          simpanJpgBtn.addEventListener("click", function () {
            showLoading(this);
            html2canvas(strukContainer, { scale: 3 })
              .then((canvas) => {
                const link = document.createElement("a");
                const tglMulai = appContainer
                  .querySelector("#saroTanggalMulai")
                  .value.replace(/-/g, "");
                const tglSelesai = appContainer
                  .querySelector("#saroTanggalSelesai")
                  .value.replace(/-/g, "");
                link.download = `RekapSaro_${tglMulai}-${tglSelesai}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                link.click();

                historyManager.addEntry("kalkulatorSaro", currentStrukData);
              })
              .finally(() => {
                hideLoading(this);
              });
          });

          // Inisialisasi
          setupDynamicCatatan(appContainer, "Saro", saveDataToLocalStorageSaro);
          loadDataFromLocalStorageSaro();
        })();

        // --- Logika Aplikasi 6: Rekap Laporan (DIPERBARUI) ---
        function renderAllHistory() {
          const history = historyManager.getHistory();
          renderCatatanTimbanganHistory(history.catatanTimbangan);
          renderNotaPembayaranHistory(history.notaPembayaran);
          renderRekapMuatanHistory(history.rekapMuatan);
          renderRekapGajiHistory(history.rekapGaji);
          renderKalkulatorSaroHistory(history.kalkulatorSaro);
        }

        function renderCatatanTimbanganHistory(data) {
          const tableBody = document
            .getElementById("historyTableCatatanTimbangan")
            .querySelector("tbody");
          const noHistoryMsg = document.getElementById(
            "noHistoryCatatanTimbangan"
          );
          const tableWrapper = tableBody.closest(".history-table-wrapper");

          tableBody.innerHTML = "";

          if (!data || data.length === 0) {
            noHistoryMsg.classList.remove("hidden");
            tableWrapper.classList.add("hidden");
            return;
          }
          noHistoryMsg.classList.add("hidden");
          tableWrapper.classList.remove("hidden");

          data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

          // --- LOGIKA DETEKSI DUPLIKAT ---
          // Kita anggap duplikat jika Tanggal, No Plat, dan Ritase SAMA PERSIS
          const countMap = {};
          data.forEach((item) => {
            const signature = `${item.tanggal}-${item.noPlat}-${item.ritase}`;
            countMap[signature] = (countMap[signature] || 0) + 1;
          });
          // -------------------------------

          data.forEach((item) => {
            // Cek apakah item ini duplikat
            const signature = `${item.tanggal}-${item.noPlat}-${item.ritase}`;
            const isDuplicate = countMap[signature] > 1;
            const rowClass = isDuplicate ? "duplicate-row" : ""; // Tambahkan kelas CSS jika duplikat

            const ownersHtml = item.owners
              .map(
                (owner) =>
                  `<li>• ${owner.name} (${formatAngka(
                    owner.totalBerat
                  )} Kg)</li>`
              )
              .join("");

            const row = tableBody.insertRow();
            row.className = rowClass; // Terapkan kelas warna

            row.innerHTML = `
            <td>${formatTanggalDariISO(item.timestamp)}</td>
            <td>${formatTanggalInput(item.tanggal)}</td>
            <td>${item.noPlat} (Rit ${item.ritase})</td>
            <td>${formatAngka(item.grandTotalBerat)} Kg</td>
            <td><ul>${ownersHtml}</ul></td>
            <td class="col-center">
                <button onclick="historyManager.deleteEntry('catatanTimbangan', '${
                  item.id
                }')" class="px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
          });
        }

        function renderNotaPembayaranHistory(data) {
          const tableBody = document
            .getElementById("historyTableNotaPembayaran")
            .querySelector("tbody");
          const noHistoryMsg = document.getElementById(
            "noHistoryNotaPembayaran"
          );
          const tableWrapper = tableBody.closest(".history-table-wrapper");

          tableBody.innerHTML = "";
          if (!data || data.length === 0) {
            noHistoryMsg.classList.remove("hidden");
            tableWrapper.classList.add("hidden");
            return;
          }
          noHistoryMsg.classList.add("hidden");
          tableWrapper.classList.remove("hidden");

          data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

          // --- LOGIKA DETEKSI DUPLIKAT ---
          // Kita anggap duplikat jika Tanggal, Owner, dan Total Pembayaran SAMA
          const countMap = {};
          data.forEach((item) => {
            const signature = `${item.tanggal}-${item.owner}-${item.totalPembayaran}`;
            countMap[signature] = (countMap[signature] || 0) + 1;
          });
          // -------------------------------

          data.forEach((item) => {
            const signature = `${item.tanggal}-${item.owner}-${item.totalPembayaran}`;
            const isDuplicate = countMap[signature] > 1;
            const rowClass = isDuplicate ? "duplicate-row" : "";

            const row = tableBody.insertRow();
            row.className = rowClass;

            row.innerHTML = `
            <td>${formatTanggalDariISO(item.timestamp)}</td>
            <td>${formatTanggalInput(item.tanggal)}</td>
            <td>${item.owner} (${formatAngka(item.totalBerat)} Kg)</td>
            <td class="col-right">${formatRupiah(item.totalPembayaran)}</td>
            <td class="col-center">
                <button onclick="historyManager.deleteEntry('notaPembayaran', '${
                  item.id
                }')" class="px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
          });
        }

        function renderRekapMuatanHistory(data) {
          const tableBody = document
            .getElementById("historyTableRekapMuatan")
            .querySelector("tbody");
          const noHistoryMsg = document.getElementById("noHistoryRekapMuatan");
          const tableWrapper = tableBody.closest(".history-table-wrapper");

          tableBody.innerHTML = "";
          if (!data || data.length === 0) {
            noHistoryMsg.classList.remove("hidden");
            tableWrapper.classList.add("hidden");
            return;
          }
          noHistoryMsg.classList.add("hidden");
          tableWrapper.classList.remove("hidden");

          data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

          // --- LOGIKA DETEKSI DUPLIKAT ---
          const countMap = {};
          data.forEach((item) => {
            // Unik berdasarkan: Periode + Plat + Total Berat
            const signature = `${item.tanggalMulai}-${item.tanggalSelesai}-${item.noPlat}-${item.totalMuatan}`;
            countMap[signature] = (countMap[signature] || 0) + 1;
          });

          data.forEach((item) => {
            const signature = `${item.tanggalMulai}-${item.tanggalSelesai}-${item.noPlat}-${item.totalMuatan}`;
            const isDuplicate = countMap[signature] > 1;
            const rowClass = isDuplicate ? "duplicate-row" : "";

            const row = tableBody.insertRow();
            row.className = rowClass;

            row.innerHTML = `
            <td>${formatTanggalDariISO(item.timestamp)}</td>
            <td>${formatTanggalInput(item.tanggalMulai)} - ${formatTanggalInput(
              item.tanggalSelesai
            )}</td>
            <td>${item.noPlat}</td>
            <td class="col-center">${item.totalRitase}</td>
            <td class="col-center">${formatAngka(item.totalMuatan)} Kg</td>
            <td class="col-right">${formatRupiah(item.totalJasa)}</td>
            <td class="col-center">
                <button onclick="historyManager.deleteEntry('rekapMuatan', '${
                  item.id
                }')" class="px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
          });
        }

        function renderRekapGajiHistory(data) {
          const tableBody = document
            .getElementById("historyTableRekapGaji")
            .querySelector("tbody");
          const noHistoryMsg = document.getElementById("noHistoryRekapGaji");
          const tableWrapper = tableBody.closest(".history-table-wrapper");

          tableBody.innerHTML = "";
          if (!data || data.length === 0) {
            noHistoryMsg.classList.remove("hidden");
            tableWrapper.classList.add("hidden");
            return;
          }
          noHistoryMsg.classList.add("hidden");
          tableWrapper.classList.remove("hidden");

          data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

          // --- LOGIKA DETEKSI DUPLIKAT ---
          const countMap = {};
          data.forEach((item) => {
            // Unik berdasarkan: Periode + Plat + Total Gaji
            const signature = `${item.tanggalMulai}-${item.tanggalSelesai}-${item.noPlat}-${item.totalGaji}`;
            countMap[signature] = (countMap[signature] || 0) + 1;
          });

          data.forEach((item) => {
            const signature = `${item.tanggalMulai}-${item.tanggalSelesai}-${item.noPlat}-${item.totalGaji}`;
            const isDuplicate = countMap[signature] > 1;
            const rowClass = isDuplicate ? "duplicate-row" : "";

            const buruhHtml = item.buruhDetails
              .map(
                (buruh) =>
                  `<li>• ${buruh.name} (${formatRupiah(buruh.gaji)})</li>`
              )
              .join("");

            const row = tableBody.insertRow();
            row.className = rowClass;

            row.innerHTML = `
            <td>${formatTanggalDariISO(item.timestamp)}</td>
            <td>${formatTanggalInput(item.tanggalMulai)} - ${formatTanggalInput(
              item.tanggalSelesai
            )}</td>
            <td>${item.noPlat}</td>
            <td class="col-center">${item.totalRitase}</td>
            <td><ul>${buruhHtml}</ul></td>
            <td class="col-right">${formatRupiah(item.totalGaji)}</td>
            <td class="col-center">
                <button onclick="historyManager.deleteEntry('rekapGaji', '${
                  item.id
                }')" class="px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
          });
        }

        function renderKalkulatorSaroHistory(data) {
          const tableBody = document
            .getElementById("historyTableKalkulatorSaro")
            .querySelector("tbody");
          const noHistoryMsg = document.getElementById(
            "noHistoryKalkulatorSaro"
          );
          const tableWrapper = tableBody.closest(".history-table-wrapper");

          tableBody.innerHTML = "";
          if (!data || data.length === 0) {
            noHistoryMsg.classList.remove("hidden");
            tableWrapper.classList.add("hidden");
            return;
          }
          noHistoryMsg.classList.add("hidden");
          tableWrapper.classList.remove("hidden");

          data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

          // --- LOGIKA DETEKSI DUPLIKAT ---
          const countMap = {};
          data.forEach((item) => {
            // Unik berdasarkan: Periode + Total Saro (Rupiah)
            const signature = `${item.tanggalMulai}-${item.tanggalSelesai}-${item.totalSaro}`;
            countMap[signature] = (countMap[signature] || 0) + 1;
          });

          data.forEach((item) => {
            const signature = `${item.tanggalMulai}-${item.tanggalSelesai}-${item.totalSaro}`;
            const isDuplicate = countMap[signature] > 1;
            const rowClass = isDuplicate ? "duplicate-row" : "";

            const row = tableBody.insertRow();
            row.className = rowClass;

            row.innerHTML = `
            <td>${formatTanggalDariISO(item.timestamp)}</td>
            <td>${formatTanggalInput(item.tanggalMulai)} - ${formatTanggalInput(
              item.tanggalSelesai
            )}</td>
            <td class="col-right">${formatAngka(item.totalMuatan)} Kg</td>
            <td class="col-right">${formatRupiah(item.totalSaro)}</td>
            <td class="col-center">
                <button onclick="historyManager.deleteEntry('kalkulatorSaro', '${
                  item.id
                }')" class="px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
          });
        }

        function generateTxtContent(key, data) {
          const now = new Date();
          const printDate =
            now.toLocaleDateString("id-ID", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            }) +
            " " +
            now.toLocaleTimeString("id-ID");
          let content = "";
          let title = "";

          switch (key) {
            case "catatanTimbangan":
              title = "Laporan Riwayat - Catatan Timbangan";
              content += data
                .map((item, i) => {
                  const ownersText = item.owners
                    .map(
                      (o) =>
                        `  - ${o.name} (${formatAngka(o.totalBerat)} Kg) (${
                          o.totalKarung
                        } Karung)`
                    )
                    .join("\n");
                  return `
    ---
    Entri #${i + 1}
    Tanggal Simpan : ${formatTanggalDariISO(item.timestamp)}
    Tanggal Muat   : ${formatTanggalInput(item.tanggal)}
    No. Plat       : ${item.noPlat}
    Total Muatan   : ${formatAngka(item.grandTotalBerat)} Kg / ${
                    item.grandTotalKarung
                  } Karung
    Rincian Owners:\n${ownersText}
    `;
                })
                .join("");
              break;
            case "notaPembayaran":
              title = "Laporan Riwayat - Nota Pembayaran";
              content += data
                .map((item, i) => {
                  let ownerDetails = `${item.owner} (${formatAngka(
                    item.totalBerat
                  )} Kg) (${item.totalKarung} Karung)`; // Format default

                  // Cek jika ada data rincian DAN jika kedua jenis gabah (normal & tidak normal) ada isinya
                  if (
                    item.rincianGabah &&
                    item.rincianGabah.normal.berat > 0 &&
                    item.rincianGabah.tidakNormal.berat > 0
                  ) {
                    ownerDetails = `${item.owner}
      > Normal      : ${formatAngka(item.rincianGabah.normal.berat)} Kg (${
                      item.rincianGabah.normal.karung
                    } Karung)
      > Tdk Normal  : ${formatAngka(item.rincianGabah.tidakNormal.berat)} Kg (${
                      item.rincianGabah.tidakNormal.karung
                    } Karung)
      > Total       : ${formatAngka(item.totalBerat)} Kg (${
                      item.totalKarung
                    } Karung)`;
                  }

                  return `
    ---
    Entri #${i + 1}
    Tanggal Simpan : ${formatTanggalDariISO(item.timestamp)}
    Tanggal Nota   : ${formatTanggalInput(item.tanggal)}
    Nama Owner     : ${ownerDetails}
    Total Bayar    : ${formatRupiah(item.totalPembayaran)}
    `;
                })
                .join("\n");
              break;
            case "rekapMuatan":
              title = "Laporan Riwayat - Rekap Muatan";
              content += data
                .map(
                  (item, i) => `
    ---
    Entri #${i + 1}
    Tanggal Simpan : ${formatTanggalDariISO(item.timestamp)}
    Periode        : ${formatTanggalInput(
      item.tanggalMulai
    )} - ${formatTanggalInput(item.tanggalSelesai)}
    No. Plat       : ${item.noPlat}
    Total Ritase   : ${item.totalRitase}
    Total Muatan   : ${formatAngka(item.totalMuatan)} Kg
    Total Saro     : ${formatRupiah(item.totalJasa)}
    `
                )
                .join("\n");
              break;
            case "rekapGaji":
              title = "Laporan Riwayat - Rekap Gaji";
              content += data
                .map((item, i) => {
                  const buruhText = item.buruhDetails
                    .map((b) => `  - ${b.name} (${formatRupiah(b.gaji)})`)
                    .join("\n");
                  return `
    ---
    Entri #${i + 1}
    Tanggal Simpan : ${formatTanggalDariISO(item.timestamp)}
    Periode        : ${formatTanggalInput(
      item.tanggalMulai
    )} - ${formatTanggalInput(item.tanggalSelesai)}
    No. Plat       : ${item.noPlat}
    Total Rit      : ${item.totalRitase}
    Total Gaji     : ${formatRupiah(item.totalGaji)}
    Rincian Buruh:\n${buruhText}
    `;
                })
                .join("");
              break;
            case "kalkulatorSaro":
              title = "Laporan Riwayat - Kalkulator Saro";
              content += data
                .map(
                  (item, i) => `
    ---
    Entri #${i + 1}
    Tanggal Simpan : ${formatTanggalDariISO(item.timestamp)}
    Periode        : ${formatTanggalInput(
      item.tanggalMulai
    )} - ${formatTanggalInput(item.tanggalSelesai)}
    Total Muatan   : ${formatAngka(item.totalMuatan)} Kg
    Total Saro     : ${formatRupiah(item.totalSaro)}
    `
                )
                .join("\n");
              break;
          }

          const header = `
    =========================================
      ${title.toUpperCase()}
    =========================================
    Dicetak pada: ${printDate}
    `;
          return header + content;
        }

        function exportHistoryToTxt(key) {
          const history = historyManager.getHistory();
          const data = history[key];
          if (!data || data.length === 0) {
            alert("Tidak ada data riwayat untuk diekspor.");
            return;
          }
          data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          const content = generateTxtContent(key, data);

          const blob = new Blob([content], {
            type: "text/plain;charset=utf-8",
          });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `Laporan_${key}_${
            new Date().toISOString().split("T")[0]
          }.txt`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        // Event listeners untuk tombol di modul Rekap Laporan
        document.querySelectorAll(".delete-history-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const key = btn.dataset.historyKey;
            historyManager.deleteHistory(key);
          });
        });

        document.querySelectorAll(".export-txt-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const key = btn.dataset.historyKey;
            exportHistoryToTxt(key);
          });
        });
        // --- Logika untuk Ekspor dan Impor Semua Riwayat (JSON) ---
        const exportBtn = document.getElementById("exportHistoryButton");
        const importBtn = document.getElementById("importHistoryButton");
        const importFile = document.getElementById("importFileInput");

        // Logika Tombol Ekspor
        exportBtn.addEventListener("click", () => {
          const historyData = historyManager.getHistory();
          if (Object.values(historyData).every((arr) => arr.length === 0)) {
            alert("Tidak ada data riwayat untuk diekspor.");
            return;
          }

          const jsonString = JSON.stringify(historyData, null, 2); // Konversi objek ke string JSON
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          const link = document.createElement("a");
          const today = new Date().toISOString().split("T")[0];
          link.href = url;
          link.download = `riwayat_portal_gabah_${today}.json`; // Nama file backup
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        });

        // Logika Tombol Impor
        importBtn.addEventListener("click", () => {
          importFile.click(); // Memicu dialog pilih file
        });

        importFile.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (!file) {
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const fileContent = e.target.result;

            if (
              !confirm(
                "PERINGATAN: Ini akan menimpa SEMUA data riwayat yang ada saat ini dengan data dari file. Apakah Anda yakin ingin melanjutkan?"
              )
            ) {
              event.target.value = null; // Reset input file
              return;
            }

            try {
              const importedHistory = JSON.parse(fileContent);

              // Validasi sederhana untuk memastikan file-nya benar
              const requiredKeys = [
                "catatanTimbangan",
                "notaPembayaran",
                "rekapMuatan",
                "rekapGaji",
                "kalkulatorSaro",
              ];
              const hasRequiredKeys = requiredKeys.every(
                (key) => key in importedHistory
              );

              if (!hasRequiredKeys) {
                throw new Error("File tidak valid atau format tidak sesuai.");
              }

              historyManager.saveHistory(importedHistory); // Simpan data baru
              renderAllHistory(); // Tampilkan ulang semua data di tabel
              alert("Data riwayat berhasil diimpor!");
            } catch (error) {
              alert(
                "Gagal mengimpor file. Pastikan file yang Anda pilih adalah file backup JSON yang benar.\n\nError: " +
                  error.message
              );
            } finally {
              event.target.value = null; // Reset input file agar bisa memilih file yang sama lagi
            }
          };
          reader.readAsText(file);
        });
      });
    </script>
    <script>
      // ===== LOGIKA BARU UNTUK LAYAR LOGIN =====
      (function () {
        // --- Konfigurasi ---
        const sandiBenar = "357357"; // Ganti dengan sandi yang Anda inginkan

        // --- Ambil Elemen-elemen HTML ---
        const loginScreen = document.getElementById("login-screen");
        const appWrapper = document.getElementById("app-wrapper");
        const loginForm = document.getElementById("login-form");
        const passwordInput = document.getElementById("password-input");
        const errorMessage = document.getElementById("error-message");

        // --- Fungsi untuk Cek Login ---
        function attemptLogin() {
          const sandiMasuk = passwordInput.value;

          if (sandiMasuk === sandiBenar) {
            // Jika benar:
            errorMessage.textContent = ""; // Hapus pesan error

            // 1. Tambahkan kelas untuk animasi fade-out
            loginScreen.classList.add("fade-out");

            // 2. Setelah animasi selesai, sembunyikan layar login dan tampilkan aplikasi
            setTimeout(() => {
              loginScreen.style.display = "none";
              appWrapper.classList.remove("hidden");
            }, 500); // 500 milidetik, sesuai durasi transisi CSS
          } else {
            // Jika salah:
            // 1. Tambahkan kelas animasi "gemetar"
            passwordInput.classList.add("shake-error");
            errorMessage.textContent = "Kata sandi salah. Silakan coba lagi.";

            // 2. Hapus input dan kelas animasi setelah selesai
            passwordInput.value = "";
            setTimeout(() => {
              passwordInput.classList.remove("shake-error");
            }, 820); // 820 milidetik, sesuai durasi animasi CSS
          }
        }

        // --- Tambahkan Event Listener ---
        // Jalankan `attemptLogin` saat form di-submit (tombol 'Masuk' diklik atau Enter ditekan)
        loginForm.addEventListener("submit", (event) => {
          event.preventDefault(); // Mencegah halaman refresh
          attemptLogin();
        });
      })();

      // --- LOGIKA TOMBOL HAPUS SEMUA DATA (DENGAN SANDI) ---
      const nukeBtn = document.getElementById("nukeHistoryButton");

      nukeBtn.addEventListener("click", () => {
        // 1. Cek apakah ada data untuk dihapus
        const currentHistory = historyManager.getHistory();
        const isEmpty = Object.values(currentHistory).every(
          (arr) => arr.length === 0
        );

        if (isEmpty) {
          alert("Riwayat sudah kosong.");
          return;
        }

        // 2. Konfirmasi Pertama (Peringatan Biasa)
        const confirm1 = confirm(
          "PERINGATAN BAHAYA!\n\nApakah Anda yakin ingin MENGHAPUS SELURUH RIWAYAT DATA?\n\nTindakan ini akan menghapus semua data:\n- Catatan Timbangan\n- Nota Pembayaran\n- Rekap Muatan\n- Rekap Gaji\n- Kalkulator Saro\n\nData yang dihapus TIDAK BISA KEMBALI."
        );

        if (!confirm1) return;

        // 3. Konfirmasi Kedua (Meminta Kata Sandi)
        const inputSandi = prompt(
          "Untuk keamanan, silakan masukkan KATA SANDI sistem untuk konfirmasi penghapusan:"
        );
        const SANDI_MASTER = "357357"; // Harus sama dengan sandi login

        // 4. Cek Sandi
        if (inputSandi === SANDI_MASTER) {
          // Reset ke keadaan kosong
          const emptyState = {
            catatanTimbangan: [],
            notaPembayaran: [],
            rekapMuatan: [],
            rekapGaji: [],
            kalkulatorSaro: [],
          };

          // Simpan state kosong ke LocalStorage
          historyManager.saveHistory(emptyState);

          // Update tampilan tabel agar kosong
          renderAllHistory();

          alert("SUKSES: Seluruh data riwayat telah dihapus dari sistem.");
        } else {
          // Jika sandi salah atau ditekan Cancel
          if (inputSandi !== null) {
            alert("GAGAL: Kata sandi salah! Penghapusan dibatalkan.");
          }
        }
      });
    </script>
  </body>
</html>
